<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Base Class for Torch Module Constructor Wrappers — mlr_pipeops_torch • mlr3torch</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.9/font.css" rel="stylesheet"><link href="../deps/JetBrains_Mono-0.4.9/font.css" rel="stylesheet"><link href="../deps/Roboto_Slab-0.4.9/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Base Class for Torch Module Constructor Wrappers — mlr_pipeops_torch"><meta name="description" content="PipeOpTorch is the base class for all PipeOps that represent
neural network layers in a Graph.
During training, it generates a PipeOpModule that wraps an nn_module and attaches it
to the architecture, which is also represented as a Graph consisting mostly of PipeOpModules
an PipeOpNOPs.
While the former Graph operates on ModelDescriptors, the latter operates on tensors.
The relationship between a PipeOpTorch and a PipeOpModule is similar to the
relationshop between a nn_module_generator (like nn_linear) and a
nn_module (like the output of nn_linear(...)).
A crucial difference is that the PipeOpTorch infers auxiliary parameters (like in_features for
nn_linear) automatically from the intermediate tensor shapes that are being communicated through the
ModelDescriptor.
During prediction, PipeOpTorch takes in a Task in each channel and outputs the same new
Task resulting from their feature union in each channel.
If there is only one input and output channel, the task is simply piped through."><meta property="og:description" content="PipeOpTorch is the base class for all PipeOps that represent
neural network layers in a Graph.
During training, it generates a PipeOpModule that wraps an nn_module and attaches it
to the architecture, which is also represented as a Graph consisting mostly of PipeOpModules
an PipeOpNOPs.
While the former Graph operates on ModelDescriptors, the latter operates on tensors.
The relationship between a PipeOpTorch and a PipeOpModule is similar to the
relationshop between a nn_module_generator (like nn_linear) and a
nn_module (like the output of nn_linear(...)).
A crucial difference is that the PipeOpTorch infers auxiliary parameters (like in_features for
nn_linear) automatically from the intermediate tensor shapes that are being communicated through the
ModelDescriptor.
During prediction, PipeOpTorch takes in a Task in each channel and outputs the same new
Task resulting from their feature union in each channel.
If there is only one input and output channel, the task is simply piped through."><meta property="og:image" content="https://mlr3torch.mlr-org.com/logo.svg"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mlr3torch</a>

    <small class="nav-text text-default me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fa-file-alt"></span> Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/callbacks.html">Custom Callbacks</a></li>
    <li><a class="dropdown-item" href="../articles/get_started.html">Get Started</a></li>
    <li><a class="dropdown-item" href="../articles/internals_pipeop_torch.html">Internals</a></li>
    <li><a class="dropdown-item" href="../articles/lazy_tensor.html">Lazy Tensor</a></li>
    <li><a class="dropdown-item" href="../articles/pipeop_torch.html">Defining an Architecture</a></li>
  </ul></li>
<li class="nav-item"><a class="external-link nav-link" href="https://mlr3book.mlr-org.com"><span class="fa fa-link"></span> mlr3book</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><a class="external-link nav-link" href="https://github.com/mlr-org/mlr3torch"><span class="fa fa-github"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://lmmisld-lmu-stats-slds.srv.mwn.de/mlr_invite/"><span class="fa fa-comments"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://stackoverflow.com/questions/tagged/mlr3"><span class="fa fab fa-stack-overflow"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://mlr-org.com/"><span class="fa fa-rss"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Base Class for Torch Module Constructor Wrappers</h1>
      <small class="dont-index">Source: <a href="https://github.com/mlr-org/mlr3torch/blob/main/R/PipeOpTorch.R" class="external-link"><code>R/PipeOpTorch.R</code></a></small>
      <div class="d-none name"><code>mlr_pipeops_torch.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><code>PipeOpTorch</code> is the base class for all <code><a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html" class="external-link">PipeOp</a></code>s that represent
neural network layers in a <code><a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html" class="external-link">Graph</a></code>.
During <strong>training</strong>, it generates a <code><a href="mlr_pipeops_module.html">PipeOpModule</a></code> that wraps an <code><a href="https://rdrr.io/pkg/torch/man/nn_module.html" class="external-link">nn_module</a></code> and attaches it
to the architecture, which is also represented as a <code><a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html" class="external-link">Graph</a></code> consisting mostly of <code><a href="mlr_pipeops_module.html">PipeOpModule</a></code>s
an <code><a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_nop.html" class="external-link">PipeOpNOP</a></code>s.</p>
<p>While the former <code><a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html" class="external-link">Graph</a></code> operates on <code><a href="ModelDescriptor.html">ModelDescriptor</a></code>s, the latter operates on <a href="https://rdrr.io/pkg/torch/man/torch_tensor.html" class="external-link">tensors</a>.</p>
<p>The relationship between a <code>PipeOpTorch</code> and a <code><a href="mlr_pipeops_module.html">PipeOpModule</a></code> is similar to the
relationshop between a <code>nn_module_generator</code> (like <code><a href="https://rdrr.io/pkg/torch/man/nn_linear.html" class="external-link">nn_linear</a></code>) and a
<code><a href="https://rdrr.io/pkg/torch/man/nn_module.html" class="external-link">nn_module</a></code> (like the output of <code>nn_linear(...)</code>).
A crucial difference is that the <code>PipeOpTorch</code> infers auxiliary parameters (like <code>in_features</code> for
<code>nn_linear</code>) automatically from the intermediate tensor shapes that are being communicated through the
<code><a href="ModelDescriptor.html">ModelDescriptor</a></code>.</p>
<p>During <strong>prediction</strong>, <code>PipeOpTorch</code> takes in a <code><a href="https://mlr3.mlr-org.com/reference/Task.html" class="external-link">Task</a></code> in each channel and outputs the same new
<code><a href="https://mlr3.mlr-org.com/reference/Task.html" class="external-link">Task</a></code> resulting from their <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_featureunion.html" class="external-link">feature union</a> in each channel.
If there is only one input and output channel, the task is simply piped through.</p>
    </div>


    <div class="section level2">
    <h2 id="inheriting">Inheriting<a class="anchor" aria-label="anchor" href="#inheriting"></a></h2>


<p>When inheriting from this class, one should overload either the <code>private$.shapes_out()</code> and the
<code>private$.shape_dependent_params()</code> methods, or overload <code>private$.make_module()</code>.</p><ul><li><p><code>.make_module(shapes_in, param_vals, task)</code><br>
(<code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code>, <code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code>) -&gt; <code>nn_module</code><br>
This private method is called to generated the <code>nn_module</code> that is passed as argument <code>module</code> to
<code><a href="mlr_pipeops_module.html">PipeOpModule</a></code>. It must be overwritten, when no <code>module_generator</code> is provided.
If left as is, it calls the provided <code>module_generator</code> with the arguments obtained by
the private method <code>.shape_dependent_params()</code>.</p></li>
<li><p><code>.shapes_out(shapes_in, param_vals, task)</code><br>
(<code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code>, <code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code>, <code><a href="https://mlr3.mlr-org.com/reference/Task.html" class="external-link">Task</a></code> or <code>NULL</code>) -&gt; named <code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code><br>
This private method gets a list of <code>numeric</code> vectors (<code>shapes_in</code>), the parameter values (<code>param_vals</code>),
as well as an (optional) <code><a href="https://mlr3.mlr-org.com/reference/Task.html" class="external-link">Task</a></code>.
The <code>shapes_in</code> can be assumed to be in the same order as the input names of the <code>PipeOp</code>.
The output shapes must be in the same order as the output names of the <code>PipeOp</code>.
In case the output shapes depends on the task (as is the case for <code><a href="mlr_pipeops_nn_head.html">PipeOpTorchHead</a></code>), the function should return
valid output shapes (possibly containing <code>NA</code>s) if the <code>task</code> argument is provided or not.</p></li>
<li><p><code>.shape_dependent_params(shapes_in, param_vals, task)</code><br>
(<code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code>, <code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code>) -&gt; named <code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code><br>
This private method has the same inputs as <code>.shapes_out</code>.
If <code>.make_module()</code> is not overwritten, it constructs the arguments passed to <code>module_generator</code>.
Usually this means that it must infer the auxiliary parameters that can be inferred from the input shapes
and add it to the user-supplied parameter values (<code>param_vals</code>).</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="input-and-output-channels">Input and Output Channels<a class="anchor" aria-label="anchor" href="#input-and-output-channels"></a></h2>


<p>During <em>training</em>, all inputs and outputs are of class <code><a href="ModelDescriptor.html">ModelDescriptor</a></code>.
During <em>prediction</em>, all input and output channels are of class <code><a href="https://mlr3.mlr-org.com/reference/Task.html" class="external-link">Task</a></code>.</p>
    </div>
    <div class="section level2">
    <h2 id="state">State<a class="anchor" aria-label="anchor" href="#state"></a></h2>


<p>The state is the value calculated by the public method <code>shapes_out()</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="parameters">Parameters<a class="anchor" aria-label="anchor" href="#parameters"></a></h2>


<p>The <code><a href="https://paradox.mlr-org.com/reference/ParamSet.html" class="external-link">ParamSet</a></code> is specified by the child class inheriting from <code>PipeOpTorch</code>.
Usually the parameters are the arguments of the wrapped <code><a href="https://rdrr.io/pkg/torch/man/nn_module.html" class="external-link">nn_module</a></code> minus the auxiliary parameter that can
be automatically inferred from the shapes of the input tensors.</p>
    </div>
    <div class="section level2">
    <h2 id="internals">Internals<a class="anchor" aria-label="anchor" href="#internals"></a></h2>


<p>During training, the <code>PipeOpTorch</code> creates a <code><a href="mlr_pipeops_module.html">PipeOpModule</a></code> for the given parameter specification and the
input shapes from the incoming <code><a href="ModelDescriptor.html">ModelDescriptor</a></code>s using the private method <code>.make_module()</code>.
The input shapes are provided by the slot <code>pointer_shape</code> of the incoming <code><a href="ModelDescriptor.html">ModelDescriptor</a></code>s.
The channel names of this <code><a href="mlr_pipeops_module.html">PipeOpModule</a></code> are identical to the channel names of the generating <code>PipeOpTorch</code>.</p>
<p>A <a href="model_descriptor_union.html">model descriptor union</a> of all incoming <code><a href="ModelDescriptor.html">ModelDescriptor</a></code>s is then created.
Note that this modifies the <code><a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html" class="external-link">graph</a></code> of the first <code><a href="ModelDescriptor.html">ModelDescriptor</a></code> <strong>in place</strong> for efficiency.
The <code><a href="mlr_pipeops_module.html">PipeOpModule</a></code> is added to the <code><a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html" class="external-link">graph</a></code> slot of this union and the the edges that connect the
sending <code>PipeOpModule</code>s to the input channel of this <code>PipeOpModule</code> are addeded to the graph.
This is possible because every incoming <code><a href="ModelDescriptor.html">ModelDescriptor</a></code> contains the information about the
<code>id</code> and the <code>channel</code> name of the sending <code>PipeOp</code> in the slot <code>pointer</code>.</p>
<p>The new graph in the <code><a href="model_descriptor_union.html">model_descriptor_union</a></code> represents the current state of the neural network
architecture. It is structurally similar to the subgraph that consists of all pipeops of class <code>PipeOpTorch</code> and
<code><a href="mlr_pipeops_torch_ingress.html">PipeOpTorchIngress</a></code> that are ancestors of this <code>PipeOpTorch</code>.</p>
<p>For the output, a shallow copy of the <code><a href="ModelDescriptor.html">ModelDescriptor</a></code> is created and the <code>pointer</code> and
<code>pointer_shape</code> are updated accordingly. The shallow copy means that all <code><a href="ModelDescriptor.html">ModelDescriptor</a></code>s point to the same
<code><a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html" class="external-link">Graph</a></code> which allows the graph to be modified by-reference in different parts of the code.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>Other Graph Network:
<code><a href="ModelDescriptor.html">ModelDescriptor</a>()</code>,
<code><a href="TorchIngressToken.html">TorchIngressToken</a>()</code>,
<code><a href="mlr_learners_torch_model.html">mlr_learners_torch_model</a></code>,
<code><a href="mlr_pipeops_module.html">mlr_pipeops_module</a></code>,
<code><a href="mlr_pipeops_torch_ingress.html">mlr_pipeops_torch_ingress</a></code>,
<code><a href="mlr_pipeops_torch_ingress_categ.html">mlr_pipeops_torch_ingress_categ</a></code>,
<code><a href="mlr_pipeops_torch_ingress_ltnsr.html">mlr_pipeops_torch_ingress_ltnsr</a></code>,
<code><a href="mlr_pipeops_torch_ingress_num.html">mlr_pipeops_torch_ingress_num</a></code>,
<code><a href="model_descriptor_to_learner.html">model_descriptor_to_learner</a>()</code>,
<code><a href="model_descriptor_to_module.html">model_descriptor_to_module</a>()</code>,
<code><a href="model_descriptor_union.html">model_descriptor_union</a>()</code>,
<code><a href="nn_graph.html">nn_graph</a>()</code></p></div>
    </div>
    <div class="section level2">
    <h2 id="super-class">Super class<a class="anchor" aria-label="anchor" href="#super-class"></a></h2>
    <p><code><a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html" class="external-link">mlr3pipelines::PipeOp</a></code> -&gt; <code>PipeOpTorch</code></p>
    </div>
    <div class="section level2">
    <h2 id="public-fields">Public fields<a class="anchor" aria-label="anchor" href="#public-fields"></a></h2>
    <p></p><div class="r6-fields"><dl><dt><code>module_generator</code></dt>
<dd><p>(<code>nn_module_generator</code> or <code>NULL</code>)<br>
The module generator wrapped by this <code>PipeOpTorch</code>. If <code>NULL</code>, the private method
<code>private$.make_module(shapes_in, param_vals)</code> must be overwritte, see section 'Inheriting'.
Do not change this after construction.</p></dd>


</dl><p></p></div>
    </div>
    <div class="section level2">
    <h2 id="methods">Methods<a class="anchor" aria-label="anchor" href="#methods"></a></h2>

<div class="section">
<h3 id="public-methods">Public methods<a class="anchor" aria-label="anchor" href="#public-methods"></a></h3>

<ul><li><p><a href="#method-PipeOpTorch-new"><code>PipeOpTorch$new()</code></a></p></li>
<li><p><a href="#method-PipeOpTorch-shapes_out"><code>PipeOpTorch$shapes_out()</code></a></p></li>
</ul></div><p><details open><summary>Inherited methods</summary><ul><li><span class="pkg-link" data-pkg="mlr3pipelines" data-topic="PipeOp" data-id="help"><a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html#method-help"><code>mlr3pipelines::PipeOp$help()</code></a></span></li>
<li><span class="pkg-link" data-pkg="mlr3pipelines" data-topic="PipeOp" data-id="predict"><a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html#method-predict"><code>mlr3pipelines::PipeOp$predict()</code></a></span></li>
<li><span class="pkg-link" data-pkg="mlr3pipelines" data-topic="PipeOp" data-id="print"><a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html#method-print"><code>mlr3pipelines::PipeOp$print()</code></a></span></li>
<li><span class="pkg-link" data-pkg="mlr3pipelines" data-topic="PipeOp" data-id="train"><a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html#method-train"><code>mlr3pipelines::PipeOp$train()</code></a></span></li>
</ul></details></p><hr><a id="method-PipeOpTorch-new"></a><div class="section">
<h3 id="method-new-">Method <code>new()</code><a class="anchor" aria-label="anchor" href="#method-new-"></a></h3>
<p>Creates a new instance of this <a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6</a> class.</p><div class="section">
<h4 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a></h4>
<p></p><div class="r"><div class="sourceCode"><pre><code><span><span class="va"><a href="../reference/mlr_pipeops_torch.html">PipeOpTorch</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  <span class="va">id</span>,</span>
<span>  <span class="va">module_generator</span>,</span>
<span>  param_set <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/ps.html" class="external-link">ps</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  param_vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  inname <span class="op">=</span> <span class="st">"input"</span>,</span>
<span>  outname <span class="op">=</span> <span class="st">"output"</span>,</span>
<span>  packages <span class="op">=</span> <span class="st">"torch"</span>,</span>
<span>  tags <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div><p></p></div>
</div>

<div class="section">
<h4 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h4>
<p></p><div class="arguments"><dl><dt><code>id</code></dt>
<dd><p>(<code>character(1)</code>)<br>
Identifier of the resulting  object.</p></dd>


<dt><code>module_generator</code></dt>
<dd><p>(<code>nn_module_generator</code>)<br>
The torch module generator.</p></dd>


<dt><code>param_set</code></dt>
<dd><p>(<code><a href="https://paradox.mlr-org.com/reference/ParamSet.html" class="external-link">ParamSet</a></code>)<br>
The parameter set.</p></dd>


<dt><code>param_vals</code></dt>
<dd><p>(<code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code>)<br>
List of hyperparameter settings, overwriting the hyperparameter settings that would
otherwise be set during construction.</p></dd>


<dt><code>inname</code></dt>
<dd><p>(<code><a href="https://rdrr.io/r/base/character.html" class="external-link">character()</a></code>)<br>
The names of the <code><a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html" class="external-link">PipeOp</a></code>'s input channels. These will be the input channels of the generated <code><a href="mlr_pipeops_module.html">PipeOpModule</a></code>.
Unless the wrapped <code>module_generator</code>'s forward method (if present) has the argument <code>...</code>, <code>inname</code> must be
identical to those argument names in order to avoid any ambiguity.<br>
If the forward method has the argument <code>...</code>, the order of the input channels determines how the tensors
will be passed to the wrapped <code>nn_module</code>.<br>
If left as <code>NULL</code> (default), the argument <code>module_generator</code> must be given and the argument names of the
<code>modue_generator</code>'s forward function are set as <code>inname</code>.</p></dd>


<dt><code>outname</code></dt>
<dd><p>(<code><a href="https://rdrr.io/r/base/character.html" class="external-link">character()</a></code>) <br>
The names of the output channels channels. These will be the ouput channels of the generated <code><a href="mlr_pipeops_module.html">PipeOpModule</a></code>
and therefore also the names of the list returned by its <code>$train()</code>.
In case there is more than one output channel, the <code>nn_module</code> that is constructed by this
<code><a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html" class="external-link">PipeOp</a></code> during training must return a named <code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code>, where the names of the list are the
names out the output channels. The default is <code>"output"</code>.</p></dd>


<dt><code>packages</code></dt>
<dd><p>(<code><a href="https://rdrr.io/r/base/character.html" class="external-link">character()</a></code>)<br>
The R packages this object depends on.</p></dd>


<dt><code>tags</code></dt>
<dd><p>(<code><a href="https://rdrr.io/r/base/character.html" class="external-link">character()</a></code>)<br>
The tags of the <code><a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html" class="external-link">PipeOp</a></code>. The tags <code>"torch"</code> is always added.</p></dd>


</dl><p></p></div>
</div>

</div><p></p><hr><a id="method-PipeOpTorch-shapes_out"></a><div class="section">
<h3 id="method-shapes-out-">Method <code>shapes_out()</code><a class="anchor" aria-label="anchor" href="#method-shapes-out-"></a></h3>
<p>Calculates the output shapes for the given input shapes, parameters and task.</p><div class="section">
<h4 id="usage-1">Usage<a class="anchor" aria-label="anchor" href="#usage-1"></a></h4>
<p></p><div class="r"><div class="sourceCode"><pre><code><span><span class="va">PipeOpTorch</span><span class="op">$</span><span class="fu">shapes_out</span><span class="op">(</span><span class="va">shapes_in</span>, task <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div><p></p></div>
</div>

<div class="section">
<h4 id="arguments-1">Arguments<a class="anchor" aria-label="anchor" href="#arguments-1"></a></h4>
<p></p><div class="arguments"><dl><dt><code>shapes_in</code></dt>
<dd><p>(<code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code> of <code><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer()</a></code>)<br>
The input input shapes, which must be in the same order as the input channel names of the <code>PipeOp</code>.</p></dd>


<dt><code>task</code></dt>
<dd><p>(<code><a href="https://mlr3.mlr-org.com/reference/Task.html" class="external-link">Task</a></code> or <code>NULL</code>)<br>
The task, which is very rarely used (default is <code>NULL</code>). An exception is <code><a href="mlr_pipeops_nn_head.html">PipeOpTorchHead</a></code>.</p></dd>


</dl><p></p></div>
</div>
<div class="section">
<h4 id="returns">Returns<a class="anchor" aria-label="anchor" href="#returns"></a></h4>
<p>A named <code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code> containing the output shapes. The names are the names of the output channels of
the <code>PipeOp</code>.</p>
</div>

</div>

    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">## Creating a neural network</span></span></span>
<span class="r-in"><span><span class="co"># In torch</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">tsk</a></span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">network_generator</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_module.html" class="external-link">nn_module</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span>, <span class="va">d_hidden</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="va">d_in</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="va">feature_names</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="va">self</span><span class="op">$</span><span class="va">linear</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="va">d_in</span>, <span class="va">d_hidden</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="va">self</span><span class="op">$</span><span class="va">output</span> <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="va">task_type</span> <span class="op">==</span> <span class="st">"regr"</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="va">d_hidden</span>, <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="va">task_type</span> <span class="op">==</span> <span class="st">"classif"</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="va">d_hidden</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="va">class_names</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="op">}</span></span></span>
<span class="r-in"><span>  <span class="op">}</span>,</span></span>
<span class="r-in"><span>  forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="va">x</span> <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="fu">linear</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="va">x</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/nnf_relu.html" class="external-link">nnf_relu</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="va">self</span><span class="op">$</span><span class="fu">output</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">network</span> <span class="op">=</span> <span class="fu">network_generator</span><span class="op">(</span><span class="va">task</span>, d_hidden <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">x</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html" class="external-link">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="fl">1</span>, <span class="va">task</span><span class="op">$</span><span class="va">feature_names</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">y</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/with_no_grad.html" class="external-link">with_no_grad</a></span><span class="op">(</span><span class="fu">network</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># In mlr3torch</span></span></span>
<span class="r-in"><span><span class="va">network_generator</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_head"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">md</span> <span class="op">=</span> <span class="va">network_generator</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">network</span> <span class="op">=</span> <span class="fu"><a href="model_descriptor_to_module.html">model_descriptor_to_module</a></span><span class="op">(</span><span class="va">md</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">y</span> <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/with_no_grad.html" class="external-link">with_no_grad</a></span><span class="op">(</span><span class="fu">network</span><span class="op">(</span>torch_ingress_num.input <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Implementing a custom PipeOpTorch</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># defining a custom module</span></span></span>
<span class="r-in"><span><span class="va">nn_custom</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_module.html" class="external-link">nn_module</a></span><span class="op">(</span><span class="st">"nn_custom"</span>,</span></span>
<span class="r-in"><span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">d_in1</span>, <span class="va">d_in2</span>, <span class="va">d_out1</span>, <span class="va">d_out2</span>, <span class="va">bias</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="va">self</span><span class="op">$</span><span class="va">linear1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="va">d_in1</span>, <span class="va">d_out1</span>, <span class="va">bias</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="va">self</span><span class="op">$</span><span class="va">linear2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="va">d_in2</span>, <span class="va">d_out2</span>, <span class="va">bias</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span>,</span></span>
<span class="r-in"><span>  forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">input1</span>, <span class="va">input2</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="va">output1</span> <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="fu">linear1</span><span class="op">(</span><span class="va">input1</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="va">output2</span> <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="fu">linear1</span><span class="op">(</span><span class="va">input2</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>output1 <span class="op">=</span> <span class="va">output1</span>, output2 <span class="op">=</span> <span class="va">output2</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># wrapping the module into a custom PipeOpTorch</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://paradox.mlr-org.com" class="external-link">paradox</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">PipeOpTorchCustom</span> <span class="op">=</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span><span class="st">"PipeOpTorchCustom"</span>,</span></span>
<span class="r-in"><span>  inherit <span class="op">=</span> <span class="va">PipeOpTorch</span>,</span></span>
<span class="r-in"><span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span> <span class="op">=</span> <span class="st">"nn_custom"</span>, <span class="va">param_vals</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="va">param_set</span> <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/ps.html" class="external-link">ps</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>        d_out1 <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html" class="external-link">p_int</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">1</span>, tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"required"</span>, <span class="st">"train"</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>        d_out2 <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html" class="external-link">p_int</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">1</span>, tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"required"</span>, <span class="st">"train"</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>        bias <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html" class="external-link">p_lgl</a></span><span class="op">(</span>default <span class="op">=</span> <span class="cn">TRUE</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span></span></span>
<span class="r-in"><span>      <span class="op">)</span></span></span>
<span class="r-in"><span>      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span></span></span>
<span class="r-in"><span>        id <span class="op">=</span> <span class="va">id</span>,</span></span>
<span class="r-in"><span>        param_vals <span class="op">=</span> <span class="va">param_vals</span>,</span></span>
<span class="r-in"><span>        param_set <span class="op">=</span> <span class="va">param_set</span>,</span></span>
<span class="r-in"><span>        inname <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"input1"</span>, <span class="st">"input2"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>        outname <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"output1"</span>, <span class="st">"output2"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>        module_generator <span class="op">=</span> <span class="va">nn_custom</span></span></span>
<span class="r-in"><span>      <span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="op">}</span></span></span>
<span class="r-in"><span>  <span class="op">)</span>,</span></span>
<span class="r-in"><span>  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    .shape_dependent_params <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">shapes_in</span>, <span class="va">param_vals</span>, <span class="va">task</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">param_vals</span>,</span></span>
<span class="r-in"><span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>d_in1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">shapes_in</span><span class="op">[[</span><span class="st">"input1"</span><span class="op">]</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, d_in2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">shapes_in</span><span class="op">[[</span><span class="st">"input2"</span><span class="op">]</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span>      <span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="op">}</span>,</span></span>
<span class="r-in"><span>    .shapes_out <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">shapes_in</span>, <span class="va">param_vals</span>, <span class="va">task</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>        input1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">shapes_in</span><span class="op">[[</span><span class="st">"input1"</span><span class="op">]</span><span class="op">]</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="va">param_vals</span><span class="op">$</span><span class="va">d_out1</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>        input2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">shapes_in</span><span class="op">[[</span><span class="st">"input2"</span><span class="op">]</span><span class="op">]</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="va">param_vals</span><span class="op">$</span><span class="va">d_out2</span><span class="op">)</span></span></span>
<span class="r-in"><span>      <span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="op">}</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Training</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># generate input</span></span></span>
<span class="r-in"><span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">tsk</a></span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">task1</span> <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Sepal."</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Length"</span>, <span class="st">"Width"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">task2</span> <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Petal."</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Length"</span>, <span class="st">"Width"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">graph</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/gunion.html" class="external-link">gunion</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num_1"</span><span class="op">)</span>, <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num_2"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">mds_in</span> <span class="op">=</span> <span class="va">graph</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">task1</span>, <span class="va">task2</span><span class="op">)</span>, single_input <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">mds_in</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"graph"</span>, <span class="st">"task"</span>, <span class="st">"ingress"</span>, <span class="st">"pointer"</span>, <span class="st">"pointer_shape"</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $graph</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Graph with 1 PipeOps:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   ID         State sccssors prdcssors</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>               &lt;char&gt;        &lt;char&gt;   &lt;char&gt;    &lt;char&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  torch_ingress_num_1 &lt;&lt;UNTRAINED&gt;&gt;                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $task</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;TaskClassif:iris&gt; (150 x 3): Iris Flowers</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> * Target: Species</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> * Properties: multiclass</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> * Features (2):</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   - dbl (2): Sepal.Length, Sepal.Width</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $ingress</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $ingress$torch_ingress_num_1.input</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Ingress: Task[Sepal.Length,Sepal.Width] --&gt; Tensor(NA, 2)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $pointer</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "torch_ingress_num_1" "output"             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $pointer_shape</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] NA  2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span><span class="va">mds_in</span><span class="op">[[</span><span class="fl">2L</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"graph"</span>, <span class="st">"task"</span>, <span class="st">"ingress"</span>, <span class="st">"pointer"</span>, <span class="st">"pointer_shape"</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $graph</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Graph with 1 PipeOps:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   ID         State sccssors prdcssors</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>               &lt;char&gt;        &lt;char&gt;   &lt;char&gt;    &lt;char&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  torch_ingress_num_2 &lt;&lt;UNTRAINED&gt;&gt;                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $task</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;TaskClassif:iris&gt; (150 x 3): Iris Flowers</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> * Target: Species</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> * Properties: multiclass</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> * Features (2):</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   - dbl (2): Petal.Length, Petal.Width</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $ingress</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $ingress$torch_ingress_num_2.input</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Ingress: Task[Petal.Length,Petal.Width] --&gt; Tensor(NA, 2)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $pointer</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "torch_ingress_num_2" "output"             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $pointer_shape</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] NA  2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># creating the PipeOpTorch and training it</span></span></span>
<span class="r-in"><span><span class="va">po_torch</span> <span class="op">=</span> <span class="va">PipeOpTorchCustom</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">po_torch</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>d_out1 <span class="op">=</span> <span class="fl">10</span>, d_out2 <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">train_input</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>input1 <span class="op">=</span> <span class="va">mds_in</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span>, input2 <span class="op">=</span> <span class="va">mds_in</span><span class="op">[[</span><span class="fl">2L</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">mds_out</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">po_torch</span><span class="op">$</span><span class="va">train</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>input <span class="op">=</span> <span class="va">train_input</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">po_torch</span><span class="op">$</span><span class="va">state</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $output1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] NA 10</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $output2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] NA 20</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># the new model descriptors</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># the resulting graphs are identical</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">mds_out</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">graph</span>, <span class="va">mds_out</span><span class="op">[[</span><span class="fl">2L</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">graph</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE</span>
<span class="r-in"><span><span class="co"># not that as a side-effect, also one of the input graphs is modified in-place for efficiency</span></span></span>
<span class="r-in"><span><span class="va">mds_in</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">edges</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 src_id src_channel    dst_id dst_channel</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 &lt;char&gt;      &lt;char&gt;    &lt;char&gt;      &lt;char&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1: torch_ingress_num_1      output nn_custom      input1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2: torch_ingress_num_2      output nn_custom      input2</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The new task has both Sepal and Petal features</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">mds_out</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">task</span>, <span class="va">mds_out</span><span class="op">[[</span><span class="fl">2L</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">task</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE</span>
<span class="r-in"><span><span class="va">mds_out</span><span class="op">[[</span><span class="fl">2L</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">task</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;TaskClassif:iris&gt; (150 x 5): Iris Flowers</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> * Target: Species</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> * Properties: multiclass</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> * Features (4):</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   - dbl (4): Petal.Length, Petal.Width, Sepal.Length, Sepal.Width</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The new ingress slot contains all ingressors</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">mds_out</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ingress</span>, <span class="va">mds_out</span><span class="op">[[</span><span class="fl">2L</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ingress</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE</span>
<span class="r-in"><span><span class="va">mds_out</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ingress</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $torch_ingress_num_1.input</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Ingress: Task[Sepal.Length,Sepal.Width] --&gt; Tensor(NA, 2)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $torch_ingress_num_2.input</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Ingress: Task[Petal.Length,Petal.Width] --&gt; Tensor(NA, 2)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The pointer and pointer_shape slots are different</span></span></span>
<span class="r-in"><span><span class="va">mds_out</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pointer</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "nn_custom" "output1"  </span>
<span class="r-in"><span><span class="va">mds_out</span><span class="op">[[</span><span class="fl">2L</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pointer</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "nn_custom" "output2"  </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">mds_out</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pointer_shape</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] NA 10</span>
<span class="r-in"><span><span class="va">mds_out</span><span class="op">[[</span><span class="fl">2L</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pointer_shape</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] NA 20</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Prediction</span></span></span>
<span class="r-in"><span><span class="va">predict_input</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>input1 <span class="op">=</span> <span class="va">task1</span>, input2 <span class="op">=</span> <span class="va">task2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">tasks_out</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">po_torch</span><span class="op">$</span><span class="va">predict</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>input <span class="op">=</span> <span class="va">predict_input</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">tasks_out</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span>, <span class="va">tasks_out</span><span class="op">[[</span><span class="fl">2L</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE</span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sebastian Fischer, Martin Binder.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer></div>





  </body></html>

