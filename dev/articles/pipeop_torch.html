<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Defining an Architecture • mlr3torch</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Roboto_Slab-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Defining an Architecture">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mlr3torch</a>

    <small class="nav-text text-default me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.3.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fa-file-alt"></span> Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Tutorials</h6></li>
    <li><a class="dropdown-item" href="../articles/get_started.html">Get Started</a></li>
    <li><a class="dropdown-item" href="../articles/pipeop_torch.html">Defining an Architecture</a></li>
    <li><a class="dropdown-item" href="../articles/callbacks.html">Callbacks</a></li>
    <li><a class="dropdown-item" href="../articles/lazy_tensor.html">Non-Tabular Data</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Internals</h6></li>
    <li><a class="dropdown-item" href="../articles/internals_pipeop_torch.html">Networks as Graphs</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-overview" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Overview</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-overview">
<li><a class="dropdown-item" href="../articles/task_list.html">Tasks</a></li>
    <li><a class="dropdown-item" href="../articles/preprocessing_list.html">Preprocessing &amp; Augmentation</a></li>
    <li><a class="dropdown-item" href="../articles/optimizer_list.html">Optimizers</a></li>
    <li><a class="dropdown-item" href="../articles/loss_list.html">Losses</a></li>
    <li><a class="dropdown-item" href="../articles/callback_list.html">Callbacks</a></li>
    <li><a class="dropdown-item" href="../articles/learner_list.html">Learners</a></li>
    <li><a class="dropdown-item" href="../articles/layer_list.html">Network Layers</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="https://mlr3book.mlr-org.com"><span class="fa fa-link"></span> mlr3book</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mlr-org/mlr3torch"><span class="fa fa-github"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://lmmisld-lmu-stats-slds.srv.mwn.de/mlr_invite/"><span class="fa fa-comments"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://stackoverflow.com/questions/tagged/mlr3"><span class="fa fab fa-stack-overflow"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://mlr-org.com/"><span class="fa fa-rss"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="pipeop_torch_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="pipeop_torch_files/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="pipeop_torch_files/vis-9.1.0/vis-network.min.js"></script><script src="pipeop_torch_files/visNetwork-binding-2.1.2/visNetwork.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Defining an Architecture</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mlr-org/mlr3torch/blob/main/vignettes/articles/pipeop_torch.Rmd" class="external-link"><code>vignettes/articles/pipeop_torch.Rmd</code></a></small>
      <div class="d-none name"><code>pipeop_torch.Rmd</code></div>
    </div>

    
    
<p>In this vignette, we will show how to build neural network
architectures as <code>mlr3pipelines::Graphs</code>s. We will create a
simple CNN for the tiny-imagenet task, which is a subset of well-known
Imagenet benchmark.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3torch.mlr-org.com/">mlr3torch</a></span><span class="op">)</span></span>
<span><span class="va">imagenet</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">tsk</a></span><span class="op">(</span><span class="st">"tiny_imagenet"</span><span class="op">)</span></span>
<span><span class="va">imagenet</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="color: #0000BB; font-weight: bold;">&lt;TaskClassif&gt;</span><span style="font-weight: bold;"> (110000x2): ImageNet Subset</span> <span style="color: #00BBBB;">───────────────────────────────────</span></span></span>
<span><span class="co">#&gt; • Target: class</span></span>
<span><span class="co">#&gt; • Target classes: abacus (0%), academic gown, academic robe, judge's robe (0%),</span></span>
<span><span class="co">#&gt; acorn (0%), African elephant, Loxodonta africana (0%), albatross, mollymawk</span></span>
<span><span class="co">#&gt; (0%), alp (0%), altar (0%), American alligator, Alligator mississipiensis (0%),</span></span>
<span><span class="co">#&gt; American lobster, Northern lobster, Maine lobster, Homarus americanus (0%),</span></span>
<span><span class="co">#&gt; apron (0%), Arabian camel, dromedary, Camelus dromedarius (0%), baboon (0%),</span></span>
<span><span class="co">#&gt; backpack, back pack, knapsack, packsack, rucksack, haversack (0%), banana (0%),</span></span>
<span><span class="co">#&gt; bannister, banister, balustrade, balusters, handrail (0%), barbershop (0%),</span></span>
<span><span class="co">#&gt; barn (0%), barrel, cask (0%), basketball (0%), bathtub, bathing tub, bath, tub</span></span>
<span><span class="co">#&gt; (0%), beach wagon, station wagon, wagon, estate car, beach waggon, station</span></span>
<span><span class="co">#&gt; waggon, waggon (0%), beacon, lighthouse, beacon light, pharos (0%), beaker</span></span>
<span><span class="co">#&gt; (0%), bee (0%), beer bottle (0%), bell pepper (0%), bighorn, bighorn sheep,</span></span>
<span><span class="co">#&gt; cimarron, Rocky Mountain bighorn, Rocky Mountain sheep, Ovis canadensis (0%),</span></span>
<span><span class="co">#&gt; bikini, two-piece (0%), binoculars, field glasses, opera glasses (0%),</span></span>
<span><span class="co">#&gt; birdhouse (0%), bison (0%), black stork, Ciconia nigra (0%), black widow,</span></span>
<span><span class="co">#&gt; Latrodectus mactans (0%), boa constrictor, Constrictor constrictor (0%), bow</span></span>
<span><span class="co">#&gt; tie, bow-tie, bowtie (0%), brain coral (0%), brass, memorial tablet, plaque</span></span>
<span><span class="co">#&gt; (0%), broom (0%), brown bear, bruin, Ursus arctos (0%), bucket, pail (0%),</span></span>
<span><span class="co">#&gt; bullet train, bullet (0%), bullfrog, Rana catesbeiana (0%), butcher shop, meat</span></span>
<span><span class="co">#&gt; market (0%), candle, taper, wax light (0%), cannon (0%), cardigan (0%), cash</span></span>
<span><span class="co">#&gt; machine, cash dispenser, automated teller machine, automatic teller machine,</span></span>
<span><span class="co">#&gt; automated teller, automatic teller, ATM (0%), cauliflower (0%), CD player (0%),</span></span>
<span><span class="co">#&gt; centipede (0%), chain (0%), chest (0%), Chihuahua (0%), chimpanzee, chimp, Pan</span></span>
<span><span class="co">#&gt; troglodytes (0%), Christmas stocking (0%), cliff dwelling (0%), cliff, drop,</span></span>
<span><span class="co">#&gt; drop-off (0%), cockroach, roach (0%), comic book (0%), computer keyboard,</span></span>
<span><span class="co">#&gt; keypad (0%), confectionery, confectionary, candy store (0%), convertible (0%),</span></span>
<span><span class="co">#&gt; coral reef (0%), cougar, puma, catamount, mountain lion, painter, panther,</span></span>
<span><span class="co">#&gt; Felis concolor (0%), crane (0%), dam, dike, dyke (0%), desk (0%), dining table,</span></span>
<span><span class="co">#&gt; board (0%), dragonfly, darning needle, devil's darning needle, sewing needle,</span></span>
<span><span class="co">#&gt; snake feeder, snake doctor, mosquito hawk, skeeter hawk (0%), drumstick (0%),</span></span>
<span><span class="co">#&gt; dugong, Dugong dugon (0%), dumbbell (0%), Egyptian cat (0%), espresso (0%),</span></span>
<span><span class="co">#&gt; European fire salamander, Salamandra salamandra (0%), flagpole, flagstaff (0%),</span></span>
<span><span class="co">#&gt; fly (0%), fountain (0%), freight car (0%), frying pan, frypan, skillet (0%),</span></span>
<span><span class="co">#&gt; fur coat (0%), gasmask, respirator, gas helmet (0%), gazelle (0%), German</span></span>
<span><span class="co">#&gt; shepherd, German shepherd dog, German police dog, alsatian (0%), go-kart (0%),</span></span>
<span><span class="co">#&gt; golden retriever (0%), goldfish, Carassius auratus (0%), gondola (0%), goose</span></span>
<span><span class="co">#&gt; (0%), grasshopper, hopper (0%), guacamole (0%), guinea pig, Cavia cobaya (0%),</span></span>
<span><span class="co">#&gt; hog, pig, grunter, squealer, Sus scrofa (0%), hourglass (0%), ice cream,</span></span>
<span><span class="co">#&gt; icecream (0%), ice lolly, lolly, lollipop, popsicle (0%), iPod (0%), jellyfish</span></span>
<span><span class="co">#&gt; (0%), jinrikisha, ricksha, rickshaw (0%), kimono (0%), king penguin,</span></span>
<span><span class="co">#&gt; Aptenodytes patagonica (0%), koala, koala bear, kangaroo bear, native bear,</span></span>
<span><span class="co">#&gt; Phascolarctos cinereus (0%), Labrador retriever (0%), ladybug, ladybeetle, lady</span></span>
<span><span class="co">#&gt; beetle, ladybird, ladybird beetle (0%), lakeside, lakeshore (0%), lampshade,</span></span>
<span><span class="co">#&gt; lamp shade (0%), lawn mower, mower (0%), lemon (0%), lesser panda, red panda,</span></span>
<span><span class="co">#&gt; panda, bear cat, cat bear, Ailurus fulgens (0%), lifeboat (0%), limousine, limo</span></span>
<span><span class="co">#&gt; (0%), lion, king of beasts, Panthera leo (0%), magnetic compass (0%), mantis,</span></span>
<span><span class="co">#&gt; mantid (0%), mashed potato (0%), maypole (0%), meat loaf, meatloaf (0%),</span></span>
<span><span class="co">#&gt; military uniform (0%), miniskirt, mini (0%), monarch, monarch butterfly,</span></span>
<span><span class="co">#&gt; milkweed butterfly, Danaus plexippus (0%), moving van (0%), mushroom (0%), nail</span></span>
<span><span class="co">#&gt; (0%), neck brace (0%), obelisk (0%), oboe, hautboy, hautbois (0%), orange (0%),</span></span>
<span><span class="co">#&gt; orangutan, orang, orangutang, Pongo pygmaeus (0%), organ, pipe organ (0%), ox</span></span>
<span><span class="co">#&gt; (0%), parking meter (0%), pay-phone, pay-station (0%), Persian cat (0%), picket</span></span>
<span><span class="co">#&gt; fence, paling (0%), pill bottle (0%), pizza, pizza pie (0%), plate (0%),</span></span>
<span><span class="co">#&gt; plunger, plumber's helper (0%), pole (0%), police van, police wagon, paddy</span></span>
<span><span class="co">#&gt; wagon, patrol wagon, wagon, black Maria (0%), pomegranate (0%), poncho (0%),</span></span>
<span><span class="co">#&gt; pop bottle, soda bottle (0%), potpie (0%), potter's wheel (0%), pretzel (0%),</span></span>
<span><span class="co">#&gt; projectile, missile (0%), punching bag, punch bag, punching ball, punchball</span></span>
<span><span class="co">#&gt; (0%), reel (0%), refrigerator, icebox (0%), remote control, remote (0%),</span></span>
<span><span class="co">#&gt; rocking chair, rocker (0%), rugby ball (0%), sandal (0%), school bus (0%),</span></span>
<span><span class="co">#&gt; scoreboard (0%), scorpion (0%), sea cucumber, holothurian (0%), sea slug,</span></span>
<span><span class="co">#&gt; nudibranch (0%), seashore, coast, seacoast, sea-coast (0%), sewing machine</span></span>
<span><span class="co">#&gt; (0%), slug (0%), snail (0%), snorkel (0%), sock (0%), sombrero (0%), space</span></span>
<span><span class="co">#&gt; heater (0%), spider web, spider's web (0%), spiny lobster, langouste, rock</span></span>
<span><span class="co">#&gt; lobster, crawfish, crayfish, sea crawfish (0%), sports car, sport car (0%),</span></span>
<span><span class="co">#&gt; standard poodle (0%), steel arch bridge (0%), stopwatch, stop watch (0%),</span></span>
<span><span class="co">#&gt; sulphur butterfly, sulfur butterfly (0%), sunglasses, dark glasses, shades</span></span>
<span><span class="co">#&gt; (0%), suspension bridge (0%), swimming trunks, bathing trunks (0%), syringe</span></span>
<span><span class="co">#&gt; (0%), tabby, tabby cat (0%), tailed frog, bell toad, ribbed toad, tailed toad,</span></span>
<span><span class="co">#&gt; Ascaphus trui (0%), tarantula (0%), teapot (0%), teddy, teddy bear (0%),</span></span>
<span><span class="co">#&gt; thatch, thatched roof (0%), torch (0%), tractor (0%), trilobite (0%), triumphal</span></span>
<span><span class="co">#&gt; arch (0%), trolleybus, trolley coach, trackless trolley (0%), turnstile (0%),</span></span>
<span><span class="co">#&gt; umbrella (0%), vestment (0%), viaduct (0%), volleyball (0%), walking stick,</span></span>
<span><span class="co">#&gt; walkingstick, stick insect (0%), water jug (0%), water tower (0%), wok (0%),</span></span>
<span><span class="co">#&gt; wooden spoon (0%), Yorkshire terrier (0%)</span></span>
<span><span class="co">#&gt; • Properties: multiclass</span></span>
<span><span class="co">#&gt; • Features (1):</span></span>
<span><span class="co">#&gt;   • lt (1): image</span></span></code></pre></div>
<p>The central ingredients for creating such graphs are
<code>PipeOpTorch</code> operators.</p>
<p>To mark the entry-point of the neural network, we use a
<code>PipeOpTorchIngress</code>, for which three different flavors
exist:</p>
<ul>
<li>
<code>po("torch_ingress_num")</code> for numeric data</li>
<li>
<code>po("torch_ingress_categ")</code> for categorical columns</li>
<li>
<code>po("torch_ingress_ltnsr")</code> for
<code>lazy_tensor</code>s</li>
</ul>
<p>Because the imagenet task contains only one feature of type
<code>lazy_tensor</code>, we go for the last option:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">architecture</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_ltnsr"</span><span class="op">)</span></span></code></pre></div>
<p>We now define a relatively simple convolutional neural network. Note
that in the code below <code>po("nn_relu_1")</code> is equivalent to
<code>po("nn_relu", id = "nn_linear_1")</code>. This is needed, because
<code><a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html" class="external-link">mlr3pipelines::Graph</a></code>s require that each <code>PipeOp</code>
has a unique ID.</p>
<p>What we can further notice is that we don’t have to specify the input
dimension for the convolutional layers, which are inferred from the task
during <code>$train()</code>ing. This means that our
<code>Learner</code> can be applied to tasks with different image sizes,
each time building up the correct network structure.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">architecture</span> <span class="op">=</span> <span class="va">architecture</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_conv2d_1"</span>, out_channels <span class="op">=</span> <span class="fl">64</span>, kernel_size <span class="op">=</span> <span class="fl">11</span>, stride <span class="op">=</span> <span class="fl">4</span>, padding <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_relu_1"</span>, inplace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_max_pool2d_1"</span>, kernel_size <span class="op">=</span> <span class="fl">3</span>, stride <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_conv2d_2"</span>, out_channels <span class="op">=</span> <span class="fl">192</span>, kernel_size <span class="op">=</span> <span class="fl">5</span>, padding <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_relu_2"</span>, inplace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_max_pool2d_2"</span>, kernel_size <span class="op">=</span> <span class="fl">3</span>, stride <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>We can now continue with specifying the classification part of the
network, which is a dense network that repeats a layer twice:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dense_layer</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_dropout"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">4096</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_relu_6"</span><span class="op">)</span></span></code></pre></div>
<p>In order to repeat a segment from a network multiple times, we can
use <code>po("nn_block")</code>, which we here repeat twice. Then, we
follow with the output head of the network, where we don’t have to
specify the number of classes, as they can also be inferred from the
task</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">classifier</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_block"</span>, <span class="va">dense_layer</span>, n_blocks <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_head"</span><span class="op">)</span></span></code></pre></div>
<p>Next, we can combine the convolutional part with the dense head:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">architecture</span> <span class="op">=</span> <span class="va">architecture</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_flatten"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="va">classifier</span></span></code></pre></div>
<p>Below, we display the network:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">architecture</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>html <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-ac96cb3ee4656e2e9ec3" style="width:50%;height:400px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-ac96cb3ee4656e2e9ec3">{"x":{"nodes":{"id":["torch_ingress_ltnsr","nn_conv2d_1","nn_relu_1","nn_max_pool2d_1","nn_conv2d_2","nn_relu_2","nn_max_pool2d_2","nn_block","nn_flatten","<INPUT>","nn_head","<OUTPUT>"],"label":["torch_ingress_ltnsr","nn_conv2d_1","nn_relu_1","nn_max_pool2d_1","nn_conv2d_2","nn_relu_2","nn_max_pool2d_2","nn_block","nn_flatten","<INPUT>","nn_head","<OUTPUT>"],"shape":["box","box","box","box","box","box","box","box","box","database","box","ellipse"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","rgba(0,204,102,0.2)","lightblue","rgba(255,51,51,0.2)"],"value":[1,1,1,1,1,1,1,1,1,0.8,1,0.8],"title":["<p>PipeOp: <b>torch_ingress_ltnsr<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>nn_conv2d_1<\/b> (not trained)<br>values: <b>out_channels=64, kernel_size=11, stride=4, padding=2<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>nn_relu_1<\/b> (not trained)<br>values: <b>inplace=TRUE<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>nn_max_pool2d_1<\/b> (not trained)<br>values: <b>kernel_size=3, stride=2<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>nn_conv2d_2<\/b> (not trained)<br>values: <b>out_channels=192, kernel_size=5, padding=2<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>nn_relu_2<\/b> (not trained)<br>values: <b>inplace=TRUE<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>nn_max_pool2d_2<\/b> (not trained)<br>values: <b>kernel_size=3, stride=2<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>nn_block<\/b> (not trained)<br>values: <b>n_blocks=2, nn_linear.out_features=4096<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  nn_dropout.input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  nn_relu_6.output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>nn_flatten<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>Input:<br>Name: torch_ingress_ltnsr.input<br>Train: Task<br>Predict: Task<\/p>","<p>PipeOp: <b>nn_head<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>Output:<br>Name: nn_head.output<br>Train: ModelDescriptor<br>Predict: Task<\/p>"],"x":[0,0,0,0,0,0,0,0,0,0,0,0],"y":[-0.8181818181818181,-0.6363636363636364,-0.4545454545454546,-0.2727272727272727,-0.09090909090909094,0.09090909090909083,0.2727272727272727,0.6363636363636365,0.4545454545454546,-1,0.8181818181818181,1]},"edges":{"from":["torch_ingress_ltnsr","nn_conv2d_1","nn_relu_1","nn_max_pool2d_1","nn_conv2d_2","nn_relu_2","nn_max_pool2d_2","nn_block","nn_flatten","<INPUT>","nn_head"],"to":["nn_conv2d_1","nn_relu_1","nn_max_pool2d_1","nn_conv2d_2","nn_relu_2","nn_max_pool2d_2","nn_flatten","nn_head","nn_block","torch_ingress_ltnsr","<OUTPUT>"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"arrows":"to","smooth":{"enabled":false,"forceDirection":"vertical"}},"physics":{"stabilization":false}},"groups":null,"width":"50%","height":"400px","idselection":{"enabled":false},"byselection":{"enabled":false},"main":null,"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","igraphlayout":{"type":"full"}},"evals":[],"jsHooks":[]}</script><p>To turn this network architecture into an <code><a href="https://mlr3.mlr-org.com/reference/Learner.html" class="external-link">mlr3::Learner</a></code>
what is left to do is to configure the loss, optimizer, callbacks, and
training arguments, which we do now: We use the standard cross-entropy
loss, SGD as the optimizer and checkpoint our model every 20 epochs.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">checkpoint</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">architecture</span> <span class="op">=</span> <span class="va">architecture</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_loss"</span>, <span class="fu"><a href="../reference/t_loss.html">t_loss</a></span><span class="op">(</span><span class="st">"cross_entropy"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_optimizer"</span>, <span class="fu"><a href="../reference/t_opt.html">t_opt</a></span><span class="op">(</span><span class="st">"sgd"</span>, lr<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_callbacks"</span>, </span>
<span>    <span class="fu"><a href="../reference/t_clbk.html">t_clbk</a></span><span class="op">(</span><span class="st">"checkpoint"</span>, freq <span class="op">=</span> <span class="fl">20</span>, path <span class="op">=</span> <span class="va">checkpoint</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_model_classif"</span>,</span>
<span>    batch_size <span class="op">=</span> <span class="fl">32</span>, epochs <span class="op">=</span> <span class="fl">100L</span>, device <span class="op">=</span> <span class="st">"cuda"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cnn</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html" class="external-link">as_learner</a></span><span class="op">(</span><span class="va">architecture</span><span class="op">)</span></span>
<span><span class="va">cnn</span><span class="op">$</span><span class="va">id</span> <span class="op">=</span> <span class="st">"cnn"</span></span></code></pre></div>
<p>This created <code>Learner</code> now exposes all configuration
options of the individual <code>PipeOp</code>s in its
<code>$param_set</code>, from which we show only a subset for
readability:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">cnn</span><span class="op">$</span><span class="va">param_set</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">32</span>, <span class="fl">34</span>, <span class="fl">42</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span>
<span><span class="co">#&gt;                       id    class lower upper</span></span>
<span><span class="co">#&gt;                   &lt;char&gt;   &lt;char&gt; &lt;num&gt; &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:     nn_block.n_blocks ParamInt     0   Inf</span></span>
<span><span class="co">#&gt; 2: nn_block.nn_dropout.p ParamDbl     0     1</span></span>
<span><span class="co">#&gt; 3:  torch_loss.reduction ParamFct    NA    NA</span></span></code></pre></div>
<p>We can still change them, or if we wanted to, even tune them! Below,
we increase the number of blocks and latent dimension of the dense part,
as well as change the learning rate of the SGD optimizer.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cnn</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="fu">set_values</span><span class="op">(</span></span>
<span>  nn_block.n_blocks <span class="op">=</span> <span class="fl">4L</span>,</span>
<span>  nn_block.nn_linear.out_features <span class="op">=</span> <span class="fl">4096</span> <span class="op">*</span> <span class="fl">2</span>,</span>
<span>  torch_optimizer.lr <span class="op">=</span> <span class="fl">0.2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Finally, we train the learner on the task:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cnn</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">imagenet</span><span class="op">)</span></span></code></pre></div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sebastian Fischer, Martin Binder.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
