<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Internals • mlr3torch</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Roboto_Slab-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Internals">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mlr3torch</a>

    <small class="nav-text text-default me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.3.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fa-file-alt"></span> Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Tutorials</h6></li>
    <li><a class="dropdown-item" href="../articles/get_started.html">Get Started</a></li>
    <li><a class="dropdown-item" href="../articles/pipeop_torch.html">Defining an Architecture</a></li>
    <li><a class="dropdown-item" href="../articles/callbacks.html">Callbacks</a></li>
    <li><a class="dropdown-item" href="../articles/lazy_tensor.html">Non-Tabular Data</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Internals</h6></li>
    <li><a class="dropdown-item" href="../articles/internals_pipeop_torch.html">Networks as Graphs</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-overview" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Overview</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-overview">
<li><a class="dropdown-item" href="../articles/task_list.html">Tasks</a></li>
    <li><a class="dropdown-item" href="../articles/preprocessing_list.html">Preprocessing &amp; Augmentation</a></li>
    <li><a class="dropdown-item" href="../articles/optimizer_list.html">Optimizers</a></li>
    <li><a class="dropdown-item" href="../articles/loss_list.html">Losses</a></li>
    <li><a class="dropdown-item" href="../articles/callback_list.html">Callbacks</a></li>
    <li><a class="dropdown-item" href="../articles/learner_list.html">Learners</a></li>
    <li><a class="dropdown-item" href="../articles/layer_list.html">Network Layers</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="https://mlr3book.mlr-org.com"><span class="fa fa-link"></span> mlr3book</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mlr-org/mlr3torch"><span class="fa fa-github"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://lmmisld-lmu-stats-slds.srv.mwn.de/mlr_invite/"><span class="fa fa-comments"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://stackoverflow.com/questions/tagged/mlr3"><span class="fa fab fa-stack-overflow"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://mlr-org.com/"><span class="fa fa-rss"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="internals_pipeop_torch_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="internals_pipeop_torch_files/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="internals_pipeop_torch_files/vis-9.1.0/vis-network.min.js"></script><script src="internals_pipeop_torch_files/visNetwork-binding-2.1.2/visNetwork.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Internals</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mlr-org/mlr3torch/blob/main/vignettes/articles/internals_pipeop_torch.Rmd" class="external-link"><code>vignettes/articles/internals_pipeop_torch.Rmd</code></a></small>
      <div class="d-none name"><code>internals_pipeop_torch.Rmd</code></div>
    </div>

    
    
<p>This vignette contains technical details about the inner workings of
representing neural networks as <code><a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html" class="external-link">mlr3pipelines::Graph</a></code>s. If
you are not familiar with <code>mlr3pipelines</code>, start by reading
the <a href="https://mlr3book.mlr-org.com/chapters/chapter7/sequential_pipelines.html" class="external-link">related
sections from the mlr3 book</a> first.</p>
<div class="section level2">
<h2 id="a-torch-primer">A <code>torch</code> Primer<a class="anchor" aria-label="anchor" href="#a-torch-primer"></a>
</h2>
<p>We start by sampling some input tensor: 2 batches with 3
features:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input</span> <span class="op">=</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">input</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -1.8520 -0.5971  2.1272</span></span>
<span><span class="co">#&gt; -0.0564  0.5666  0.0558</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,3} ]</span></span></code></pre></div>
<p>A <code>nn_module</code> is constructed from a
<code>nn_module_generator</code>. <code>nn_linear</code> is one of the
simpler generators:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">module_1</span> <span class="op">=</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">3</span>, out_features <span class="op">=</span> <span class="fl">4</span>, bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Applying this module gives a 2-batch of 4 units:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span> <span class="op">=</span> <span class="fu">module_1</span><span class="op">(</span><span class="va">input</span><span class="op">)</span></span>
<span><span class="va">output</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -0.2433 -1.0929 -2.5212 -1.4694</span></span>
<span><span class="co">#&gt; -0.4630 -0.2973 -0.6413 -0.7689</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,4} ][ grad_fn = &lt;AddmmBackward0&gt; ]</span></span></code></pre></div>
<p>A neural network with one (4-unit) hidden layer and two outputs needs
the following ingredients</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">activation</span> <span class="op">=</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_sigmoid.html" class="external-link">nn_sigmoid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">module_2</span> <span class="op">=</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">3</span>, bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">softmax</span> <span class="op">=</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_softmax.html" class="external-link">nn_softmax</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>We can pipe a tensor through the layers as follows.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span> <span class="op">=</span> <span class="fu">module_1</span><span class="op">(</span><span class="va">input</span><span class="op">)</span></span>
<span><span class="va">output</span> <span class="op">=</span> <span class="fu">activation</span><span class="op">(</span><span class="va">output</span><span class="op">)</span></span>
<span><span class="va">output</span> <span class="op">=</span> <span class="fu">module_2</span><span class="op">(</span><span class="va">output</span><span class="op">)</span></span>
<span><span class="va">output</span> <span class="op">=</span> <span class="fu">softmax</span><span class="op">(</span><span class="va">output</span><span class="op">)</span></span>
<span><span class="va">output</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  0.2600  0.3019  0.4381</span></span>
<span><span class="co">#&gt;  0.2538  0.3026  0.4436</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,3} ][ grad_fn = &lt;SoftmaxBackward0&gt; ]</span></span></code></pre></div>
<p>We will now continue with showing how such a neural network can be
represented in <code>mlr3torch</code>.</p>
</div>
<div class="section level2">
<h2 id="neural-networks-as-graphs">Neural Networks as Graphs<a class="anchor" aria-label="anchor" href="#neural-networks-as-graphs"></a>
</h2>
<p>In <code>mlr3torch</code>, <code>nn_module</code>s are wrapped in a
<code>PipeOpModule</code>. This has the advantage that the network
structure can be represented as an <code><a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html" class="external-link">mlr3pipelines::Graph</a></code>
object where it is made explicit (can be plotted, can be extended or
manipulated), compared to e.g. writing a function that pipes input
through a series of modules.</p>
<p>A <code>PipeOpModule</code> can be used to wrap a module directly,
but it is usually constructed by a <code>PipeOpTorch</code> (see later).
It typically has a single input and a single output, although multiple
inputs are possible (module is then called with multiple arguments), and
multiple outputs are possible when the module-function returns a list.
The input and output channels must be explicitly declared then during
construction. We will now continue to recreate the above network using
<code>PipeOpModule</code>s.</p>
<p>We can wrap the linear <code>module_1</code> layers like this:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3torch.mlr-org.com/">mlr3torch</a></span><span class="op">)</span></span>
<span><span class="va">po_module_1</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"module_1"</span>, module <span class="op">=</span> <span class="va">module_1</span><span class="op">)</span></span></code></pre></div>
<p>Note that <code>po("module_1")</code> is equivalent to
<code>po("module", id = "module_1")</code>. This mechanism is convenient
to avoid ID clashes in graphs that contain the same <code>PipeOp</code>
multiple times.</p>
<p>We can use the generated <code>PipeOp</code> in the familiar way:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span> <span class="op">=</span> <span class="va">po_module_1</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">input</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">output</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -0.2433 -1.0929 -2.5212 -1.4694</span></span>
<span><span class="co">#&gt; -0.4630 -0.2973 -0.6413 -0.7689</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,4} ][ grad_fn = &lt;AddmmBackward0&gt; ]</span></span></code></pre></div>
<p>Note we only use the <code>$train()</code>, since torch modules do
not have anything that maps to the <code>state</code> (it is filled by
an empty list).</p>
<p>The single hidden layer neural network can be constructed as a
<code>Graph</code>, which can then do the training all at once.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">po_activation</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"module"</span>, id <span class="op">=</span> <span class="st">"activation"</span>, <span class="va">activation</span><span class="op">)</span></span>
<span><span class="va">po_module_2</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"module_2"</span>, module <span class="op">=</span> <span class="va">module_2</span><span class="op">)</span></span>
<span><span class="va">po_softmax</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"module"</span>, id <span class="op">=</span> <span class="st">"softmax"</span>, module <span class="op">=</span> <span class="va">softmax</span><span class="op">)</span></span>
<span></span>
<span><span class="va">module_graph</span> <span class="op">=</span> <span class="va">po_module_1</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="va">po_activation</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="va">po_module_2</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="va">po_softmax</span></span>
<span></span>
<span><span class="va">module_graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>html <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-ac96cb3ee4656e2e9ec3" style="width:50%;height:400px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-ac96cb3ee4656e2e9ec3">{"x":{"nodes":{"id":["module_1","activation","module_2","<INPUT>","softmax","<OUTPUT>"],"label":["module_1","activation","module_2","<INPUT>","softmax","<OUTPUT>"],"shape":["box","box","box","database","box","ellipse"],"color":["lightblue","lightblue","lightblue","rgba(0,204,102,0.2)","lightblue","rgba(255,51,51,0.2)"],"value":[1,1,1,0.8,1,0.8],"title":["<p>PipeOp: <b>module_1<\/b> (trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>PipeOp: <b>activation<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>PipeOp: <b>module_2<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>Input:<br>Name: module_1.input<br>Train: torch_tensor<br>Predict: NULL<\/p>","<p>PipeOp: <b>softmax<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>Output:<br>Name: softmax.output<br>Train: torch_tensor<br>Predict: NULL<\/p>"],"x":[0,0,0,0,0,0],"y":[-0.6,-0.2,0.2,-1,0.6000000000000001,1]},"edges":{"from":["module_1","activation","module_2","<INPUT>","softmax"],"to":["activation","module_2","softmax","module_1","<OUTPUT>"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"arrows":"to","smooth":{"enabled":false,"forceDirection":"vertical"}},"physics":{"stabilization":false}},"groups":null,"width":"50%","height":"400px","idselection":{"enabled":false},"byselection":{"enabled":false},"main":null,"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","igraphlayout":{"type":"full"}},"evals":[],"jsHooks":[]}</script><p>We can now use the graph’s <code>$train()</code> method to pipe a
tensor through the whole <code>Graph</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span> <span class="op">=</span> <span class="va">module_graph</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">input</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">output</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  0.2600  0.3019  0.4381</span></span>
<span><span class="co">#&gt;  0.2538  0.3026  0.4436</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,3} ][ grad_fn = &lt;SoftmaxBackward0&gt; ]</span></span></code></pre></div>
<p>While this object allows to easily perform a forward pass, it does
not inherit from <code>nn_module</code>, which is useful for various
reasons. Instead of having a class that inherits both from
<code>nn_module</code> and <code>Graph</code> (which does not work in
R6, since multiple inheritance is not available), there is a class that
inherits from <code>nn_module</code> and contains a <code>Graph</code>
member slot through composition. This class is <code>nn_graph</code>. It
is constructed with a <code>Graph</code>, as well as information about
the shape(s) of the <code>torch_tensor</code>(s) it expects as
inputs.</p>
<p>Shape info is communicated as an integer-valued <code>numeric</code>
vector; dimensions that are arbitrary, e.g. batch-size, is given as
<code>NA</code>. Our network expects an input of shape
<code>c(NA, 3)</code>, since the first layer was created as
<code>nn_linear(in_features = 3, ...)</code>.</p>
<p>If the <code>Graph</code> has multiple outputs, it is also possible
to select a subset of outputs to use, or change the output order, by
giving the <code>output_map</code> argument.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># the name of the single input is:</span></span>
<span><span class="va">module_graph</span><span class="op">$</span><span class="va">input</span></span>
<span><span class="co">#&gt;              name        train predict    op.id channel.name</span></span>
<span><span class="co">#&gt;            &lt;char&gt;       &lt;char&gt;  &lt;char&gt;   &lt;char&gt;       &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: module_1.input torch_tensor    NULL module_1        input</span></span>
<span></span>
<span><span class="va">graph_module</span> <span class="op">=</span> <span class="fu"><a href="../reference/nn_graph.html">nn_graph</a></span><span class="op">(</span></span>
<span>  <span class="va">module_graph</span>,</span>
<span>  shapes_in <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>module_1.input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This module gives us the convenience of torch <code>nn_module</code>
objects, e.g.:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph_module</span><span class="op">$</span><span class="va">children</span></span>
<span><span class="co">#&gt; $module_list</span></span>
<span><span class="co">#&gt; An `nn_module` containing 31 parameters.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Modules ─────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • 0: &lt;nn_linear&gt; #16 parameters</span></span>
<span><span class="co">#&gt; • 1: &lt;nn_sigmoid&gt; #0 parameters</span></span>
<span><span class="co">#&gt; • 2: &lt;nn_linear&gt; #15 parameters</span></span>
<span><span class="co">#&gt; • 3: &lt;nn_softmax&gt; #0 parameters</span></span></code></pre></div>
<p>And it can be used to transform tensors just as any other
<code><a href="https://torch.mlverse.org/docs/reference/nn_module.html" class="external-link">torch::nn_module</a></code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">graph_module</span><span class="op">(</span><span class="va">input</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  0.2600  0.3019  0.4381</span></span>
<span><span class="co">#&gt;  0.2538  0.3026  0.4436</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,3} ][ grad_fn = &lt;SoftmaxBackward0&gt; ]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="building-torch-models-for-tasks-using-pipeoptorch">Building Torch Models for Tasks using <code>PipeOpTorch</code><a class="anchor" aria-label="anchor" href="#building-torch-models-for-tasks-using-pipeoptorch"></a>
</h2>
<div class="section level3">
<h3 id="modeldescriptor">
<code>ModelDescriptor</code><a class="anchor" aria-label="anchor" href="#modeldescriptor"></a>
</h3>
<p>The <code>PipeOpModule</code> represents an <code>nn_module</code>
that is fixed for a specific tensor shape and which has no
hyperparameters. When constructing a neural network using these
operators, one has to take care to have the output shape of operations
match the input shapes of the following operations.</p>
<p>A complete <code>Graph</code> of matching <code>PipeOpModule</code>s
can be constructed using operators that mostly inherit from
<code>PipeOpTorch</code>, making use of the <code>ModelDescriptor</code>
class. The <code>ModelDescriptor</code> class contains a
<code>Graph</code> of (mostly) <code>PipeOpModule</code>s and some other
information. The <code>PipeOpTorch</code> transforms a
<code>ModelDescriptor</code> and adds more <code>PipeOpModule</code>s to
the <code>Graph</code>.</p>
<p><code>ModelDescriptor</code>s always build up a <code>Graph</code>
for a specific <code>Task</code>. The easiest way to initialize a proper
<code>ModelDescriptor</code> is to use the appropriate
<code>PipeOpTorchIngress</code> for a given datatype. Below we use
<code>PipeOpTorchIngressNumeric</code>, which is is is used for numeric
data.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">tsk</a></span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">po_torch_in</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num"</span><span class="op">)</span></span>
<span><span class="va">md</span> <span class="op">=</span> <span class="va">po_torch_in</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">task</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">md</span></span>
<span><span class="co">#&gt; &lt;ModelDescriptor: 1 ops&gt;</span></span>
<span><span class="co">#&gt; * Ingress:  torch_ingress_num.input: [(NA,3)]</span></span>
<span><span class="co">#&gt; * Task:  iris [classif]</span></span>
<span><span class="co">#&gt; * Callbacks:  N/A</span></span>
<span><span class="co">#&gt; * Optimizer:  N/A</span></span>
<span><span class="co">#&gt; * Loss:  N/A</span></span>
<span><span class="co">#&gt; * pointer:  torch_ingress_num.output [(NA,3)]</span></span></code></pre></div>
<p>The <code>ModelDescriptor</code> is an S3 object that contains a
<code>Graph</code>, information about how to generate data
(<code>$ingress</code> and <code>$task</code>), some further tags about
how to build a model that are unrelated to architecture
(<code>$optimizer</code>, <code>$loss</code> and
<code>$callbacks</code>) as well as all further information necessary to
extend that graph along a given output (<code>$pointer</code> and
<code>$pointer_shape</code>).</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">unclass</a></span><span class="op">(</span><span class="va">md</span><span class="op">)</span></span>
<span><span class="co">#&gt; $graph</span></span>
<span><span class="co">#&gt; Graph with 1 PipeOps:</span></span>
<span><span class="co">#&gt;                 ID         State sccssors prdcssors</span></span>
<span><span class="co">#&gt;             &lt;char&gt;        &lt;char&gt;   &lt;char&gt;    &lt;char&gt;</span></span>
<span><span class="co">#&gt;  torch_ingress_num &lt;&lt;UNTRAINED&gt;&gt;                   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $ingress</span></span>
<span><span class="co">#&gt; $ingress$torch_ingress_num.input</span></span>
<span><span class="co">#&gt; Ingress: Task[selector_name(c("Petal.Length", "Sepal.Length", "Sepal.Width"), assert_present = TRUE)] --&gt; Tensor(NA, 3)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $task</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="color: #0000BB; font-weight: bold;">&lt;TaskClassif&gt;</span><span style="font-weight: bold;"> (150x4): Iris Flowers</span> <span style="color: #00BBBB;">─────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; • Target: Species</span></span>
<span><span class="co">#&gt; • Target classes: setosa (33%), versicolor (33%), virginica (33%)</span></span>
<span><span class="co">#&gt; • Properties: multiclass</span></span>
<span><span class="co">#&gt; • Features (3):</span></span>
<span><span class="co">#&gt;   • dbl (3): Petal.Length, Sepal.Length, Sepal.Width</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $optimizer</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $loss</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $callbacks</span></span>
<span><span class="co">#&gt; named list()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $pointer</span></span>
<span><span class="co">#&gt; [1] "torch_ingress_num" "output"           </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $pointer_shape</span></span>
<span><span class="co">#&gt; [1] NA  3</span></span></code></pre></div>
<p>The <code>$pointer</code> identifies the output of the
<code>$graph</code> that <code>PipeOpTorch</code> will extend. Piping
this <code>ModelDescriptor</code> through
<code>PipeOpTorchLinear</code>, for example, adds a
<code>PipeOpModule</code> wrapping a <code><a href="https://torch.mlverse.org/docs/reference/nn_linear.html" class="external-link">torch::nn_linear</a></code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">po_torch_linear</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">md</span> <span class="op">=</span> <span class="va">po_torch_linear</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">md</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">md</span><span class="op">$</span><span class="va">graph</span></span>
<span><span class="co">#&gt; Graph with 2 PipeOps:</span></span>
<span><span class="co">#&gt;                 ID         State  sccssors         prdcssors</span></span>
<span><span class="co">#&gt;             &lt;char&gt;        &lt;char&gt;    &lt;char&gt;            &lt;char&gt;</span></span>
<span><span class="co">#&gt;  torch_ingress_num &lt;&lt;UNTRAINED&gt;&gt; nn_linear                  </span></span>
<span><span class="co">#&gt;          nn_linear &lt;&lt;UNTRAINED&gt;&gt;           torch_ingress_num</span></span></code></pre></div>
<p>The <code>$pointer</code> is now updated to identify the output of
that <code>PipeOpModule</code>, and the <code>$pointer_shape</code>
shows that the shape has changed to 4 units (was 3 for the input
before).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">md</span><span class="op">$</span><span class="va">pointer</span></span>
<span><span class="co">#&gt; [1] "nn_linear" "output"</span></span>
<span><span class="va">md</span><span class="op">$</span><span class="va">pointer_shape</span></span>
<span><span class="co">#&gt; [1] NA  4</span></span></code></pre></div>
<p>The <code><a href="../reference/model_descriptor_to_module.html">model_descriptor_to_module()</a></code> function converts this
to an <code>nn_graph</code>, it is a functional
<code><a href="https://torch.mlverse.org/docs/reference/nn_module.html" class="external-link">torch::nn_module</a></code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">small_module</span> <span class="op">=</span> <span class="fu"><a href="../reference/model_descriptor_to_module.html">model_descriptor_to_module</a></span><span class="op">(</span><span class="va">md</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">md</span><span class="op">$</span><span class="va">pointer</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">small_module</span><span class="op">(</span><span class="va">input</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  1.4207 -0.0052 -0.0986 -0.5160</span></span>
<span><span class="co">#&gt;  0.6002  0.4710  0.1887  0.3873</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,4} ][ grad_fn = &lt;AddmmBackward0&gt; ]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="using-modeldescriptor-to-get-data">Using <code>ModelDescriptor</code> to get Data<a class="anchor" aria-label="anchor" href="#using-modeldescriptor-to-get-data"></a>
</h3>
<p>The <code>ModelDescriptor</code> does not only represent the
<code>Graph</code> from which a <code>nn_module</code> is created, but
also the way in which the <code>Task</code> is is processed to get input
batches. A <code><a href="https://torch.mlverse.org/docs/reference/dataset.html" class="external-link">torch::dataset</a></code> can be created by calling
<code><a href="../reference/task_dataset.html">task_dataset()</a></code>; both the <code>task</code> and the
<code>feature_ingress_tokens</code> arguments can be retrieved from the
<code>ModelDescriptor</code>. The <code>target_batchgetter</code> needs
to be created extra (if necessary), since it depends on the ultimate
machine learning model, which we have not looked at so far.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">td</span> <span class="op">=</span> <span class="fu"><a href="../reference/task_dataset.html">task_dataset</a></span><span class="op">(</span></span>
<span>  task <span class="op">=</span> <span class="va">md</span><span class="op">$</span><span class="va">task</span>,</span>
<span>  feature_ingress_tokens <span class="op">=</span> <span class="va">md</span><span class="op">$</span><span class="va">ingress</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">td</span></span>
<span><span class="co">#&gt; &lt;task_dataset&gt;</span></span>
<span><span class="co">#&gt;   Inherits from: &lt;dataset&gt;</span></span>
<span><span class="co">#&gt;   Public:</span></span>
<span><span class="co">#&gt;     .getbatch: function (index) </span></span>
<span><span class="co">#&gt;     .getitem: function (index) </span></span>
<span><span class="co">#&gt;     .length: function () </span></span>
<span><span class="co">#&gt;     all_features: Petal.Length Sepal.Length Sepal.Width Species</span></span>
<span><span class="co">#&gt;     cache_lazy_tensors: FALSE</span></span>
<span><span class="co">#&gt;     clone: function (deep = FALSE) </span></span>
<span><span class="co">#&gt;     feature_ingress_tokens: list</span></span>
<span><span class="co">#&gt;     initialize: function (task, feature_ingress_tokens, target_batchgetter = NULL) </span></span>
<span><span class="co">#&gt;     load_state_dict: function (x, ..., .refer_to_state_dict = FALSE) </span></span>
<span><span class="co">#&gt;     state_dict: function () </span></span>
<span><span class="co">#&gt;     target_batchgetter: NULL</span></span>
<span><span class="co">#&gt;     task: TaskClassif, TaskSupervised, Task, R6</span></span></code></pre></div>
<p>Use the <code>$.getbatch()</code> method to get a batch that can be
given to the <code>nn_module</code>. Note it has an <code>$x</code> and
an <code>$y</code> slot, the latter of which is not used, to account for
possible target batches. The <code>$x</code> slot is also a
<code>list</code>, since it should be able to handle NNs with multiple
inputs (see below).</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">batch</span> <span class="op">=</span> <span class="va">td</span><span class="op">$</span><span class="fu">.getbatch</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">batch</span></span>
<span><span class="co">#&gt; $x</span></span>
<span><span class="co">#&gt; $x$torch_ingress_num.input</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  1.4000  5.1000  3.5000</span></span>
<span><span class="co">#&gt;  1.4000  4.9000  3.0000</span></span>
<span><span class="co">#&gt;  1.3000  4.7000  3.2000</span></span>
<span><span class="co">#&gt; [ CPUFloatType{3,3} ]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $.index</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  1</span></span>
<span><span class="co">#&gt;  2</span></span>
<span><span class="co">#&gt;  3</span></span>
<span><span class="co">#&gt; [ CPULongType{3} ]</span></span>
<span></span>
<span><span class="fu">small_module</span><span class="op">(</span><span class="va">batch</span><span class="op">$</span><span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  1.9002  0.8328 -0.1584 -0.7467</span></span>
<span><span class="co">#&gt;  1.7256  0.8871 -0.1164 -0.5854</span></span>
<span><span class="co">#&gt;  1.7816  0.7929 -0.1231 -0.6396</span></span>
<span><span class="co">#&gt; [ CPUFloatType{3,4} ][ grad_fn = &lt;AddmmBackward0&gt; ]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="building-sequential-nns">Building sequential NNs<a class="anchor" aria-label="anchor" href="#building-sequential-nns"></a>
</h3>
<p>The sequential NN from above can easily be implemented as
follows:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph_generator</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">4</span>, id <span class="op">=</span> <span class="st">"linear1"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_sigmoid"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"linear2"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_softmax"</span>, dim <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>Note how the second <code>nn_linear</code> does not need to be
informed about the output dimension of the first <code>nn_linear</code>,
since the <code>ModelDescriptor</code> that is passed along the
<code>Graph</code> edges knows this info (in the
<code>$pointer_shape</code> slot).</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">md_sequential</span> <span class="op">=</span> <span class="va">graph_generator</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">graph_module</span> <span class="op">=</span> <span class="fu"><a href="../reference/model_descriptor_to_module.html">model_descriptor_to_module</a></span><span class="op">(</span><span class="va">md_sequential</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">md_sequential</span><span class="op">$</span><span class="va">pointer</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">graph_module</span><span class="op">(</span><span class="va">input</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  0.5494  0.2297  0.2208</span></span>
<span><span class="co">#&gt;  0.5346  0.1971  0.2683</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,3} ][ grad_fn = &lt;SoftmaxBackward0&gt; ]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="building-more-interesting-nns">Building more interesting NNs<a class="anchor" aria-label="anchor" href="#building-more-interesting-nns"></a>
</h3>
<p>One of the main features of <code>mlr3pipelines</code> is its ability
to easily represent computational <code>Graph</code>s. The
<code>ModelDescriptor</code> / <code>PipeOpTorch</code> setup is built
to make full use of this functionality. It is possible to have multiple
inputs into a NN by using multiple <code>PipeOpTorchIngress</code>
inputs, it is possible to have parallel and alternative path branching,
and it is possible to have multiple outputs.</p>
<p>Consider the following (a bit nonsensical) network that operates
differently on the <code>"Petal"</code> than on the <code>"Sepal"</code>
features of <code>tsk("iris")</code> We manually split the task here,
further down it is shown that the wholly integrated
<code>mlr3pipelines</code> pipeline can do this automatically.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_petal</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">tsk</a></span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Petal.Length"</span>, <span class="st">"Petal.Width"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">iris_sepal</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">tsk</a></span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sepal.Length"</span>, <span class="st">"Sepal.Width"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph_sepal</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num"</span>, id <span class="op">=</span> <span class="st">"sepal.in"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">4</span>, id <span class="op">=</span> <span class="st">"linear1"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">graph_petal</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num"</span>, id <span class="op">=</span> <span class="st">"petal.in"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"linear2"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_tanh"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">5</span>, id <span class="op">=</span> <span class="st">"linear3"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">graph_common</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/ppl.html" class="external-link">ppl</a></span><span class="op">(</span><span class="st">"branch"</span>, graphs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    sigmoid <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_sigmoid"</span><span class="op">)</span>,</span>
<span>    relu <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_relu"</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/gunion.html" class="external-link">gunion</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"lin_out"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"cat_out"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_softmax"</span>, dim <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">graph_iris</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/gunion.html" class="external-link">gunion</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">graph_sepal</span>, <span class="va">graph_petal</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_merge_cat"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="va">graph_common</span></span>
<span></span>
<span><span class="va">graph_iris</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>html <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-e5c8c404fe174e4c81bd" style="width:50%;height:400px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-e5c8c404fe174e4c81bd">{"x":{"nodes":{"id":["sepal.in","petal.in","linear2","nn_tanh","linear1","linear3","nn_sigmoid","nn_relu","branch","cat_out","unbranch","nn_merge_cat","<INPUT>","lin_out","nn_softmax","<OUTPUT>\nlin_out.output","<OUTPUT>\nnn_softmax.output"],"label":["sepal.in","petal.in","linear2","nn_tanh","linear1","linear3","nn_sigmoid","nn_relu","branch","cat_out","unbranch","nn_merge_cat","<INPUT>","lin_out","nn_softmax","<OUTPUT>\nlin_out.output","<OUTPUT>\nnn_softmax.output"],"shape":["box","box","box","box","box","box","box","box","box","box","box","box","database","box","box","box","box"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","rgba(0,204,102,0.2)","lightblue","lightblue","lightblue","lightblue"],"value":[1,1,1,1,1,1,1,1,1,1,1,1,0.8,1,1,1,1],"title":["<p>PipeOp: <b>sepal.in<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>petal.in<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>linear2<\/b> (not trained)<br>values: <b>out_features=3<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>nn_tanh<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>linear1<\/b> (not trained)<br>values: <b>out_features=4<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>linear3<\/b> (not trained)<br>values: <b>out_features=5<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>nn_sigmoid<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>nn_relu<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>branch<\/b> (not trained)<br>values: <b>selection=sigmoid<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [*,*]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  sigmoid [*,*], relu [*,*]<\/p>","<p>PipeOp: <b>cat_out<\/b> (not trained)<br>values: <b>out_features=3<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>unbranch<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  sigmoid [*,*], relu [*,*]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [*,*]<\/p>","<p>PipeOp: <b>nn_merge_cat<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  ... [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>Input:<br>Name: sepal.in.input<br>Train: Task<br>Predict: Task<br>Input:<br>Name: petal.in.input<br>Train: Task<br>Predict: Task<\/p>","<p>PipeOp: <b>lin_out<\/b> (not trained)<br>values: <b>out_features=1<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>nn_softmax<\/b> (not trained)<br>values: <b>dim=2<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>Output:<br>Name: lin_out.output<br>Train: ModelDescriptor<br>Predict: Task<\/p>","<p>Output:<br>Name: nn_softmax.output<br>Train: ModelDescriptor<br>Predict: Task<\/p>"],"x":[1,-1,-1,-1,1,-1,-1,1,0,-1,0,0,0,1,-1,1,-1],"y":[-0.4545454545454546,-0.8181818181818181,-0.6363636363636364,-0.4545454545454546,-0.2727272727272727,-0.2727272727272727,0.2727272727272727,0.2727272727272727,0.09090909090909083,0.6363636363636365,0.4545454545454546,-0.09090909090909094,-1,0.6363636363636365,0.8181818181818181,0.8181818181818181,1]},"edges":{"from":["sepal.in","petal.in","linear2","nn_tanh","linear1","linear3","nn_sigmoid","nn_relu","branch","branch","cat_out","unbranch","unbranch","nn_merge_cat","<INPUT>","<INPUT>","lin_out","nn_softmax"],"to":["linear1","linear2","nn_tanh","linear3","nn_merge_cat","nn_merge_cat","unbranch","unbranch","nn_sigmoid","nn_relu","nn_softmax","lin_out","cat_out","branch","sepal.in","petal.in","<OUTPUT>\nlin_out.output","<OUTPUT>\nnn_softmax.output"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"arrows":"to","smooth":{"enabled":false,"forceDirection":"vertical"}},"physics":{"stabilization":false}},"groups":null,"width":"50%","height":"400px","idselection":{"enabled":false},"byselection":{"enabled":false},"main":null,"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","igraphlayout":{"type":"full"}},"evals":[],"jsHooks":[]}</script><p>We can use this to create a neural network for the <code>iris</code>
tasks we created above. We set the <code>$keep_results</code> debug flag
here so we can do some inspection about what is happening:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph_iris</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">branch.selection</span> <span class="op">=</span> <span class="st">"relu"</span></span>
<span></span>
<span><span class="va">graph_iris</span><span class="op">$</span><span class="va">keep_results</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span></span>
<span><span class="va">iris_mds</span> <span class="op">=</span> <span class="va">graph_iris</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span></span>
<span>  input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sepal.in.input <span class="op">=</span> <span class="va">iris_sepal</span>, petal.in.input <span class="op">=</span> <span class="va">iris_petal</span><span class="op">)</span>,</span>
<span>  single_input <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">iris_mds</span></span>
<span><span class="co">#&gt; $lin_out.output</span></span>
<span><span class="co">#&gt; &lt;ModelDescriptor: 11 ops&gt;</span></span>
<span><span class="co">#&gt; * Ingress:  sepal.in.input: [(NA,2)], petal.in.input: [(NA,2)]</span></span>
<span><span class="co">#&gt; * Task:  iris [classif]</span></span>
<span><span class="co">#&gt; * Callbacks:  N/A</span></span>
<span><span class="co">#&gt; * Optimizer:  N/A</span></span>
<span><span class="co">#&gt; * Loss:  N/A</span></span>
<span><span class="co">#&gt; * pointer:  lin_out.output [(NA,1)]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nn_softmax.output</span></span>
<span><span class="co">#&gt; &lt;ModelDescriptor: 11 ops&gt;</span></span>
<span><span class="co">#&gt; * Ingress:  sepal.in.input: [(NA,2)], petal.in.input: [(NA,2)]</span></span>
<span><span class="co">#&gt; * Task:  iris [classif]</span></span>
<span><span class="co">#&gt; * Callbacks:  N/A</span></span>
<span><span class="co">#&gt; * Optimizer:  N/A</span></span>
<span><span class="co">#&gt; * Loss:  N/A</span></span>
<span><span class="co">#&gt; * pointer:  nn_softmax.output [(NA,3)]</span></span></code></pre></div>
<p>We make multiple observations here:</p>
<ol style="list-style-type: decimal">
<li>
<p>We can observe how the <code>ModelDescriptor</code> grows as it
is passed along the edges of <code>graph_iris</code>. Note that the
<code>$graph</code> slot of that <code>ModelDescriptor</code> is often
updated by-reference, so by the time we inspect intermediate results,
they may contain the complete graph. However, see how the
<code>$ingress</code>, <code>$pointer</code> and
<code>$pointer_shape</code> of the <code>ModelDescriptor</code>s that
take the <code>sepal.in</code>-path differ from the ones that take the
<code>petal.in</code>-path:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># sepal.in path</span></span>
<span><span class="va">graph_iris</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">linear1</span><span class="op">$</span><span class="va">.result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ingress</span></span>
<span><span class="co">#&gt; $sepal.in.input</span></span>
<span><span class="co">#&gt; Ingress: Task[selector_name(c("Sepal.Length", "Sepal.Width"), assert_present = TRUE)] --&gt; Tensor(NA, 2)</span></span>
<span><span class="va">graph_iris</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">linear1</span><span class="op">$</span><span class="va">.result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pointer</span></span>
<span><span class="co">#&gt; [1] "linear1" "output"</span></span>
<span><span class="va">graph_iris</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">linear1</span><span class="op">$</span><span class="va">.result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pointer_shape</span></span>
<span><span class="co">#&gt; [1] NA  4</span></span>
<span></span>
<span><span class="co"># petal.in path</span></span>
<span><span class="va">graph_iris</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">linear3</span><span class="op">$</span><span class="va">.result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ingress</span></span>
<span><span class="co">#&gt; $petal.in.input</span></span>
<span><span class="co">#&gt; Ingress: Task[selector_name(c("Petal.Length", "Petal.Width"), assert_present = TRUE)] --&gt; Tensor(NA, 2)</span></span>
<span><span class="va">graph_iris</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">linear3</span><span class="op">$</span><span class="va">.result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pointer</span></span>
<span><span class="co">#&gt; [1] "linear3" "output"</span></span>
<span><span class="va">graph_iris</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">linear3</span><span class="op">$</span><span class="va">.result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pointer_shape</span></span>
<span><span class="co">#&gt; [1] NA  5</span></span></code></pre></div>
<p><code>po("nn_merge_cat")</code> unites the two
<code>ModelDescriptor</code>s and contains the common ingress. The
<code>pointer_shape</code> now reflects the output of the
“cat”-operation: the 2nd dimension is added up:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph_iris</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">nn_merge_cat</span><span class="op">$</span><span class="va">.result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ingress</span></span>
<span><span class="co">#&gt; $sepal.in.input</span></span>
<span><span class="co">#&gt; Ingress: Task[selector_name(c("Sepal.Length", "Sepal.Width"), assert_present = TRUE)] --&gt; Tensor(NA, 2)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $petal.in.input</span></span>
<span><span class="co">#&gt; Ingress: Task[selector_name(c("Petal.Length", "Petal.Width"), assert_present = TRUE)] --&gt; Tensor(NA, 2)</span></span>
<span><span class="va">graph_iris</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">nn_merge_cat</span><span class="op">$</span><span class="va">.result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pointer_shape</span></span>
<span><span class="co">#&gt; [1] NA  9</span></span></code></pre></div>
</li>
<li>
<p>Multiple <code>ModelDescriptor</code>s were created, since the
<code>graph_iris</code> has multiple outpus. This makes it possible to
create a neural network with multiple outputs. We need to unite the
outputs of <code>graph_iris</code> using
<code><a href="../reference/model_descriptor_union.html">model_descriptor_union()</a></code> before we can pass it to
<code><a href="../reference/model_descriptor_to_module.html">model_descriptor_to_module()</a></code>. We need to collect all
<code>output_pointers</code> separately.</p>
<p>The parameter <code>list_output</code> must be set to
<code>TRUE</code> since the module has multiple outputs.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_mds_union</span> <span class="op">=</span> <span class="fu"><a href="../reference/model_descriptor_union.html">model_descriptor_union</a></span><span class="op">(</span><span class="va">iris_mds</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">iris_mds</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">output_pointers</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">iris_mds</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pointer</span>, <span class="va">iris_mds</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">pointer</span><span class="op">)</span></span>
<span><span class="va">output_pointers</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] "lin_out" "output" </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] "nn_softmax" "output"</span></span>
<span><span class="va">iris_module</span> <span class="op">=</span> <span class="fu"><a href="../reference/model_descriptor_to_module.html">model_descriptor_to_module</a></span><span class="op">(</span><span class="va">iris_mds_union</span>, <span class="va">output_pointers</span>, list_output <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p>The <code>PipeOpBranch</code> disappears in the resulting
<code>Graph</code> of <code>PipeOpModule</code> in the
<code>iris_module</code>. This is because only the
<code>PipeOpTorch</code>s in the <code>graph_iris</code> add anything to
the <code>ModelDescriptor</code>s. The branch is interpeted when
<code>graph_iris</code> runs, and only the <code>nn_relu</code> path is
followed. The <code>iris_module</code> therefore contains a
<code>Graph</code> that does “relu” activation:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_module</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>html <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-36aa3d2a04d42bbc2145" style="width:50%;height:400px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-36aa3d2a04d42bbc2145">{"x":{"nodes":{"id":["sepal.in","petal.in","linear2","nn_tanh","linear1","linear3","nn_merge_cat","nn_relu","cat_out","<INPUT>","lin_out","nn_softmax","<OUTPUT>\nlin_out.output","<OUTPUT>\nnn_softmax.output"],"label":["sepal.in","petal.in","linear2","nn_tanh","linear1","linear3","nn_merge_cat","nn_relu","cat_out","<INPUT>","lin_out","nn_softmax","<OUTPUT>\nlin_out.output","<OUTPUT>\nnn_softmax.output"],"shape":["box","box","box","box","box","box","box","box","box","database","box","box","box","box"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","rgba(0,204,102,0.2)","lightblue","lightblue","lightblue","lightblue"],"value":[1,1,1,1,1,1,1,1,1,0.8,1,1,1,1],"title":["<p>PipeOp: <b>sepal.in<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [*,*]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [*,*]<\/p>","<p>PipeOp: <b>petal.in<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [*,*]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [*,*]<\/p>","<p>PipeOp: <b>linear2<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>PipeOp: <b>nn_tanh<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>PipeOp: <b>linear1<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>PipeOp: <b>linear3<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>PipeOp: <b>nn_merge_cat<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  ... [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>PipeOp: <b>nn_relu<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>PipeOp: <b>cat_out<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>Input:<br>Name: sepal.in.input<br>Train: *<br>Predict: *<br>Input:<br>Name: petal.in.input<br>Train: *<br>Predict: *<\/p>","<p>PipeOp: <b>lin_out<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>PipeOp: <b>nn_softmax<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>Output:<br>Name: lin_out.output<br>Train: torch_tensor<br>Predict: NULL<\/p>","<p>Output:<br>Name: nn_softmax.output<br>Train: torch_tensor<br>Predict: NULL<\/p>"],"x":[1,-1,-1,-1,1,-1,0,0,-1,0,1,-1,1,-1],"y":[-0.3333333333333334,-0.7777777777777778,-0.5555555555555556,-0.3333333333333334,-0.1111111111111112,-0.1111111111111112,0.1111111111111112,0.3333333333333333,0.5555555555555556,-1,0.5555555555555556,0.7777777777777777,0.7777777777777777,1]},"edges":{"from":["sepal.in","petal.in","linear2","nn_tanh","linear1","linear3","nn_merge_cat","nn_relu","nn_relu","cat_out","<INPUT>","<INPUT>","lin_out","nn_softmax"],"to":["linear1","linear2","nn_tanh","linear3","nn_merge_cat","nn_merge_cat","nn_relu","lin_out","cat_out","nn_softmax","sepal.in","petal.in","<OUTPUT>\nlin_out.output","<OUTPUT>\nnn_softmax.output"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"arrows":"to","smooth":{"enabled":false,"forceDirection":"vertical"}},"physics":{"stabilization":false}},"groups":null,"width":"50%","height":"400px","idselection":{"enabled":false},"byselection":{"enabled":false},"main":null,"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","igraphlayout":{"type":"full"}},"evals":[],"jsHooks":[]}</script>
</li>
<li>
<p>The <code>ModelDescriptor</code>’s <code>$task</code> slot
contains a <code>Task</code> with all features that are used to create
the input data for all NN inputs. It can be given to
<code><a href="../reference/task_dataset.html">task_dataset()</a></code>, along with the <code>$ingress</code>, to
create a <code>torch</code> <code>dataset</code> that creates all
batches. As above, any output of <code>graph_iris</code> can be
used:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_mds_union</span><span class="op">$</span><span class="va">task</span>  <span class="co"># contains all features</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="color: #0000BB; font-weight: bold;">&lt;TaskClassif&gt;</span><span style="font-weight: bold;"> (150x5): Iris Flowers</span> <span style="color: #00BBBB;">─────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; • Target: Species</span></span>
<span><span class="co">#&gt; • Target classes: setosa (33%), versicolor (33%), virginica (33%)</span></span>
<span><span class="co">#&gt; • Properties: multiclass</span></span>
<span><span class="co">#&gt; • Features (4):</span></span>
<span><span class="co">#&gt;   • dbl (4): Petal.Length, Petal.Width, Sepal.Length, Sepal.Width</span></span>
<span></span>
<span><span class="va">iris_td</span> <span class="op">=</span> <span class="fu"><a href="../reference/task_dataset.html">task_dataset</a></span><span class="op">(</span></span>
<span>  task <span class="op">=</span> <span class="va">iris_mds_union</span><span class="op">$</span><span class="va">task</span>,</span>
<span>  feature_ingress_tokens <span class="op">=</span> <span class="va">iris_mds_union</span><span class="op">$</span><span class="va">ingress</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">batch</span> <span class="op">=</span> <span class="va">iris_td</span><span class="op">$</span><span class="fu">.getbatch</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">batch</span></span>
<span><span class="co">#&gt; $x</span></span>
<span><span class="co">#&gt; $x$sepal.in.input</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  5.1000  3.5000</span></span>
<span><span class="co">#&gt;  4.9000  3.0000</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,2} ]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $x$petal.in.input</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  1.4000  0.2000</span></span>
<span><span class="co">#&gt;  1.4000  0.2000</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,2} ]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $.index</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  1</span></span>
<span><span class="co">#&gt;  2</span></span>
<span><span class="co">#&gt; [ CPULongType{2} ]</span></span></code></pre></div>
</li>
<li>
<p>The resulting module has multiple inputs and multiple outputs. We
call it with the first two rows of iris, but set the debug
<code>$keep_results</code> flag so we can inspect what is happening in
the <code>nn_module</code>’s <code>$graph</code>:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_module</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">keep_results</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span></span>
<span><span class="fu">iris_module</span><span class="op">(</span></span>
<span>  sepal.in.input <span class="op">=</span> <span class="va">batch</span><span class="op">$</span><span class="va">x</span><span class="op">$</span><span class="va">sepal.in.input</span>,</span>
<span>  petal.in.input <span class="op">=</span> <span class="va">batch</span><span class="op">$</span><span class="va">x</span><span class="op">$</span><span class="va">petal.in.input</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; $lin_out.output</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -0.8596</span></span>
<span><span class="co">#&gt; -0.7547</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,1} ][ grad_fn = &lt;AddmmBackward0&gt; ]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nn_softmax.output</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  0.0224  0.4094  0.5682</span></span>
<span><span class="co">#&gt;  0.0274  0.4149  0.5577</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,3} ][ grad_fn = &lt;SoftmaxBackward0&gt; ]</span></span></code></pre></div>
<p>The first linear layer that takes “Sepal” input
(<code>"linear1"</code>) creates a 2x4 tensor (batch size 2, 4 units),
while the <code>"linear3"</code> layer has 2x5 output:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_module</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">linear1</span><span class="op">$</span><span class="va">.result</span></span>
<span><span class="co">#&gt; $output</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -2.2473 -0.5947  4.3355  0.5175</span></span>
<span><span class="co">#&gt; -1.9323 -0.6887  3.9716  0.5123</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,4} ][ grad_fn = &lt;AddmmBackward0&gt; ]</span></span>
<span><span class="va">iris_module</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">linear3</span><span class="op">$</span><span class="va">.result</span></span>
<span><span class="co">#&gt; $output</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; 0.01 *</span></span>
<span><span class="co">#&gt; -5.5942 -64.3158  0.9635 -0.7456 -39.0904</span></span>
<span><span class="co">#&gt;  -5.5942 -64.3158  0.9635 -0.7456 -39.0904</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,5} ][ grad_fn = &lt;AddmmBackward0&gt; ]</span></span></code></pre></div>
<p>We observe that the <code>po("nn_merge_cat")</code> concatenates
these, as expected:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_module</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">nn_merge_cat</span><span class="op">$</span><span class="va">.result</span></span>
<span><span class="co">#&gt; $output</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -2.2473 -0.5947  4.3355  0.5175 -0.0559 -0.6432  0.0096 -0.0075 -0.3909</span></span>
<span><span class="co">#&gt; -1.9323 -0.6887  3.9716  0.5123 -0.0559 -0.6432  0.0096 -0.0075 -0.3909</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,9} ][ grad_fn = &lt;CatBackward0&gt; ]</span></span></code></pre></div>
</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="building-torch-learners">Building Torch Learners<a class="anchor" aria-label="anchor" href="#building-torch-learners"></a>
</h2>
<p>We have now seen how NN <code>Graph</code>s of
<code>PipeOpModule</code> are created and turned into
<code>nn_module</code>s. Using <code>PipeOpTorch</code> even creates
<code>ModelDescriptor</code> objects that contain additional info about
how batch tensors are extracted from <code>Task</code>s. For a complete
<code>Learner</code>, it is still necessary to define the loss-function
used for optimization, the optimizer, and optionally some callbacks. We
have already covered their class representations –
<code>TorchLoss</code>, <code>TorchOptimizer</code>,
<code>TorchCallbacks</code>, in the <em>Get Started</em> vignette. Here
we use adam as the optimizer, cross-entropy as the loss function, and
the history callback.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">adam</span> <span class="op">=</span> <span class="fu"><a href="../reference/t_opt.html">t_opt</a></span><span class="op">(</span><span class="st">"adam"</span>, lr <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="va">adam</span></span>
<span><span class="co">#&gt; &lt;TorchOptimizer:adam&gt; Adaptive Moment Estimation</span></span>
<span><span class="co">#&gt; * Generator: optim_ignite_adam</span></span>
<span><span class="co">#&gt; * Parameters: lr=0.02</span></span>
<span><span class="co">#&gt; * Packages: torch,mlr3torch</span></span>
<span></span>
<span><span class="va">xe</span> <span class="op">=</span> <span class="fu"><a href="../reference/t_loss.html">t_loss</a></span><span class="op">(</span><span class="st">"cross_entropy"</span><span class="op">)</span></span>
<span><span class="va">xe</span></span>
<span><span class="co">#&gt; &lt;TorchLoss:cross_entropy&gt; Cross Entropy</span></span>
<span><span class="co">#&gt; * Generator: function</span></span>
<span><span class="co">#&gt; * Parameters: list()</span></span>
<span><span class="co">#&gt; * Packages: torch,mlr3torch</span></span>
<span><span class="co">#&gt; * Task Types: classif</span></span>
<span></span>
<span><span class="va">history</span> <span class="op">=</span> <span class="fu"><a href="../reference/t_clbk.html">t_clbk</a></span><span class="op">(</span><span class="st">"history"</span><span class="op">)</span></span>
<span><span class="va">history</span></span>
<span><span class="co">#&gt; &lt;TorchCallback:history&gt; History</span></span>
<span><span class="co">#&gt; * Generator: CallbackSetHistory</span></span>
<span><span class="co">#&gt; * Parameters: list()</span></span>
<span><span class="co">#&gt; * Packages: mlr3torch,torch</span></span></code></pre></div>
<div class="section level3">
<h3 id="learnertorchmodel">
<code>LearnerTorchModel</code><a class="anchor" aria-label="anchor" href="#learnertorchmodel"></a>
</h3>
<p><code>LearnerTorchModel</code> represents a supervised model
(regression or classification) using <code>torch</code> NNs. It needs a
<code>nn_module</code>, as well as a list of
<code>TorchIngressToken</code> that define how batches are created from
a <code>Task</code>. <code>TorchIngressToken</code> hard-code the
column-names of a <code>Task</code> that are used for data-input, the
<code>Learner</code> created like this therefore only works for the
specific <code>Task</code> created. (Generally the full
<code>mlr3pipelines</code>-UI should be used if this is a problem, see
below.) The following uses the sequential NN from above:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr_sequential</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">lrn</a></span><span class="op">(</span><span class="st">"classif.torch_model"</span>,</span>
<span>  task_type <span class="op">=</span> <span class="st">"classif"</span>,</span>
<span>  network <span class="op">=</span> <span class="fu"><a href="../reference/model_descriptor_to_module.html">model_descriptor_to_module</a></span><span class="op">(</span><span class="va">md_sequential</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">md_sequential</span><span class="op">$</span><span class="va">pointer</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  ingress_tokens <span class="op">=</span> <span class="va">md_sequential</span><span class="op">$</span><span class="va">ingress</span>,</span>
<span>  optimizer <span class="op">=</span> <span class="va">adam</span>,</span>
<span>  callbacks <span class="op">=</span> <span class="va">history</span>,</span>
<span>  loss <span class="op">=</span> <span class="va">xe</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">lr_sequential</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="color: #0000BB; font-weight: bold;">&lt;LearnerTorchModel&gt;</span><span style="font-weight: bold;"> (classif.model): Torch Model</span> <span style="color: #00BBBB;">────────────────────────────</span></span></span>
<span><span class="co">#&gt; • Model: -</span></span>
<span><span class="co">#&gt; • Parameters: device=auto, num_threads=1, num_interop_threads=1, seed=random,</span></span>
<span><span class="co">#&gt; eval_freq=1, measures_train=&lt;list&gt;, measures_valid=&lt;list&gt;, patience=0,</span></span>
<span><span class="co">#&gt; min_delta=0, shuffle=TRUE, tensor_dataset=FALSE, jit_trace=FALSE, opt.lr=0.02</span></span>
<span><span class="co">#&gt; • Validate: NULL</span></span>
<span><span class="co">#&gt; • Packages: <span style="color: #0000BB;">mlr3</span>, <span style="color: #0000BB;">mlr3torch</span>, and <span style="color: #0000BB;">torch</span></span></span>
<span><span class="co">#&gt; • Predict Types: [response] and prob</span></span>
<span><span class="co">#&gt; • Feature Types: logical, integer, numeric, character, factor, ordered,</span></span>
<span><span class="co">#&gt; POSIXct, Date, and lazy_tensor</span></span>
<span><span class="co">#&gt; • Encapsulation: none (fallback: -)</span></span>
<span><span class="co">#&gt; • Properties: featureless, hotstart_backward, hotstart_forward, importance,</span></span>
<span><span class="co">#&gt; internal_tuning, marshal, missings, multiclass, offset, oob_error,</span></span>
<span><span class="co">#&gt; selected_features, twoclass, validation, and weights</span></span>
<span><span class="co">#&gt; • Other settings: use_weights = 'use'</span></span>
<span><span class="co">#&gt; * Optimizer: adam</span></span>
<span><span class="co">#&gt; * Loss: cross_entropy</span></span>
<span><span class="co">#&gt; * Callbacks: history</span></span></code></pre></div>
<p>Before training the model, we set some more hyperparameters.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr_sequential</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="fu">set_values</span><span class="op">(</span></span>
<span>  batch_size <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  epochs <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  measures_train <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">msrs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"classif.logloss"</span>, <span class="st">"classif.ce"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># This is required to evaluate the logloss during training</span></span>
<span><span class="va">lr_sequential</span><span class="op">$</span><span class="va">predict_type</span> <span class="op">=</span> <span class="st">"prob"</span></span>
<span></span>
<span><span class="va">lr_sequential</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">md_sequential</span><span class="op">$</span><span class="va">task</span><span class="op">)</span></span></code></pre></div>
<p>The following calls the <code>$predict_newdata</code> function to
plot the response surface along the
<code>Sepal.Width = mean(Sepal.Width)</code> plane, along with the
ground-truth values:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">newdata</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>Sepal.Width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Width</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/J.html" class="external-link">CJ</a></span><span class="op">(</span></span>
<span>  Sepal.Length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>,</span>
<span>  Petal.Length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Petal.Length</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Petal.Length</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">predictions</span> <span class="op">=</span> <span class="va">lr_sequential</span><span class="op">$</span><span class="fu">predict_newdata</span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_predictions</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">predictions</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">newdata</span>, Species <span class="op">=</span> <span class="va">predictions</span><span class="op">$</span><span class="va">response</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Sepal.Length</span>, y <span class="op">=</span> <span class="va">Petal.Length</span>, fill <span class="op">=</span> <span class="va">Species</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">iris</span>,</span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Sepal.Length</span>, y <span class="op">=</span> <span class="va">Petal.Length</span>, fill <span class="op">=</span> <span class="va">Species</span><span class="op">)</span>,</span>
<span>      color <span class="op">=</span> <span class="st">"black"</span>, pch <span class="op">=</span> <span class="fl">21</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">plot_predictions</span><span class="op">(</span><span class="va">predictions</span><span class="op">)</span></span></code></pre></div>
<p><img src="internals_pipeop_torch_files/figure-html/unnamed-chunk-37-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="torch-learner-pipelines">Torch Learner Pipelines<a class="anchor" aria-label="anchor" href="#torch-learner-pipelines"></a>
</h2>
<p>The model shown above is constructed using the
<code>ModelDescriptor</code> that is generated from a <code>Graph</code>
of <code>PipeOpTorch</code> operators. The <code>ModelDescriptor</code>
furthermore contains the <code>Task</code> to which it pertains. This
makes it possible to use it to create a NN model that gets trained right
away, using <code>PipeOpTorchModelClassif</code>. The only missing
prerequisite now is to add the desired <code>TorchOptimizer</code> and
<code>TorchLoss</code> information to the
<code>ModelDescriptor</code>.</p>
<div class="section level3">
<h3 id="adding-optimizer-loss-and-callback-meta-info-to-modeldescriptor">Adding Optimizer, Loss and Callback Meta-Info to
<code>ModelDescriptor</code><a class="anchor" aria-label="anchor" href="#adding-optimizer-loss-and-callback-meta-info-to-modeldescriptor"></a>
</h3>
<p>Remember that <code>ModelDescriptor</code> has the
<code>$optimizer</code>, <code>$loss</code> and <code>$callbacks</code>
slots that are necessary to build a complete <code>Learner</code> from
an NN. They can be set by corresponding <code>PipeOpTorch</code>
operators.</p>
<p><code>po("torch_optimizer")</code> is used to set the
<code>$optimizer</code> slot of a <code>ModelDescriptor</code>; it takes
the desired <code>TorchOptimizer</code> object on construction and
exports its <code>ParamSet</code>.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">po_adam</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_optimizer"</span>, optimizer <span class="op">=</span> <span class="va">adam</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># hyperparameters are made available and can be changed:</span></span>
<span><span class="va">po_adam</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span></span>
<span><span class="co">#&gt; $lr</span></span>
<span><span class="co">#&gt; [1] 0.02</span></span>
<span></span>
<span><span class="va">md_sequential</span> <span class="op">=</span> <span class="va">po_adam</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">md_sequential</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">md_sequential</span><span class="op">$</span><span class="va">optimizer</span></span>
<span><span class="co">#&gt; &lt;TorchOptimizer:adam&gt; Adaptive Moment Estimation</span></span>
<span><span class="co">#&gt; * Generator: optim_ignite_adam</span></span>
<span><span class="co">#&gt; * Parameters: lr=0.02</span></span>
<span><span class="co">#&gt; * Packages: torch,mlr3torch</span></span></code></pre></div>
<p>This works analogously for the loss-function.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">po_xe</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_loss"</span>, loss <span class="op">=</span> <span class="va">xe</span><span class="op">)</span></span>
<span><span class="va">md_sequential</span> <span class="op">=</span> <span class="va">po_xe</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">md_sequential</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">md_sequential</span><span class="op">$</span><span class="va">loss</span></span>
<span><span class="co">#&gt; &lt;TorchLoss:cross_entropy&gt; Cross Entropy</span></span>
<span><span class="co">#&gt; * Generator: function</span></span>
<span><span class="co">#&gt; * Parameters: list()</span></span>
<span><span class="co">#&gt; * Packages: torch,mlr3torch</span></span>
<span><span class="co">#&gt; * Task Types: classif</span></span></code></pre></div>
<p>And also for callbacks:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">po_history</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_callbacks"</span>, callbacks <span class="op">=</span> <span class="fu"><a href="../reference/t_clbk.html">t_clbk</a></span><span class="op">(</span><span class="st">"history"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">md_sequential</span> <span class="op">=</span> <span class="va">po_history</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">md_sequential</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">md_sequential</span><span class="op">$</span><span class="va">callbacks</span></span>
<span><span class="co">#&gt; $history</span></span>
<span><span class="co">#&gt; &lt;TorchCallback:history&gt; History</span></span>
<span><span class="co">#&gt; * Generator: CallbackSetHistory</span></span>
<span><span class="co">#&gt; * Parameters: list()</span></span>
<span><span class="co">#&gt; * Packages: mlr3torch,torch</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="combined-instantiation-and-training-of-learnertorchmodel">Combined Instantiation and Training of
<code>LearnerTorchModel</code><a class="anchor" aria-label="anchor" href="#combined-instantiation-and-training-of-learnertorchmodel"></a>
</h3>
<p>The <code>ModelDescriptor</code> can now be given to a
<code>po("torch_model_classif")</code>.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">po_model</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_model_classif"</span>, batch_size <span class="op">=</span> <span class="fl">50</span>, epochs <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="va">po_model</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">md_sequential</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $output</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p><code>po("torch_model_classif")</code> behaves similarly to a
<code>PipeOpLearner</code>: It returns <code>NULL</code> during
training, and the prediction on <code>$predict()</code>.
<code>po("torch_model_classif")</code> behaves similarly to a
<code>PipeOpLearner</code>: It returns <code>NULL</code> during
training, and the prediction on <code>$predict()</code>.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">newtask</span> <span class="op">=</span> <span class="va"><a href="https://mlr3.mlr-org.com/reference/TaskClassif.html" class="external-link">TaskClassif</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"newdata"</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">newdata</span>, Species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="cn">NA</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, target <span class="op">=</span> <span class="st">"Species"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">predictions</span> <span class="op">=</span> <span class="va">po_model</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">newtask</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="fu">plot_predictions</span><span class="op">(</span><span class="va">predictions</span><span class="op">)</span></span></code></pre></div>
<p><img src="internals_pipeop_torch_files/figure-html/unnamed-chunk-42-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="the-whole-pipeline">The whole Pipeline<a class="anchor" aria-label="anchor" href="#the-whole-pipeline"></a>
</h3>
<p>Remember that <code>md_sequential</code> was created using a
<code>Graph</code> that the initial <code>Task</code> was piped through.
If we combine such a <code>Graph</code> with
<code>PipeOpTorchModelClassif</code>, we get a <code>Graph</code> that
behaves like any other <code>Graph</code> that ends with a
<code>PipeOpLearner</code>, and can therefore be wrapped as a
<code>GraphLearner</code>. The following uses one more hidden layer than
before:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph_sequential_full</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">4</span>, id <span class="op">=</span> <span class="st">"linear1"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_sigmoid"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"linear2"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_softmax"</span>, dim <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"softmax"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"linear3"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_softmax"</span>, dim <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"softmax2"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_optimizer"</span>, optimizer <span class="op">=</span> <span class="va">adam</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_loss"</span>, loss <span class="op">=</span> <span class="va">xe</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_callbacks"</span>, callbacks <span class="op">=</span> <span class="va">history</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_model_classif"</span>, batch_size <span class="op">=</span> <span class="fl">50</span>, epochs <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">lr_sequential_full</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html" class="external-link">as_learner</a></span><span class="op">(</span><span class="va">graph_sequential_full</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lr_sequential_full</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span></code></pre></div>
<p>Compare the resulting <code>Graph</code></p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph_sequential_full</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>html <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-febe03efa1a2d8d52a86" style="width:50%;height:400px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-febe03efa1a2d8d52a86">{"x":{"nodes":{"id":["torch_ingress_num","linear1","nn_sigmoid","linear2","softmax","linear3","softmax2","torch_optimizer","torch_loss","torch_callbacks","<INPUT>","torch_model_classif","<OUTPUT>"],"label":["torch_ingress_num","linear1","nn_sigmoid","linear2","softmax","linear3","softmax2","torch_optimizer","torch_loss","torch_callbacks","<INPUT>","torch_model_classif","<OUTPUT>"],"shape":["box","box","box","box","box","box","box","box","box","box","database","box","ellipse"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","rgba(0,204,102,0.2)","lightblue","rgba(255,51,51,0.2)"],"value":[1,1,1,1,1,1,1,1,1,1,0.8,1,0.8],"title":["<p>PipeOp: <b>torch_ingress_num<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>linear1<\/b> (not trained)<br>values: <b>out_features=4<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>nn_sigmoid<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>linear2<\/b> (not trained)<br>values: <b>out_features=3<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>softmax<\/b> (not trained)<br>values: <b>dim=2<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>linear3<\/b> (not trained)<br>values: <b>out_features=3<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>softmax2<\/b> (not trained)<br>values: <b>dim=2<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>torch_optimizer<\/b> (not trained)<br>values: <b>lr=0.02<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>torch_loss<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>torch_callbacks<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>Input:<br>Name: torch_ingress_num.input<br>Train: Task<br>Predict: Task<\/p>","<p>PipeOp: <b>torch_model_classif<\/b> (not trained)<br>values: <b>epochs=100, device=auto, num_threads=1, num_interop_threads=1, seed=random, eval_freq=1, measures_train=<list>, measures_valid=<list>, patience=0, min_delta=0, batch_size=50, shuffle=TRUE, tensor_dataset=FALSE, jit_trace=FALSE, opt.lr=0.02<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,TaskClassif]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [NULL,PredictionClassif]<\/p>","<p>Output:<br>Name: torch_model_classif.output<br>Train: NULL<br>Predict: PredictionClassif<\/p>"],"x":[0,0,0,0,0,0,0,0,0,0,0,0,0],"y":[-0.8333333333333334,-0.6666666666666667,-0.5,-0.3333333333333334,-0.1666666666666666,0,0.1666666666666667,0.3333333333333333,0.5,0.6666666666666667,-1,0.8333333333333333,1]},"edges":{"from":["torch_ingress_num","linear1","nn_sigmoid","linear2","softmax","linear3","softmax2","torch_optimizer","torch_loss","torch_callbacks","<INPUT>","torch_model_classif"],"to":["linear1","nn_sigmoid","linear2","softmax","linear3","softmax2","torch_optimizer","torch_loss","torch_callbacks","torch_model_classif","torch_ingress_num","<OUTPUT>"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"arrows":"to","smooth":{"enabled":false,"forceDirection":"vertical"}},"physics":{"stabilization":false}},"groups":null,"width":"50%","height":"400px","idselection":{"enabled":false},"byselection":{"enabled":false},"main":null,"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","igraphlayout":{"type":"full"}},"evals":[],"jsHooks":[]}</script><p>With the <code>Graph</code> of the trained model:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">=</span> <span class="va">lr_sequential_full</span><span class="op">$</span><span class="va">graph_model</span><span class="op">$</span><span class="va">state</span><span class="op">$</span><span class="va">torch_model_classif</span><span class="op">$</span><span class="va">model</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="va">network</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>html <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-1fb4450895fe099f74a1" style="width:50%;height:400px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-1fb4450895fe099f74a1">{"x":{"nodes":{"id":["torch_ingress_num","linear1","nn_sigmoid","linear2","softmax","linear3","<INPUT>","softmax2","<OUTPUT>"],"label":["torch_ingress_num","linear1","nn_sigmoid","linear2","softmax","linear3","<INPUT>","softmax2","<OUTPUT>"],"shape":["box","box","box","box","box","box","database","box","ellipse"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","rgba(0,204,102,0.2)","lightblue","rgba(255,51,51,0.2)"],"value":[1,1,1,1,1,1,0.8,1,0.8],"title":["<p>PipeOp: <b>torch_ingress_num<\/b> (trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [*,*]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [*,*]<\/p>","<p>PipeOp: <b>linear1<\/b> (trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>PipeOp: <b>nn_sigmoid<\/b> (trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>PipeOp: <b>linear2<\/b> (trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>PipeOp: <b>softmax<\/b> (trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>PipeOp: <b>linear3<\/b> (trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>Input:<br>Name: torch_ingress_num.input<br>Train: *<br>Predict: *<\/p>","<p>PipeOp: <b>softmax2<\/b> (trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [torch_tensor,NULL]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [torch_tensor,NULL]<\/p>","<p>Output:<br>Name: softmax2.output<br>Train: torch_tensor<br>Predict: NULL<\/p>"],"x":[0,0,0,0,0,0,0,0,0],"y":[-0.75,-0.5,-0.25,0,0.25,0.5,-1,0.75,1]},"edges":{"from":["torch_ingress_num","linear1","nn_sigmoid","linear2","softmax","linear3","<INPUT>","softmax2"],"to":["linear1","nn_sigmoid","linear2","softmax","linear3","softmax2","torch_ingress_num","<OUTPUT>"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"arrows":"to","smooth":{"enabled":false,"forceDirection":"vertical"}},"physics":{"stabilization":false}},"groups":null,"width":"50%","height":"400px","idselection":{"enabled":false},"byselection":{"enabled":false},"main":null,"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","igraphlayout":{"type":"full"}},"evals":[],"jsHooks":[]}</script><p>Predictions, as before (we can use <code>predict_newdata</code>
again):</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predictions</span> <span class="op">=</span> <span class="va">lr_sequential_full</span><span class="op">$</span><span class="fu">predict_newdata</span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_predictions</span><span class="op">(</span><span class="va">predictions</span><span class="op">)</span></span></code></pre></div>
<p><img src="internals_pipeop_torch_files/figure-html/unnamed-chunk-46-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="mixed-pipelines">Mixed Pipelines<a class="anchor" aria-label="anchor" href="#mixed-pipelines"></a>
</h3>
<p>We are not just limited to <code>PipeOpTorch</code> in these kinds of
<code>Graph</code>s, and we are also not limited to having only a single
<code>PipeOpTorchIngress</code>. The following pipeline, for example,
removes all but the <code>Petal.Length</code> columns from the
<code>Task</code> and fits a model:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"select"</span>, selector <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html" class="external-link">selector_name</a></span><span class="op">(</span><span class="st">"Petal.Length"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">5</span>, id <span class="op">=</span> <span class="st">"linear1"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_relu"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"linear2"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_softmax"</span>, dim <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_optimizer"</span>, optimizer <span class="op">=</span> <span class="va">adam</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_loss"</span>, loss <span class="op">=</span> <span class="va">xe</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_model_classif"</span>, batch_size <span class="op">=</span> <span class="fl">50</span>, epochs <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gr</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>html <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-10b3b7155e8045a1b2ad" style="width:50%;height:400px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-10b3b7155e8045a1b2ad">{"x":{"nodes":{"id":["select","torch_ingress_num","linear1","nn_relu","linear2","nn_softmax","torch_optimizer","torch_loss","<INPUT>","torch_model_classif","<OUTPUT>"],"label":["select","torch_ingress_num","linear1","nn_relu","linear2","nn_softmax","torch_optimizer","torch_loss","<INPUT>","torch_model_classif","<OUTPUT>"],"shape":["box","box","box","box","box","box","box","box","database","box","ellipse"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","rgba(0,204,102,0.2)","lightblue","rgba(255,51,51,0.2)"],"value":[1,1,1,1,1,1,1,1,0.8,1,0.8],"title":["<p>PipeOp: <b>select<\/b> (not trained)<br>values: <b>selector=<Selector><\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [Task,Task]<\/p>","<p>PipeOp: <b>torch_ingress_num<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>linear1<\/b> (not trained)<br>values: <b>out_features=5<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>nn_relu<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>linear2<\/b> (not trained)<br>values: <b>out_features=3<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>nn_softmax<\/b> (not trained)<br>values: <b>dim=2<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>torch_optimizer<\/b> (not trained)<br>values: <b>lr=0.02<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>torch_loss<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>Input:<br>Name: select.input<br>Train: Task<br>Predict: Task<\/p>","<p>PipeOp: <b>torch_model_classif<\/b> (not trained)<br>values: <b>epochs=50, device=auto, num_threads=1, num_interop_threads=1, seed=random, eval_freq=1, measures_train=<list>, measures_valid=<list>, patience=0, min_delta=0, batch_size=50, shuffle=TRUE, tensor_dataset=FALSE, jit_trace=FALSE<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,TaskClassif]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [NULL,PredictionClassif]<\/p>","<p>Output:<br>Name: torch_model_classif.output<br>Train: NULL<br>Predict: PredictionClassif<\/p>"],"x":[0,0,0,0,0,0,0,0,0,0,0],"y":[-0.8,-0.6,-0.4,-0.2,0,0.2,0.3999999999999999,0.6000000000000001,-1,0.8,1]},"edges":{"from":["select","torch_ingress_num","linear1","nn_relu","linear2","nn_softmax","torch_optimizer","torch_loss","<INPUT>","torch_model_classif"],"to":["torch_ingress_num","linear1","nn_relu","linear2","nn_softmax","torch_optimizer","torch_loss","torch_model_classif","select","<OUTPUT>"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"arrows":"to","smooth":{"enabled":false,"forceDirection":"vertical"}},"physics":{"stabilization":false}},"groups":null,"width":"50%","height":"400px","idselection":{"enabled":false},"byselection":{"enabled":false},"main":null,"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","igraphlayout":{"type":"full"}},"evals":[],"jsHooks":[]}</script><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html" class="external-link">as_learner</a></span><span class="op">(</span><span class="va">gr</span><span class="op">)</span></span>
<span><span class="va">lr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span><span class="va">predictions</span> <span class="op">=</span> <span class="va">lr</span><span class="op">$</span><span class="fu">predict_newdata</span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_predictions</span><span class="op">(</span><span class="va">predictions</span><span class="op">)</span></span></code></pre></div>
<p><img src="internals_pipeop_torch_files/figure-html/unnamed-chunk-48-1.png" width="700"></p>
<p>How about using <code>Petal.Length</code> and
<code>Sepal.Length</code> separately at first?</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/gunion.html" class="external-link">gunion</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"select"</span>, selector <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html" class="external-link">selector_name</a></span><span class="op">(</span><span class="st">"Petal.Length"</span><span class="op">)</span>, id <span class="op">=</span> <span class="st">"sel1"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num"</span>, id <span class="op">=</span> <span class="st">"ingress.petal"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"linear1"</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"select"</span>, selector <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html" class="external-link">selector_name</a></span><span class="op">(</span><span class="st">"Sepal.Length"</span><span class="op">)</span>, id <span class="op">=</span> <span class="st">"sel2"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num"</span>, id <span class="op">=</span> <span class="st">"ingress.sepal"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"linear2"</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_merge_cat"</span><span class="op">)</span>  <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_relu"</span>, id <span class="op">=</span> <span class="st">"act1"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"linear3"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_softmax"</span>, dim <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"act3"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_optimizer"</span>, optimizer <span class="op">=</span> <span class="va">adam</span>, lr <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_loss"</span>, loss <span class="op">=</span> <span class="va">xe</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_model_classif"</span>, batch_size <span class="op">=</span> <span class="fl">50</span>, epochs <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gr</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>html <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-4018eef1a407a0df6b52" style="width:50%;height:400px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-4018eef1a407a0df6b52">{"x":{"nodes":{"id":["sel1","ingress.petal","sel2","ingress.sepal","linear1","linear2","nn_merge_cat","act1","linear3","act3","torch_optimizer","torch_loss","<INPUT>","torch_model_classif","<OUTPUT>"],"label":["sel1","ingress.petal","sel2","ingress.sepal","linear1","linear2","nn_merge_cat","act1","linear3","act3","torch_optimizer","torch_loss","<INPUT>","torch_model_classif","<OUTPUT>"],"shape":["box","box","box","box","box","box","box","box","box","box","box","box","database","box","ellipse"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","rgba(0,204,102,0.2)","lightblue","rgba(255,51,51,0.2)"],"value":[1,1,1,1,1,1,1,1,1,1,1,1,0.8,1,0.8],"title":["<p>PipeOp: <b>sel1<\/b> (not trained)<br>values: <b>selector=<Selector><\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [Task,Task]<\/p>","<p>PipeOp: <b>ingress.petal<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>sel2<\/b> (not trained)<br>values: <b>selector=<Selector><\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [Task,Task]<\/p>","<p>PipeOp: <b>ingress.sepal<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>linear1<\/b> (not trained)<br>values: <b>out_features=3<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>linear2<\/b> (not trained)<br>values: <b>out_features=3<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>nn_merge_cat<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  ... [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>act1<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>linear3<\/b> (not trained)<br>values: <b>out_features=3<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>act3<\/b> (not trained)<br>values: <b>dim=2<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>torch_optimizer<\/b> (not trained)<br>values: <b>lr=0.1<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>PipeOp: <b>torch_loss<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelDescriptor,Task]<\/p>","<p>Input:<br>Name: sel1.input<br>Train: Task<br>Predict: Task<br>Input:<br>Name: sel2.input<br>Train: Task<br>Predict: Task<\/p>","<p>PipeOp: <b>torch_model_classif<\/b> (not trained)<br>values: <b>epochs=50, device=auto, num_threads=1, num_interop_threads=1, seed=random, eval_freq=1, measures_train=<list>, measures_valid=<list>, patience=0, min_delta=0, batch_size=50, shuffle=TRUE, tensor_dataset=FALSE, jit_trace=FALSE<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelDescriptor,TaskClassif]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [NULL,PredictionClassif]<\/p>","<p>Output:<br>Name: torch_model_classif.output<br>Train: NULL<br>Predict: PredictionClassif<\/p>"],"x":[-1,-1,1,1,-1,1,0,0,0,0,0,0,0,0,0],"y":[-0.8181818181818181,-0.6363636363636364,-0.8181818181818181,-0.6363636363636364,-0.4545454545454546,-0.4545454545454546,-0.2727272727272727,-0.09090909090909094,0.09090909090909083,0.2727272727272727,0.4545454545454546,0.6363636363636365,-1,0.8181818181818181,1]},"edges":{"from":["sel1","ingress.petal","sel2","ingress.sepal","linear1","linear2","nn_merge_cat","act1","linear3","act3","torch_optimizer","torch_loss","<INPUT>","<INPUT>","torch_model_classif"],"to":["ingress.petal","linear1","ingress.sepal","linear2","nn_merge_cat","nn_merge_cat","act1","linear3","act3","torch_optimizer","torch_loss","torch_model_classif","sel1","sel2","<OUTPUT>"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"arrows":"to","smooth":{"enabled":false,"forceDirection":"vertical"}},"physics":{"stabilization":false}},"groups":null,"width":"50%","height":"400px","idselection":{"enabled":false},"byselection":{"enabled":false},"main":null,"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","igraphlayout":{"type":"full"}},"evals":[],"jsHooks":[]}</script><div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html" class="external-link">as_learner</a></span><span class="op">(</span><span class="va">gr</span><span class="op">)</span></span>
<span><span class="va">lr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span><span class="va">predictions</span> <span class="op">=</span> <span class="va">lr</span><span class="op">$</span><span class="fu">predict_newdata</span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_predictions</span><span class="op">(</span><span class="va">predictions</span><span class="op">)</span></span></code></pre></div>
<p><img src="internals_pipeop_torch_files/figure-html/unnamed-chunk-50-1.png" width="700"></p>
<p>All these examples have hopefully demonstrated the possibilities that
come with the representation of neural network layers as
<code>PipeOp</code>s. Even though this vignette was quite technical, we
hope to have given you an in-depth understanding of the underlying
mechanisms.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sebastian Fischer, Martin Binder.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
