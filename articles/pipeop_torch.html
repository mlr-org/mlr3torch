<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mlr3torch">
<title>Building a Neural Network using PipeOps • mlr3torch</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.7/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.7/font.css" rel="stylesheet">
<link href="../deps/Roboto_Slab-0.4.7/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Building a Neural Network using PipeOps">
<meta property="og:description" content="mlr3torch">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mlr3torch</a>

    <small class="nav-text text-default me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">
    <span class="fa fa fa fa-file-alt"></span>
     
    Reference
  </a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/get_started.html">Get Started</a>
    <a class="dropdown-item" href="../articles/pipeop_torch.html">Building a Neural Network using PipeOps</a>
  </div>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://mlr3book.mlr-org.com">
    <span class="fa fa fa fa-link"></span>
     
    mlr3book
  </a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://lmmisld-lmu-stats-slds.srv.mwn.de/mlr_invite/">
    <span class="fa fa fa fa-comments"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://stackoverflow.com/questions/tagged/mlr3">
    <span class="fab fa fab fa-stack-overflow"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Building a Neural Network using PipeOps</h1>
            
      
      
      <div class="d-none name"><code>pipeop_torch.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"mlr3torch"</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="torch-modules-and-pipeopmodule">Torch modules and <code>PipeOpModule</code><a class="anchor" aria-label="anchor" href="#torch-modules-and-pipeopmodule"></a>
</h2>
<div class="section level3">
<h3 id="torch-primer">Torch Primer<a class="anchor" aria-label="anchor" href="#torch-primer"></a>
</h3>
<p>Some input tensor: 2-batch of 3 units.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">input</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  1.5146  0.0889  0.2255</span></span>
<span><span class="co">#&gt; -0.6077  0.5464  0.6399</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,3} ]</span></span></code></pre></div>
<p>A <code>nn_module</code> is constructed from a
<code>nn_module_generator</code>. <code>nn_linear</code> is one of the
simpler generators:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">module_1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span>, bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Applying this module gives a 2-batch of 4 units:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span> <span class="op">=</span> <span class="fu">module_1</span><span class="op">(</span><span class="va">input</span><span class="op">)</span></span>
<span><span class="va">output</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -0.3524 -1.0435  0.6613 -0.8602</span></span>
<span><span class="co">#&gt; -0.7366 -0.4073 -0.1048 -0.1381</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,4} ][ grad_fn = &lt;AddmmBackward0&gt; ]</span></span></code></pre></div>
<p>A neural network with one (4-unit) hidden layer and two outputs needs
the following ingredients</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">activation</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sigmoid.html" class="external-link">nn_sigmoid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">module_2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">3</span>, bias <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">softmax</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_softmax.html" class="external-link">nn_softmax</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>Piping a tensor through this:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span> <span class="op">=</span> <span class="fu">module_1</span><span class="op">(</span><span class="va">input</span><span class="op">)</span></span>
<span><span class="va">output</span> <span class="op">=</span> <span class="fu">activation</span><span class="op">(</span><span class="va">output</span><span class="op">)</span></span>
<span><span class="va">output</span> <span class="op">=</span> <span class="fu">module_2</span><span class="op">(</span><span class="va">output</span><span class="op">)</span></span>
<span><span class="va">output</span> <span class="op">=</span> <span class="fu">softmax</span><span class="op">(</span><span class="va">output</span><span class="op">)</span></span>
<span><span class="va">output</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  0.1473  0.6176  0.2352</span></span>
<span><span class="co">#&gt;  0.1597  0.5744  0.2658</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,3} ][ grad_fn = &lt;SoftmaxBackward0&gt; ]</span></span></code></pre></div>
<p>Training the neural network then consists of Toch keeping track of
what parameters were used to calculate <code>output</code> to calculate
gradients etc. In particular, this “piping through a series of modules”
will happen a lot. An obvious idea here is to do this with
<code>mlr3pipelines</code>.</p>
</div>
<div class="section level3">
<h3 id="wrapped-torch-modules-as-pipeopmodule">Wrapped Torch modules as <code>PipeOpModule</code><a class="anchor" aria-label="anchor" href="#wrapped-torch-modules-as-pipeopmodule"></a>
</h3>
<p>Wrapping <code>nn_module</code> objects in a <code>PipeOp</code> has
the advantage that the network structure can be represented as a
<code>Graph</code> object where it is made explicit (can be plotted, can
be extended or manipulated), compared to e.g. writing a function that
pipes input through a series of modules.</p>
<p>A <code>PipeOpModule</code> can be used to wrap a module directly,
but it is usually constructed by a <code>PipeOpTorch</code> (see later).
It typically has a single input and a single output, although multiple
inputs are possible (module is then called with multiple arguments), and
multiple outputs are possible when the module-function returns a list.
Number of outputs must be declared during construction, then.</p>
<p>Wrapping the linear <code>module_1</code> works like this:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">po_module_1</span> <span class="op">=</span> <span class="va"><a href="../reference/mlr_pipeops_module.html">PipeOpModule</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"module_1"</span>, <span class="va">module_1</span><span class="op">)</span></span></code></pre></div>
<p>It is used in the familiar way:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span> <span class="op">=</span> <span class="va">po_module_1</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">input</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">output</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -0.3524 -1.0435  0.6613 -0.8602</span></span>
<span><span class="co">#&gt; -0.7366 -0.4073 -0.1048 -0.1381</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,4} ][ grad_fn = &lt;AddmmBackward0&gt; ]</span></span></code></pre></div>
<p>Note we only use the <code>$train()</code>, since Torch modules do
not have anything that maps to the <code>state</code> (it is filled by
an empty list).</p>
<p>The single hidden layer neural network can be constructed as a
<code>Graph</code>, which can then do the training all at once.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">po_activation</span> <span class="op">=</span> <span class="va"><a href="../reference/mlr_pipeops_module.html">PipeOpModule</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"activation"</span>, <span class="va">activation</span><span class="op">)</span></span>
<span><span class="va">po_module_2</span> <span class="op">=</span> <span class="va"><a href="../reference/mlr_pipeops_module.html">PipeOpModule</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"module_2"</span>, <span class="va">module_2</span><span class="op">)</span></span>
<span><span class="va">po_softmax</span> <span class="op">=</span> <span class="va"><a href="../reference/mlr_pipeops_module.html">PipeOpModule</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"softmax"</span>, <span class="va">softmax</span><span class="op">)</span></span>
<span></span>
<span><span class="va">module_graph</span> <span class="op">=</span> <span class="va">po_module_1</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span> <span class="va">po_activation</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span> <span class="va">po_module_2</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span> <span class="va">po_softmax</span></span></code></pre></div>
<p>Using the <code>Graph</code>’s <code>$train()</code> to pipe a tensor
through the <code>Graph</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span> <span class="op">=</span> <span class="va">module_graph</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">input</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">output</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  0.1473  0.6176  0.2352</span></span>
<span><span class="co">#&gt;  0.1597  0.5744  0.2658</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,3} ][ grad_fn = &lt;SoftmaxBackward0&gt; ]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="graph-as-a-torch-module">
<code>Graph</code> as a Torch module<a class="anchor" aria-label="anchor" href="#graph-as-a-torch-module"></a>
</h3>
<p>The native class in <code>torch</code> that represents a
transformation of tensors is the <code>nn_module</code>. It would
therefore also be advantageous to have the <code>Graph</code> of
<code>PipeOpModule</code> also be a <code>nn_module</code>. This is
particularly useful because the <code>nn_module</code> does some
accounting of the model parameters that it contains for backpropagation
(I believe).</p>
<p>Instead of having a class that inherits both from
<code>nn_module</code> and <code>Graph</code> (which doesn’t work in R6,
since multiple inheritance is not available), there is a class that
inherits from <code>nn_module</code> and contains a <code>Graph</code>
member slot (composition). This class is [<code>nn_graph</code>]. It is
constructed with a <code>Graph</code>, as well as information about the
shape(s) of the <code>torch_tensor</code>(s) it expects as inputs.</p>
<p>Shape info is communicated as an integer-valued <code>numeric</code>
vector; dimensions that are arbitrary, e.g. batch-size, is given as
<code>NA</code>. Our network expects an input of shape
<code>c(NA, 3)</code>, since the first layer was created as
<code>nn_linear(in_features = 3)</code>. (Currently nothing is done with
this shape information, but it could in the future be used for asserts,
or maybe to concatenate <code>nn_graph</code>s.)</p>
<p>If the <code>Graph</code> has multiple outputs, it is also possible
to select a subset of outputs to use, or change the output order, by
giving the <code>output_map</code> argument.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># the name of the single input is:</span></span>
<span><span class="va">module_graph</span><span class="op">$</span><span class="va">input</span></span>
<span><span class="co">#&gt;              name        train predict    op.id channel.name</span></span>
<span><span class="co">#&gt; 1: module_1.input torch_tensor    NULL module_1        input</span></span>
<span></span>
<span><span class="va">graph_module</span> <span class="op">=</span> <span class="fu"><a href="../reference/nn_graph.html">nn_graph</a></span><span class="op">(</span></span>
<span>  <span class="va">module_graph</span>,</span>
<span>  shapes_in <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>module_1.input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This module gives us the convenience of torch <code>nn_module</code>
objects, e.g.:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph_module</span><span class="op">$</span><span class="va">children</span></span>
<span><span class="co">#&gt; $modules</span></span>
<span><span class="co">#&gt; An `nn_module` containing 31 parameters.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Modules ─────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • 0: &lt;nn_linear&gt; #16 parameters</span></span>
<span><span class="co">#&gt; • 1: &lt;nn_sigmoid&gt; #0 parameters</span></span>
<span><span class="co">#&gt; • 2: &lt;nn_linear&gt; #15 parameters</span></span>
<span><span class="co">#&gt; • 3: &lt;nn_softmax&gt; #0 parameters</span></span>
<span><span class="va">graph_module</span><span class="op">$</span><span class="va">parameters</span></span>
<span><span class="co">#&gt; $modules.0.weight</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  0.0886  0.0853 -0.5677</span></span>
<span><span class="co">#&gt; -0.3583 -0.4115  0.1546</span></span>
<span><span class="co">#&gt;  0.3164 -0.2066  0.0003</span></span>
<span><span class="co">#&gt; -0.4547 -0.5464  0.0174</span></span>
<span><span class="co">#&gt; [ CPUFloatType{4,3} ][ requires_grad = TRUE ]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $modules.0.bias</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -0.3661</span></span>
<span><span class="co">#&gt; -0.4992</span></span>
<span><span class="co">#&gt;  0.2003</span></span>
<span><span class="co">#&gt; -0.1269</span></span>
<span><span class="co">#&gt; [ CPUFloatType{4} ][ requires_grad = TRUE ]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $modules.2.weight</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  0.4125 -0.1952 -0.4436 -0.3401</span></span>
<span><span class="co">#&gt;  0.1883 -0.1992  0.4772 -0.3532</span></span>
<span><span class="co">#&gt; -0.1867 -0.3890 -0.3635 -0.1642</span></span>
<span><span class="co">#&gt; [ CPUFloatType{3,4} ][ requires_grad = TRUE ]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $modules.2.bias</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -0.4926</span></span>
<span><span class="co">#&gt;  0.4313</span></span>
<span><span class="co">#&gt;  0.1683</span></span>
<span><span class="co">#&gt; [ CPUFloatType{3} ][ requires_grad = TRUE ]</span></span></code></pre></div>
<p>And it can be used to transform tensors just as any other torch
<code>nn_module</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">graph_module</span><span class="op">(</span><span class="va">input</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  0.1473  0.6176  0.2352</span></span>
<span><span class="co">#&gt;  0.1597  0.5744  0.2658</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,3} ][ grad_fn = &lt;SoftmaxBackward0&gt; ]</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="building-torch-models-for-tasks-using-pipeoptorch">Building Torch Models for Tasks using <code>PipeOpTorch</code><a class="anchor" aria-label="anchor" href="#building-torch-models-for-tasks-using-pipeoptorch"></a>
</h2>
<div class="section level3">
<h3 id="modeldescriptor">
<code>ModelDescriptor</code><a class="anchor" aria-label="anchor" href="#modeldescriptor"></a>
</h3>
<p>The [<code>PipeOpModule</code>] represents anf <code>nn_module</code>
that is fixed for a specific tensor shape and which has no
hyperparameters. When constructing a neural network using these
operators, one has to take care to have the output shape of operations
match the input shapes of the following operations.</p>
<p>A complete <code>Graph</code> of matching
[<code>PipeOpModule</code>]s can be constructed using operators that
mostly inherit from [<code>PipeOpTorch</code>], making use of the <a href="#modeldescriptor"><code>ModelDescriptor</code></a> class. The <a href="#modeldescriptor"><code>ModelDescriptor</code></a> class contains
a <code>Graph</code> of [<code>PipeOpModule</code>] and some more
necessary meta-info. The [<code>PipeOpTorch</code>] transforms a <a href="#modeldescriptor"><code>ModelDescriptor</code></a> and adds more
[<code>PipeOpModule</code>]s to the <code>Graph</code>.</p>
<p><a href="#modeldescriptor"><code>ModelDescriptor</code></a>s always
build up a [<code>Graph</code>] for a specific [<code>Task</code>]. The
easiest way to initialize a proper <a href="#modeldescriptor"><code>ModelDescriptor</code></a> is to use the
appropriate [<code>PipeOpTorchIngress</code>] <code>PipeOp</code> for a
given datatype. <a href="#modeldescriptor"><code>ModelDescriptor</code></a>s always build
up a [<code>Graph</code>] for a specific [<code>Task</code>]. The
easiest way to initialize a proper <a href="#modeldescriptor"><code>ModelDescriptor</code></a> is to use the
appropriate [<code>PipeOpTorchIngress</code>] <code>PipeOp</code> for a
given datatype.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">tsk</a></span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">po_torch_in</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num"</span><span class="op">)</span></span>
<span><span class="va">md</span> <span class="op">=</span> <span class="va">po_torch_in</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">task</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">md</span></span>
<span><span class="co">#&gt; &lt;ModelDescriptor: 1 ops&gt;</span></span>
<span><span class="co">#&gt; * Ingress:  torch_ingress_num.input: [(NA,3)]</span></span>
<span><span class="co">#&gt; * Task:  iris [classif]</span></span>
<span><span class="co">#&gt; * Callbacks:  character(0)</span></span>
<span><span class="co">#&gt; * Optimizer:  N/A</span></span>
<span><span class="co">#&gt; * Loss:  N/A</span></span>
<span><span class="co">#&gt; * .pointer:  torch_ingress_num.output [(NA,3)]</span></span></code></pre></div>
<p>The <a href="#modeldescriptor"><code>ModelDescriptor</code></a> is an
S3 object that contains a [<code>Graph</code>], information about how to
generate data (<code>$ingress</code> and <code>$task</code>), some
further tags about how to build a model that are unrelated to
architecture (<code>$optimizer</code>, <code>$loss</code> and
<code>$callbacks</code>) as well as all further information necessary to
extend that graph along a given output (<code>$.pointer</code> and
<code>$.pointer_shape</code>).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">unclass</a></span><span class="op">(</span><span class="va">md</span><span class="op">)</span></span>
<span><span class="co">#&gt; $graph</span></span>
<span><span class="co">#&gt; Graph with 1 PipeOps:</span></span>
<span><span class="co">#&gt;                 ID         State sccssors prdcssors</span></span>
<span><span class="co">#&gt;  torch_ingress_num &lt;&lt;UNTRAINED&gt;&gt;                   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $ingress</span></span>
<span><span class="co">#&gt; $ingress$torch_ingress_num.input</span></span>
<span><span class="co">#&gt; Ingress: Task[Petal.Length,Sepal.Length,Sepal.Width] --&gt; Tensor(NA, 3)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $task</span></span>
<span><span class="co">#&gt; &lt;TaskClassif:iris&gt; (150 x 4): Iris Flowers</span></span>
<span><span class="co">#&gt; * Target: Species</span></span>
<span><span class="co">#&gt; * Properties: multiclass</span></span>
<span><span class="co">#&gt; * Features (3):</span></span>
<span><span class="co">#&gt;   - dbl (3): Petal.Length, Sepal.Length, Sepal.Width</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $optimizer</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $loss</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $callbacks</span></span>
<span><span class="co">#&gt; named list()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $.pointer</span></span>
<span><span class="co">#&gt; [1] "torch_ingress_num" "output"           </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $.pointer_shape</span></span>
<span><span class="co">#&gt; [1] NA  3</span></span></code></pre></div>
<p>The <code>$.pointer</code> identifies the output of the
<code>$graph</code> that [<code>PipeOpTorch</code>] will extend. Piping
this <a href="#modeldescriptor"><code>ModelDescriptor</code></a> through
[<code>PipeOpTorchLinear</code>], for example, adds a
[<code>PipeOpModule</code>] wrapping a <code>torch</code>
<code>nn_linear</code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">po_torch_linear</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">md</span> <span class="op">=</span> <span class="va">po_torch_linear</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">md</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">md</span><span class="op">$</span><span class="va">graph</span></span>
<span><span class="co">#&gt; Graph with 2 PipeOps:</span></span>
<span><span class="co">#&gt;                 ID         State  sccssors         prdcssors</span></span>
<span><span class="co">#&gt;  torch_ingress_num &lt;&lt;UNTRAINED&gt;&gt; nn_linear                  </span></span>
<span><span class="co">#&gt;          nn_linear &lt;&lt;UNTRAINED&gt;&gt;           torch_ingress_num</span></span></code></pre></div>
<p>The <code>$.pointer</code> is now updated to identify the output of
that [<code>PipeOpModule</code>], and the <code>$.pointer_shape</code>
shows that the shape has changed to 4 units (was 3 for the input
before).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">md</span><span class="op">$</span><span class="va">.pointer</span></span>
<span><span class="co">#&gt; [1] "nn_linear" "output"</span></span>
<span><span class="va">md</span><span class="op">$</span><span class="va">.pointer_shape</span></span>
<span><span class="co">#&gt; [1] NA  4</span></span></code></pre></div>
<p>The [<code><a href="../reference/model_descriptor_to_module.html">model_descriptor_to_module()</a></code>] function converts
this to an [<code>nn_graph</code>], it is a functional
<code>torch</code> <code>nn_module</code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">small_module</span> <span class="op">=</span> <span class="fu"><a href="../reference/model_descriptor_to_module.html">model_descriptor_to_module</a></span><span class="op">(</span><span class="va">md</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">md</span><span class="op">$</span><span class="va">.pointer</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">small_module</span><span class="op">(</span><span class="va">input</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -0.6429  1.0359  0.6019  0.6050</span></span>
<span><span class="co">#&gt; -0.1059  0.4350 -0.1580 -0.2520</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,4} ][ grad_fn = &lt;AddmmBackward0&gt; ]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="using-modeldescriptor-to-get-data">Using <a href="#modeldescriptor"><code>ModelDescriptor</code></a> to
get Data<a class="anchor" aria-label="anchor" href="#using-modeldescriptor-to-get-data"></a>
</h3>
<p>The <a href="#modeldescriptor"><code>ModelDescriptor</code></a> does
not only represent the <code>Graph</code> from which a
<code>nn_module</code> is created, but also the way in which the
<code>Task</code> is is processed to get input batches. A
<code>torch</code> <code>dataset</code> can be created by calling
<code><a href="../reference/task_dataset.html">task_dataset()</a></code>; both the <code>task</code> and the
<code>feature_ingress_tokens</code> arguments can be retrieved from the
<code>ModelDescriptor</code>. The <code>target_batchgetter</code> needs
to be created extra (if necessary), since it depends on the ultimate
machine learning model, which we have not looked at so far.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">td</span> <span class="op">=</span> <span class="fu"><a href="../reference/task_dataset.html">task_dataset</a></span><span class="op">(</span></span>
<span>  task <span class="op">=</span> <span class="va">md</span><span class="op">$</span><span class="va">task</span>,</span>
<span>  feature_ingress_tokens <span class="op">=</span> <span class="va">md</span><span class="op">$</span><span class="va">ingress</span>,</span>
<span>  device <span class="op">=</span> <span class="st">"cpu"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">td</span></span>
<span><span class="co">#&gt; &lt;dataset&gt;</span></span>
<span><span class="co">#&gt;   Public:</span></span>
<span><span class="co">#&gt;     .getbatch: function (index) </span></span>
<span><span class="co">#&gt;     .getitem: function (index) </span></span>
<span><span class="co">#&gt;     .length: function () </span></span>
<span><span class="co">#&gt;     all_features: Petal.Length Sepal.Length Sepal.Width Species</span></span>
<span><span class="co">#&gt;     clone: function (deep = FALSE) </span></span>
<span><span class="co">#&gt;     device: cpu</span></span>
<span><span class="co">#&gt;     feature_ingress_tokens: list</span></span>
<span><span class="co">#&gt;     initialize: function (task, feature_ingress_tokens, target_batchgetter = NULL, </span></span>
<span><span class="co">#&gt;     target_batchgetter: NULL</span></span>
<span><span class="co">#&gt;     task: TaskClassif, TaskSupervised, Task, R6</span></span></code></pre></div>
<p>Use the <code>$.getbatch()</code> method to get a batch that can be
given to the <code>nn_module</code>. Note it has an <code>$x</code> and
an <code>$y</code> slot, the latter of which is not used, to account for
possible target batches. The <code>$x</code> slot is also a
<code>list</code>, since it should be able to handle NNs with multiple
inputs (see below).</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">batch</span> <span class="op">=</span> <span class="va">td</span><span class="op">$</span><span class="fu">.getbatch</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">batch</span></span>
<span><span class="co">#&gt; $x</span></span>
<span><span class="co">#&gt; $x$torch_ingress_num.input</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  1.4000  5.1000  3.5000</span></span>
<span><span class="co">#&gt;  1.4000  4.9000  3.0000</span></span>
<span><span class="co">#&gt;  1.3000  4.7000  3.2000</span></span>
<span><span class="co">#&gt; [ CPUFloatType{3,3} ]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $y</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $.index</span></span>
<span><span class="co">#&gt; [1] 1 2 3</span></span>
<span></span>
<span><span class="fu">small_module</span><span class="op">(</span><span class="va">batch</span><span class="op">$</span><span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  2.3259  4.8486  2.4155 -0.8957</span></span>
<span><span class="co">#&gt;  2.1737  4.5724  2.1927 -0.7462</span></span>
<span><span class="co">#&gt;  2.0985  4.4805  2.2050 -0.8021</span></span>
<span><span class="co">#&gt; [ CPUFloatType{3,4} ][ grad_fn = &lt;AddmmBackward0&gt; ]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="building-sequential-nns">Building sequential NNs<a class="anchor" aria-label="anchor" href="#building-sequential-nns"></a>
</h3>
<p>The sequential NN from above can easily be implemented as
follows:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph_generator</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">4</span>, id <span class="op">=</span> <span class="st">"linear1"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_sigmoid"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"linear2"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_softmax"</span>, dim <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>Note how the second <code>nn_linear</code> does not need to be
informed about the output dimension of the first <code>nn_linear</code>,
since the <a href="#modeldescriptor"><code>ModelDescriptor</code></a>
that is passed along the <code>Graph</code> edges knows this info (in
the <code>$.pointer_shape</code> slot).</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">md_sequential</span> <span class="op">=</span> <span class="va">graph_generator</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">graph_module</span> <span class="op">=</span> <span class="fu"><a href="../reference/model_descriptor_to_module.html">model_descriptor_to_module</a></span><span class="op">(</span><span class="va">md_sequential</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">md_sequential</span><span class="op">$</span><span class="va">.pointer</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">graph_module</span><span class="op">(</span><span class="va">input</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  0.2968  0.2987  0.4045</span></span>
<span><span class="co">#&gt;  0.3355  0.2734  0.3912</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,3} ][ grad_fn = &lt;SoftmaxBackward0&gt; ]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="building-more-interesting-nns">Building more interesting NNs<a class="anchor" aria-label="anchor" href="#building-more-interesting-nns"></a>
</h3>
<p>The selling-point of <code>mlr3pipelines</code> is its ability to
easily represent computational <code>Graph</code>s. The <a href="#modeldescriptor"><code>ModelDescriptor</code></a> /
[<code>PipeOpTorch</code>] setup is built to make full use of this
functionality. It is possible to have multiple inputs into a NN by using
multiple [<code>PipeOpTorchIngress</code>] inputs, it is possible to
have parallel and alternative path branching, and it is possible to have
multiple outputs.</p>
<p>Consider the following (a bit nonsensical) network that operates
differently on the <code>"Petal"</code> than on the <code>"Sepal"</code>
features of <code>tsk("iris")</code>. We manually split the task here,
further down it is shown that the wholly integrated
<code>mlr3pipelines</code> pipeline can do this automatically.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_petal</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">tsk</a></span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Petal.Length"</span>, <span class="st">"Petal.Width"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">iris_sepal</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">tsk</a></span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sepal.Length"</span>, <span class="st">"Sepal.Width"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph_sepal</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num"</span>, id <span class="op">=</span> <span class="st">"sepal.in"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">4</span>, id <span class="op">=</span> <span class="st">"linear1"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">graph_petal</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num"</span>, id <span class="op">=</span> <span class="st">"petal.in"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"linear2"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_tanh"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">5</span>, id <span class="op">=</span> <span class="st">"linear3"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">graph_common</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/ppl.html" class="external-link">ppl</a></span><span class="op">(</span><span class="st">"branch"</span>, graphs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    sigmoid <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_sigmoid"</span><span class="op">)</span>,</span>
<span>    relu <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_relu"</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/gunion.html" class="external-link">gunion</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">1</span>, id <span class="op">=</span> <span class="st">"lin_out"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"cat_out"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_softmax"</span>, dim <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">graph_iris</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/gunion.html" class="external-link">gunion</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">graph_sepal</span>, <span class="va">graph_petal</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_merge_cat"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="va">graph_common</span></span>
<span></span>
<span><span class="va">graph_iris</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="pipeop_torch_files/figure-html/unnamed-chunk-25-1.png" width="700"></p>
<p>We can use this to create a neural network for the <code>iris</code>
tasks we created above. We set the <code>$keep_results</code> debug flag
here so we can do some inspection about what is happening:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph_iris</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">branch.selection</span> <span class="op">=</span> <span class="st">"relu"</span></span>
<span></span>
<span><span class="va">graph_iris</span><span class="op">$</span><span class="va">keep_results</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span></span>
<span><span class="va">iris_mds</span> <span class="op">=</span> <span class="va">graph_iris</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span></span>
<span>  input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sepal.in.input <span class="op">=</span> <span class="va">iris_sepal</span>, petal.in.input <span class="op">=</span> <span class="va">iris_petal</span><span class="op">)</span>,</span>
<span>  single_input <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">iris_mds</span></span>
<span><span class="co">#&gt; $lin_out.output</span></span>
<span><span class="co">#&gt; &lt;ModelDescriptor: 11 ops&gt;</span></span>
<span><span class="co">#&gt; * Ingress:  sepal.in.input: [(NA,2)], petal.in.input: [(NA,2)]</span></span>
<span><span class="co">#&gt; * Task:  iris [classif]</span></span>
<span><span class="co">#&gt; * Callbacks:  character(0)</span></span>
<span><span class="co">#&gt; * Optimizer:  N/A</span></span>
<span><span class="co">#&gt; * Loss:  N/A</span></span>
<span><span class="co">#&gt; * .pointer:  lin_out.output [(NA,1)]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nn_softmax.output</span></span>
<span><span class="co">#&gt; &lt;ModelDescriptor: 11 ops&gt;</span></span>
<span><span class="co">#&gt; * Ingress:  sepal.in.input: [(NA,2)], petal.in.input: [(NA,2)]</span></span>
<span><span class="co">#&gt; * Task:  iris [classif]</span></span>
<span><span class="co">#&gt; * Callbacks:  character(0)</span></span>
<span><span class="co">#&gt; * Optimizer:  N/A</span></span>
<span><span class="co">#&gt; * Loss:  N/A</span></span>
<span><span class="co">#&gt; * .pointer:  nn_softmax.output [(NA,3)]</span></span></code></pre></div>
<p>We make multiple observations here:</p>
<ol style="list-style-type: decimal">
<li>
<p>We can observe how the <a href="#modeldescriptor"><code>ModelDescriptor</code></a> grows as it is
passed along the edges of <code>graph_iris</code>. Note that the
<code>$graph</code> slot of that <a href="#modeldescriptor"><code>ModelDescriptor</code></a> is often
updated by-reference, so by the time we inspect intermediate results,
they may contain the complete graph. However, see how the
<code>$ingress</code>, <code>$.pointer</code> and
<code>$.pointer_shape</code> of the <a href="#modeldescriptor"><code>ModelDescriptor</code></a>s that take the
<code>sepal.in</code>-path differ from the ones that take the
<code>petal.in</code>-path:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># sepal.in path</span></span>
<span><span class="va">graph_iris</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">linear1</span><span class="op">$</span><span class="va">.result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ingress</span></span>
<span><span class="co">#&gt; $sepal.in.input</span></span>
<span><span class="co">#&gt; Ingress: Task[Sepal.Length,Sepal.Width] --&gt; Tensor(NA, 2)</span></span>
<span><span class="va">graph_iris</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">linear1</span><span class="op">$</span><span class="va">.result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">.pointer</span></span>
<span><span class="co">#&gt; [1] "linear1" "output"</span></span>
<span><span class="va">graph_iris</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">linear1</span><span class="op">$</span><span class="va">.result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">.pointer_shape</span></span>
<span><span class="co">#&gt; [1] NA  4</span></span>
<span></span>
<span><span class="co"># petal.in path</span></span>
<span><span class="va">graph_iris</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">linear3</span><span class="op">$</span><span class="va">.result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ingress</span></span>
<span><span class="co">#&gt; $petal.in.input</span></span>
<span><span class="co">#&gt; Ingress: Task[Petal.Length,Petal.Width] --&gt; Tensor(NA, 2)</span></span>
<span><span class="va">graph_iris</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">linear3</span><span class="op">$</span><span class="va">.result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">.pointer</span></span>
<span><span class="co">#&gt; [1] "linear3" "output"</span></span>
<span><span class="va">graph_iris</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">linear3</span><span class="op">$</span><span class="va">.result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">.pointer_shape</span></span>
<span><span class="co">#&gt; [1] NA  5</span></span></code></pre></div>
<p><code>po("nn_merge_cat")</code> unites the two <a href="#modeldescriptor"><code>ModelDescriptor</code></a>s and contains
the common ingress. The <code>.pointer_shape</code> now reflects the
output of the “cat”-operation: the 2nd dimension is added up:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph_iris</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">nn_merge_cat</span><span class="op">$</span><span class="va">.result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ingress</span></span>
<span><span class="co">#&gt; $sepal.in.input</span></span>
<span><span class="co">#&gt; Ingress: Task[Sepal.Length,Sepal.Width] --&gt; Tensor(NA, 2)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $petal.in.input</span></span>
<span><span class="co">#&gt; Ingress: Task[Petal.Length,Petal.Width] --&gt; Tensor(NA, 2)</span></span>
<span><span class="va">graph_iris</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">nn_merge_cat</span><span class="op">$</span><span class="va">.result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">.pointer_shape</span></span>
<span><span class="co">#&gt; [1] NA  9</span></span></code></pre></div>
</li>
<li>
<p>Multiple <a href="#modeldescriptor"><code>ModelDescriptor</code></a>s were created,
since the <code>graph_iris</code> has multiple outpus. This makes it
possible to create a neural network with multiple outputs. We need to
unite the outputs of <code>graph_iris</code> using
[<code><a href="../reference/model_descriptor_union.html">model_descriptor_union()</a></code>] before we can pass it to
[<code><a href="../reference/model_descriptor_to_module.html">model_descriptor_to_module()</a></code>]. We need to collect all
<code>output_pointers</code> separately.</p>
<p><code>list_output</code> must be set to <code>TRUE</code> since the
module has multiple outputs.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_mds_union</span> <span class="op">=</span> <span class="fu"><a href="../reference/model_descriptor_union.html">model_descriptor_union</a></span><span class="op">(</span><span class="va">iris_mds</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">iris_mds</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">output_pointers</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">iris_mds</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">.pointer</span>, <span class="va">iris_mds</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">.pointer</span><span class="op">)</span></span>
<span><span class="va">output_pointers</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] "lin_out" "output" </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] "nn_softmax" "output"</span></span>
<span><span class="va">iris_module</span> <span class="op">=</span> <span class="fu"><a href="../reference/model_descriptor_to_module.html">model_descriptor_to_module</a></span><span class="op">(</span><span class="va">iris_mds_union</span>, <span class="va">output_pointers</span>, list_output <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p>The <code>PipeOpBranch</code> disappears in the resulting
<code>Graph</code> of [<code>PipeOpModule</code>] in the
<code>iris_module</code>. This is because only the
[<code>PipeOpTorch</code>]s in the <code>graph_iris</code> add anything
to the <a href="#modeldescriptor"><code>ModelDescriptor</code></a>s. The
branch is interpeted when <code>graph_iris</code> runs, and only the
<code>nn_relu</code> path is followed. The <code>iris_module</code>
therefore contains a <code>Graph</code> that does “relu” activation:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_module</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="pipeop_torch_files/figure-html/unnamed-chunk-30-1.png" width="700"></p>
</li>
<li>
<p>The <a href="#modeldescriptor"><code>ModelDescriptor</code></a>’s
<code>$task</code> slot contains a <code>Task</code> with all features
that are used to create the input data for all NN inputs. It can be
given to <code><a href="../reference/task_dataset.html">task_dataset()</a></code>, along with the
<code>$ingress</code>, to create a <code>torch</code>
<code>dataset</code> that creates all batches. As above, any output of
<code>graph_iris</code> can be used:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_mds_union</span><span class="op">$</span><span class="va">task</span>  <span class="co"># contains all features</span></span>
<span><span class="co">#&gt; &lt;TaskClassif:iris&gt; (150 x 5): Iris Flowers</span></span>
<span><span class="co">#&gt; * Target: Species</span></span>
<span><span class="co">#&gt; * Properties: multiclass</span></span>
<span><span class="co">#&gt; * Features (4):</span></span>
<span><span class="co">#&gt;   - dbl (4): Petal.Length, Petal.Width, Sepal.Length, Sepal.Width</span></span>
<span></span>
<span><span class="va">iris_td</span> <span class="op">=</span> <span class="fu"><a href="../reference/task_dataset.html">task_dataset</a></span><span class="op">(</span></span>
<span>  task <span class="op">=</span> <span class="va">iris_mds_union</span><span class="op">$</span><span class="va">task</span>,</span>
<span>  feature_ingress_tokens <span class="op">=</span> <span class="va">iris_mds_union</span><span class="op">$</span><span class="va">ingress</span>,</span>
<span>  device <span class="op">=</span> <span class="st">"cpu"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">batch</span> <span class="op">=</span> <span class="va">iris_td</span><span class="op">$</span><span class="fu">.getbatch</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">batch</span></span>
<span><span class="co">#&gt; $x</span></span>
<span><span class="co">#&gt; $x$sepal.in.input</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  5.1000  3.5000</span></span>
<span><span class="co">#&gt;  4.9000  3.0000</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,2} ]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $x$petal.in.input</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  1.4000  0.2000</span></span>
<span><span class="co">#&gt;  1.4000  0.2000</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,2} ]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $y</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $.index</span></span>
<span><span class="co">#&gt; [1] 1 2</span></span></code></pre></div>
</li>
<li>
<p>The resulting module has multiple inputs and multiple outputs. We
call it with the first two rows of iris, but set the debug
<code>$keep_results</code> flag so we can inspect what is happening in
the <code>nn_module</code>’s <code>$graph</code>:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_module</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">keep_results</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span></span>
<span><span class="fu">iris_module</span><span class="op">(</span></span>
<span>  sepal.in.input <span class="op">=</span> <span class="va">batch</span><span class="op">$</span><span class="va">x</span><span class="op">$</span><span class="va">sepal.in.input</span>,</span>
<span>  petal.in.input <span class="op">=</span> <span class="va">batch</span><span class="op">$</span><span class="va">x</span><span class="op">$</span><span class="va">petal.in.input</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; $lin_out.output</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; 0.01 *</span></span>
<span><span class="co">#&gt; -8.5853</span></span>
<span><span class="co">#&gt;  -8.5853</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,1} ][ grad_fn = &lt;AddmmBackward0&gt; ]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nn_softmax.output</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  0.4056  0.3444  0.2500</span></span>
<span><span class="co">#&gt;  0.4056  0.3444  0.2500</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,3} ][ grad_fn = &lt;SoftmaxBackward0&gt; ]</span></span></code></pre></div>
<p>The first linear layer that takes “Sepal” input
(<code>"linear1"</code>) creates a 2x4 tensor (batch size 2, 4 units),
while the <code>"linear3"</code> layer has 2x5 output:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_module</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">linear1</span><span class="op">$</span><span class="va">.result</span></span>
<span><span class="co">#&gt; $output</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -3.8534 -1.2431 -0.5166 -3.0000</span></span>
<span><span class="co">#&gt; -3.7065 -1.0771 -0.3874 -2.8870</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,4} ][ grad_fn = &lt;AddmmBackward0&gt; ]</span></span>
<span><span class="va">iris_module</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">linear3</span><span class="op">$</span><span class="va">.result</span></span>
<span><span class="co">#&gt; $output</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -0.8881  0.4973 -1.1199  0.1610 -0.3165</span></span>
<span><span class="co">#&gt; -0.8881  0.4973 -1.1199  0.1610 -0.3165</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,5} ][ grad_fn = &lt;AddmmBackward0&gt; ]</span></span></code></pre></div>
<p>We observe that the <code>po("nn_merge_cat")</code> concatenates
these, as expected:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_module</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">nn_merge_cat</span><span class="op">$</span><span class="va">.result</span></span>
<span><span class="co">#&gt; $output</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -3.8534 -1.2431 -0.5166 -3.0000 -0.8881  0.4973 -1.1199  0.1610 -0.3165</span></span>
<span><span class="co">#&gt; -3.7065 -1.0771 -0.3874 -2.8870 -0.8881  0.4973 -1.1199  0.1610 -0.3165</span></span>
<span><span class="co">#&gt; [ CPUFloatType{2,9} ][ grad_fn = &lt;CatBackward0&gt; ]</span></span></code></pre></div>
</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="building-torch-learners">Building Torch Learners<a class="anchor" aria-label="anchor" href="#building-torch-learners"></a>
</h2>
<div class="section level3">
<h3 id="optimizer-and-loss">Optimizer and Loss<a class="anchor" aria-label="anchor" href="#optimizer-and-loss"></a>
</h3>
<p>We have now seen how NN <code>Graph</code>s of
[<code>PipeOpModule</code>] are created and turned into
<code>nn_module</code>s. Using [<code>PipeOpTorch</code>] even creates
<a href="#modeldescriptor"><code>ModelDescriptor</code></a> objects that
contain additional info about how batch tensors are extracted from
<code>Task</code>s. For a complete <code>Learner</code>, it is still
necessary to define the loss-function used for optimization, and the
optimizer itself.</p>
<p>Optimizers are represented as [<code>TorchOptimizer</code>] objects –
they wrap a <code>torch</code> <code>torch_optimizer_generator</code>
object but also provide a <code>ParamSet</code>. They can be obtained
from a <code>Dictionary</code> using the <code>t_opt</code> quick-access
function.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">adam</span> <span class="op">=</span> <span class="fu"><a href="../reference/t_opt.html">t_opt</a></span><span class="op">(</span><span class="st">"adam"</span>, lr <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span><span class="va">adam</span></span>
<span><span class="co">#&gt; &lt;TorchOptimizer:adam&gt; Adaptive Moment Estimation</span></span>
<span><span class="co">#&gt; * Generator: optim_adam</span></span>
<span><span class="co">#&gt; * Parameters: lr=0.02</span></span>
<span><span class="co">#&gt; * Packages: torch</span></span>
<span><span class="va">adam</span><span class="op">$</span><span class="va">param_set</span></span>
<span><span class="co">#&gt; &lt;ParamSet&gt;</span></span>
<span><span class="co">#&gt;              id    class lower upper nlevels     default value</span></span>
<span><span class="co">#&gt; 1:           lr ParamDbl 0e+00   Inf     Inf       0.001  0.02</span></span>
<span><span class="co">#&gt; 2:        betas ParamUty    NA    NA     Inf 0.900,0.999      </span></span>
<span><span class="co">#&gt; 3:          eps ParamDbl 1e-16 1e-04     Inf       1e-08      </span></span>
<span><span class="co">#&gt; 4: weight_decay ParamDbl 0e+00 1e+00     Inf           0      </span></span>
<span><span class="co">#&gt; 5:      amsgrad ParamLgl    NA    NA       2       FALSE</span></span></code></pre></div>
<p>Loss-functions work the same: [<code>TorchLoss</code>] are obtained
from a <code>Dictionary</code> using <code><a href="../reference/t_loss.html">t_loss()</a></code> and they have
<code>ParamSet</code>s.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xe</span> <span class="op">=</span> <span class="fu"><a href="../reference/t_loss.html">t_loss</a></span><span class="op">(</span><span class="st">"cross_entropy"</span><span class="op">)</span></span>
<span><span class="va">xe</span></span>
<span><span class="co">#&gt; &lt;TorchLoss:cross_entropy&gt; Cross Entropy</span></span>
<span><span class="co">#&gt; * Generator: nn_cross_entropy_loss</span></span>
<span><span class="co">#&gt; * Parameters: list()</span></span>
<span><span class="co">#&gt; * Packages: torch</span></span>
<span><span class="co">#&gt; * Task Types: classif</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="learnertorchmodel">[<code>LearnerTorchModel</code>]<a class="anchor" aria-label="anchor" href="#learnertorchmodel"></a>
</h3>
<p>[<code>LearnerTorchModel</code>] represents a supervised model
(regression or classification) using <code>torch</code> NNs. It needs a
<code>nn_module</code>, as well as a list of
[<code>TorchIngressToken</code>] that define how batches are created
from a <code>Task</code>. [<code>TorchIngressToken</code>] hard-code the
column-names of a <code>Task</code> that are used for data-input, the
<code>Learner</code> created like this therefore only works for the
specific <code>Task</code> created. (Generally the full
<code>mlr3pipelines</code>-UI should be used if this is a problem, see
below.) The following uses the sequential NN from above:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr_sequential</span> <span class="op">=</span> <span class="va"><a href="../reference/mlr_learners_torch_model.html">LearnerTorchModel</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  task_type <span class="op">=</span> <span class="st">"classif"</span>,</span>
<span>  network <span class="op">=</span> <span class="fu"><a href="../reference/model_descriptor_to_module.html">model_descriptor_to_module</a></span><span class="op">(</span><span class="va">md_sequential</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">md_sequential</span><span class="op">$</span><span class="va">.pointer</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  ingress_tokens <span class="op">=</span> <span class="va">md_sequential</span><span class="op">$</span><span class="va">ingress</span>,</span>
<span>  optimizer <span class="op">=</span> <span class="va">adam</span>,</span>
<span>  callbacks <span class="op">=</span> <span class="fu"><a href="../reference/t_clbk.html">t_clbk</a></span><span class="op">(</span><span class="st">"progress"</span><span class="op">)</span>,</span>
<span>  loss <span class="op">=</span> <span class="va">xe</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">lr_sequential</span></span>
<span><span class="co">#&gt; &lt;LearnerTorchModel[classif]:classif.model&gt;: Torch Model</span></span>
<span><span class="co">#&gt; * Model: -</span></span>
<span><span class="co">#&gt; * Optimizer: adam</span></span>
<span><span class="co">#&gt; * Loss: cross_entropy</span></span>
<span><span class="co">#&gt; * Callbacks: -</span></span>
<span><span class="co">#&gt; * Parameters: device=auto, measures_train=&lt;list&gt;,</span></span>
<span><span class="co">#&gt;   measures_valid=&lt;list&gt;, num_threads=1, drop_last=FALSE, shuffle=TRUE,</span></span>
<span><span class="co">#&gt;   seed=random, opt.lr=0.02</span></span>
<span><span class="co">#&gt; * Packages: mlr3, mlr3torch, torch</span></span>
<span><span class="co">#&gt; * Predict Types:  [response], prob</span></span>
<span><span class="co">#&gt; * Feature Types: logical, integer, numeric, character, factor, ordered,</span></span>
<span><span class="co">#&gt;   POSIXct, imageuri</span></span>
<span><span class="co">#&gt; * Properties: featureless, hotstart_backward, hotstart_forward,</span></span>
<span><span class="co">#&gt;   importance, loglik, missings, multiclass, oob_error,</span></span>
<span><span class="co">#&gt;   selected_features, twoclass, weights</span></span></code></pre></div>
<p>Before training the model, we set some more hyperparameters. Among
others, we use a [<code>TorchCallback</code>] that prints progress and
validation losses that we request.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr_sequential</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="fu">set_values</span><span class="op">(</span></span>
<span>  batch_size <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  epochs <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  measures_train <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">msrs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"classif.logloss"</span>, <span class="st">"classif.ce"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># This is required to evaluate the logloss during training</span></span>
<span><span class="va">lr_sequential</span><span class="op">$</span><span class="va">predict_type</span> <span class="op">=</span> <span class="st">"prob"</span></span>
<span></span>
<span><span class="va">lr_sequential</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">md_sequential</span><span class="op">$</span><span class="va">task</span><span class="op">)</span></span></code></pre></div>
<p>The following calls the <code>$predict_newdata</code> function to
plot the response surface along the
<code>Sepal.Width = mean(Sepal.Width)</code> plane, along with the
ground-truth values:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://r-datatable.com" class="external-link">"data.table"</a></span><span class="op">)</span></span>
<span><span class="va">newdata</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>Sepal.Width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Width</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/J.html" class="external-link">CJ</a></span><span class="op">(</span></span>
<span>  Sepal.Length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>,</span>
<span>  Petal.Length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Petal.Length</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Petal.Length</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">predictions</span> <span class="op">=</span> <span class="va">lr_sequential</span><span class="op">$</span><span class="fu">predict_newdata</span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org" class="external-link">"ggplot2"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_predictions</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">predictions</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">newdata</span>, Species <span class="op">=</span> <span class="va">predictions</span><span class="op">$</span><span class="va">response</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Sepal.Length</span>, y <span class="op">=</span> <span class="va">Petal.Length</span>, fill <span class="op">=</span> <span class="va">Species</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">iris</span>,</span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Sepal.Length</span>, y <span class="op">=</span> <span class="va">Petal.Length</span>, fill <span class="op">=</span> <span class="va">Species</span><span class="op">)</span>,</span>
<span>      color <span class="op">=</span> <span class="st">"black"</span>, pch <span class="op">=</span> <span class="fl">21</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">plot_predictions</span><span class="op">(</span><span class="va">predictions</span><span class="op">)</span></span></code></pre></div>
<p><img src="pipeop_torch_files/figure-html/unnamed-chunk-39-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="torch-learner-pipelines">Torch Learner Pipelines<a class="anchor" aria-label="anchor" href="#torch-learner-pipelines"></a>
</h2>
<p>The model shown above is constructed using the <a href="#modeldescriptor"><code>ModelDescriptor</code></a> that is
generated from a <code>Graph</code> of [<code>PipeOpTorch</code>]
operators. The model shown above is constructed using the <a href="#modeldescriptor"><code>ModelDescriptor</code></a> that is
generated from a <code>Graph</code> of [<code>PipeOpTorch</code>]
operators. The <a href="#modeldescriptor"><code>ModelDescriptor</code></a> furthermore
contains the <code>Task</code> to which it pertains. This makes it
possible to use it to create a NN model that gets trained right away,
using [<code>PipeOpTorchModelClassif</code>]. The only missing
prerequisite now is to add the desired [<code>TorchOptimizer</code>] and
[<code>TorchLoss</code>] information to the <a href="#modeldescriptor"><code>ModelDescriptor</code></a>.</p>
<div class="section level3">
<h3 id="adding-optimizer-loss-and-callback-meta-info-to-modeldescriptor">Adding Optimizer, Loss and Callback Meta-Info to <a href="#modeldescriptor"><code>ModelDescriptor</code></a><a class="anchor" aria-label="anchor" href="#adding-optimizer-loss-and-callback-meta-info-to-modeldescriptor"></a>
</h3>
<p>Remember that <a href="#modeldescriptor"><code>ModelDescriptor</code></a> has the
<code>$optimizer</code>, <code>$loss</code> and <code>$callbacks</code>
slots that are necessary to build a complete <code>Learner</code> from
an NN. They can be set by corresponding [<code>PipeOpTorch</code>]
operators.</p>
<p><code>po("torch_optimizer")</code> is used to set the
<code>$optimizer</code> slot of a <a href="#modeldescriptor"><code>ModelDescriptor</code></a>; it takes the
desired [<code>DescriptorTorchOptimizer</code>] object on construction
and exports its <code>ParamSet</code>.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">po_adam</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_optimizer"</span>, optimizer <span class="op">=</span> <span class="va">adam</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># hyperparameters are made available and can be changed:</span></span>
<span><span class="va">po_adam</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span></span>
<span><span class="co">#&gt; $lr</span></span>
<span><span class="co">#&gt; [1] 0.02</span></span>
<span></span>
<span><span class="va">md_sequential</span> <span class="op">=</span> <span class="va">po_adam</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">md_sequential</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">md_sequential</span><span class="op">$</span><span class="va">optimizer</span></span>
<span><span class="co">#&gt; &lt;TorchOptimizer:adam&gt; Adaptive Moment Estimation</span></span>
<span><span class="co">#&gt; * Generator: optim_adam</span></span>
<span><span class="co">#&gt; * Parameters: lr=0.02</span></span>
<span><span class="co">#&gt; * Packages: torch</span></span></code></pre></div>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">po_xe</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_loss"</span>, loss <span class="op">=</span> <span class="va">xe</span><span class="op">)</span></span>
<span><span class="va">md_sequential</span> <span class="op">=</span> <span class="va">po_xe</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">md_sequential</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">md_sequential</span><span class="op">$</span><span class="va">loss</span></span>
<span><span class="co">#&gt; &lt;TorchLoss:cross_entropy&gt; Cross Entropy</span></span>
<span><span class="co">#&gt; * Generator: nn_cross_entropy_loss</span></span>
<span><span class="co">#&gt; * Parameters: list()</span></span>
<span><span class="co">#&gt; * Packages: torch</span></span>
<span><span class="co">#&gt; * Task Types: classif</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="combined-instantiation-and-training-of-learnertorchmodel">Combined Instantiation and Training of
[<code>LearnerTorchModel</code>]<a class="anchor" aria-label="anchor" href="#combined-instantiation-and-training-of-learnertorchmodel"></a>
</h3>
<p>The <a href="#modeldescriptor"><code>ModelDescriptor</code></a> can
now be given to a <code>po("torch_model_classif")</code>.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">po_model</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_model_classif"</span>, batch_size <span class="op">=</span> <span class="fl">50</span>, epochs <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="va">po_model</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">md_sequential</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $output</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p><code>po("torch_model_classif")</code> behaves similarly to a
<code>PipeOpLearner</code>: It returns <code>NULL</code> during
training, and the prediction on <code>$predict()</code>.
<code>po("torch_model_classif")</code> behaves similarly to a
<code>PipeOpLearner</code>: It returns <code>NULL</code> during
training, and the prediction on <code>$predict()</code>.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">newtask</span> <span class="op">=</span> <span class="va"><a href="https://mlr3.mlr-org.com/reference/TaskClassif.html" class="external-link">TaskClassif</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"newdata"</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">newdata</span>, Species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="cn">NA</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, target <span class="op">=</span> <span class="st">"Species"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">predictions</span> <span class="op">=</span> <span class="va">po_model</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">newtask</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="fu">plot_predictions</span><span class="op">(</span><span class="va">predictions</span><span class="op">)</span></span></code></pre></div>
<p><img src="pipeop_torch_files/figure-html/unnamed-chunk-43-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="the-whole-pipeline">The whole Pipeline<a class="anchor" aria-label="anchor" href="#the-whole-pipeline"></a>
</h3>
<p>Remember that <code>md_sequential</code> was created using a
<code>Graph</code> that the initial <code>Task</code> was piped through.
If we combine such a <code>Graph</code> with
[<code>PipeOpTorchModelClassif</code>], we get a <code>Graph</code> that
behaves like any other <code>Graph</code> that ends with a
<code>PipeOpLearner</code>, and can therefore be wrapped as a
<code>GraphLearner</code>. The following uses one more hidden layer than
before:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph_sequential_full</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">4</span>, id <span class="op">=</span> <span class="st">"linear1"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_sigmoid"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"linear2"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_softmax"</span>, dim <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"softmax"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"linear3"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_softmax"</span>, dim <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"softmax2"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_optimizer"</span>, optimizer <span class="op">=</span> <span class="va">adam</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_loss"</span>, loss <span class="op">=</span> <span class="va">xe</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_model_classif"</span>, batch_size <span class="op">=</span> <span class="fl">50</span>, epochs <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">lr_sequential_full</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html" class="external-link">as_learner</a></span><span class="op">(</span><span class="va">graph_sequential_full</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lr_sequential_full</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span></code></pre></div>
<p>Compare the resulting <code>Graph</code></p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph_sequential_full</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="pipeop_torch_files/figure-html/unnamed-chunk-45-1.png" width="700"></p>
<p>With the <code>Graph</code> of the trained model:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">=</span> <span class="va">lr_sequential_full</span><span class="op">$</span><span class="va">graph_model</span><span class="op">$</span><span class="va">state</span><span class="op">$</span><span class="va">torch_model_classif</span><span class="op">$</span><span class="va">model</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="va">network</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="pipeop_torch_files/figure-html/unnamed-chunk-46-1.png" width="700"></p>
<p>Predictions, as before (we can use <code>predict_newdata</code>
again):</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predictions</span> <span class="op">=</span> <span class="va">lr_sequential_full</span><span class="op">$</span><span class="fu">predict_newdata</span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_predictions</span><span class="op">(</span><span class="va">predictions</span><span class="op">)</span></span></code></pre></div>
<p><img src="pipeop_torch_files/figure-html/unnamed-chunk-47-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="mixed-pipelines">Mixed Pipelines<a class="anchor" aria-label="anchor" href="#mixed-pipelines"></a>
</h3>
<p>We are not just limited to [<code>PipeOpTorch</code>] in these kinds
of <code>Graph</code>s, and we are also not limited to having only a
single [<code>PipeOpTorchIngress</code>]. The following pipeline, for
example, removes all but the <code>Petal.Length</code> columns from the
<code>Task</code> and fits a model:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"select"</span>, selector <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html" class="external-link">selector_name</a></span><span class="op">(</span><span class="st">"Petal.Length"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">5</span>, id <span class="op">=</span> <span class="st">"linear1"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_relu"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"linear2"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_softmax"</span>, dim <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_optimizer"</span>, optimizer <span class="op">=</span> <span class="va">adam</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_loss"</span>, loss <span class="op">=</span> <span class="va">xe</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_model_classif"</span>, batch_size <span class="op">=</span> <span class="fl">50</span>, epochs <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">gr</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="pipeop_torch_files/figure-html/unnamed-chunk-48-1.png" width="700"></p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html" class="external-link">as_learner</a></span><span class="op">(</span><span class="va">gr</span><span class="op">)</span></span>
<span><span class="va">lr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span><span class="va">predictions</span> <span class="op">=</span> <span class="va">lr</span><span class="op">$</span><span class="fu">predict_newdata</span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_predictions</span><span class="op">(</span><span class="va">predictions</span><span class="op">)</span></span></code></pre></div>
<p><img src="pipeop_torch_files/figure-html/unnamed-chunk-49-1.png" width="700"></p>
<p>How about using <code>Petal.Length</code> and
<code>Sepal.Length</code> separately at first?</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/gunion.html" class="external-link">gunion</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"select"</span>, selector <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html" class="external-link">selector_name</a></span><span class="op">(</span><span class="st">"Petal.Length"</span><span class="op">)</span>, id <span class="op">=</span> <span class="st">"sel1"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num"</span>, id <span class="op">=</span> <span class="st">"ingress.petal"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"linear1"</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"select"</span>, selector <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html" class="external-link">selector_name</a></span><span class="op">(</span><span class="st">"Sepal.Length"</span><span class="op">)</span>, id <span class="op">=</span> <span class="st">"sel2"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_ingress_num"</span>, id <span class="op">=</span> <span class="st">"ingress.sepal"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"linear2"</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_merge_cat"</span><span class="op">)</span>  <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_relu"</span>, id <span class="op">=</span> <span class="st">"act1"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_linear"</span>, out_features <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"linear3"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"nn_softmax"</span>, dim <span class="op">=</span> <span class="fl">2</span>, id <span class="op">=</span> <span class="st">"act3"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_optimizer"</span>, optimizer <span class="op">=</span> <span class="va">adam</span>, lr <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_loss"</span>, loss <span class="op">=</span> <span class="va">xe</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html" class="external-link">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="external-link">po</a></span><span class="op">(</span><span class="st">"torch_model_classif"</span>, batch_size <span class="op">=</span> <span class="fl">50</span>, epochs <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gr</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="pipeop_torch_files/figure-html/unnamed-chunk-50-1.png" width="700"></p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html" class="external-link">as_learner</a></span><span class="op">(</span><span class="va">gr</span><span class="op">)</span></span>
<span><span class="va">lr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span><span class="va">predictions</span> <span class="op">=</span> <span class="va">lr</span><span class="op">$</span><span class="fu">predict_newdata</span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_predictions</span><span class="op">(</span><span class="va">predictions</span><span class="op">)</span></span></code></pre></div>
<p><img src="pipeop_torch_files/figure-html/unnamed-chunk-51-1.png" width="700"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Sebastian Fischer, Martin Binder.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
