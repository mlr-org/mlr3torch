<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.533">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sebastian Fischer">
<meta name="dcterms.date" content="2022-07-15">

<title>TorchOps</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="torchops_files/libs/clipboard/clipboard.min.js"></script>
<script src="torchops_files/libs/quarto-html/quarto.js"></script>
<script src="torchops_files/libs/quarto-html/popper.min.js"></script>
<script src="torchops_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="torchops_files/libs/quarto-html/anchor.min.js"></script>
<link href="torchops_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="torchops_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="torchops_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="torchops_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="torchops_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script src="torchops_files/libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="torchops_files/libs/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="torchops_files/libs/vis-9.1.0/vis-network.min.js"></script>
<script src="torchops_files/libs/visNetwork-binding-2.1.0/visNetwork.js"></script>


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">TorchOps</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading"></div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 15, 2022</p>
    </div>
  </div>
    
  </div>
  

</header>

<p><strong>Prerequisits</strong> You should be familiar with the <a href="https://mlr3book.mlr-org.com/05-pipelines.html">mlr3pipelines</a> and <a href="https://github.com/mlverse/torch">torch</a> R package.</p>
<section id="intro" class="level1">
<h1>Intro</h1>
<p>In this article we will show how one can use the language implemented in mlr3pipelines to obtain fully parameterized neural networks. The driving idea is the observation that neural networks can be represented as directed acyclic graphs (DAG). mlr3pipelines provides a language to build graphs and use them for training and prediction, making it the foundation to build upon.</p>
</section>
<section id="the-central-building-block-torchop" class="level1">
<h1>The central building block: TorchOp</h1>
<p>A <code>TorchOp</code> is a child class of <code>PipeOp</code> and can be constructed using the shorthand constructor <code>top()</code>:</p>
<div class="cell" data-result="asis">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3torch)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>top_linear <span class="ot">=</span> <span class="fu">top</span>(<span class="st">"linear"</span>, <span class="at">out_features =</span> 10L)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By adding a <code>_{n}</code> to the end of the TorchOps id, one can conveniently retrieve the same TorchOp with an incremented id.</p>
<div class="cell" data-result="asis">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">top</span>(<span class="st">"linear_1"</span>, <span class="at">out_features =</span> 10L)<span class="sc">$</span>id</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "linear_1"</code></pre>
</div>
</div>
<p>The available TorchOps are stored in the dictionary <code>mlr_torchops</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>mlr_torchops</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;DictionaryTorchOp&gt; with 56 stored values
Keys: activation, add, avg_pool1d, avg_pool2d, avg_pool3d, batch_norm,
  cat, conv_transpose1d, conv_transpose2d, conv_transpose3d, conv1d,
  conv2d, conv3d, dropout, elu, flatten, glu, hardshrink, hardsigmoid,
  hardswish, hardtanh, input, layer_norm, leaky_relu, linear,
  log_sigmoid, loss, max_pool1d, max_pool2d, max_pool3d, merge,
  model.classif, model.regr, mul, optimizer, output, prelu, relu,
  relu6, repeat, reshape, rrelu, select, selu, sigmoid, softmax,
  softplus, softshrink, softsign, squeeze, tab_resnet_blocks,
  tab_tokenizer, tanh, tanhshrink, threshold, unsqueeze</code></pre>
</div>
</div>
<p>Because a TorchOp is a PipeOp, it can be added to Graphs and connected with other PipeOps, as long as the connected input and output channels are matching. Except for <code>TorchOpInput</code> however, it is only possible to connect TorchOps with other TorchOps, because they require as training input an object of class <code>ModelConfig</code> that will be explained later.</p>
<p>In order to incrementally increase the complexity in our explanation, we will first simplify the explanandum by assuming that each TorchOp has exactly one input channel and one output channel. This allows us to consider only linear graphs and thereby only sequential models as defined by <code>torch::nn_sequential()</code>.</p>
</section>
<section id="linear-networks" class="level1 page-columns page-full">
<h1>Linear Networks</h1>
<p>We will proceed by showing</p>
<ol type="1">
<li>what happens when training a Graph consisting of TorchOps and then</li>
<li>how it happened.</li>
</ol>
<p>For that we will train a simple feed forward network on the german credit classification task.</p>
<div class="cell" data-result="asis">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"german_credit"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">=</span> <span class="fu">partition</span>(task)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span><span class="fu">set_row_roles</span>(ids<span class="sc">$</span>test, <span class="st">"holdout"</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>graph_lin <span class="ot">=</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initializes the DL Model</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"input"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># architecture</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"tab_tokenizer"</span>, <span class="at">d_token =</span> 1L) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"flatten"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"linear"</span>, <span class="at">out_features =</span> 10L) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"relu"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"output"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Optimizer and Loss config</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"optimizer"</span>, <span class="st">"sgd"</span>, <span class="at">lr =</span> <span class="fl">0.1</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"loss"</span>, <span class="st">"cross_entropy"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Train the network</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"model.classif"</span>,</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">batch_size =</span> <span class="dv">16</span>,</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">device =</span> <span class="st">"cpu"</span>,</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">epochs =</span> <span class="dv">1</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>graph_lin<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="htmlwidget-28127066e625d6d019af" style="width:50%;height:400px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-28127066e625d6d019af">{"x":{"nodes":{"id":["input","tab_tokenizer","flatten","linear","relu","output","optimizer","loss","<INPUT>","model","<OUTPUT>"],"label":["input","tab_tokenizer","flatten","linear","relu","output","optimizer","loss","<INPUT>","model","<OUTPUT>"],"shape":["box","box","box","box","box","box","box","box","database","box","ellipse"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","rgba(0,204,102,0.2)","lightblue","rgba(255,51,51,0.2)"],"value":[1,1,1,1,1,1,1,1,0.8,1,0.8],"title":["<p>TorchOp: <b>input<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelConfig,Task]<\/p>","<p>TorchOp: <b>tab_tokenizer<\/b> (not trained)<br>values: <b>bias=TRUE, cls=FALSE, d_token=1<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelConfig,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelConfig,Task]<\/p>","<p>TorchOp: <b>flatten<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelConfig,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelConfig,Task]<\/p>","<p>TorchOp: <b>linear<\/b> (not trained)<br>values: <b>out_features=10<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelConfig,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelConfig,Task]<\/p>","<p>TorchOp: <b>relu<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelConfig,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelConfig,Task]<\/p>","<p>TorchOp: <b>output<\/b> (not trained)<br>values: <b>bias=TRUE<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelConfig,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelConfig,Task]<\/p>","<p>TorchOp: <b>optimizer<\/b> (not trained)<br>values: <b>lr=0.1<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelConfig,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelConfig,Task]<\/p>","<p>TorchOp: <b>loss<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelConfig,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelConfig,Task]<\/p>","<p>Input:<br>Name: input.input<br>Train: Task<br>Predict: Task<\/p>","<p>TorchOp: <b>model<\/b> (not trained)<br>values: <b>batch_size=16, epochs=1, device=cpu, drop_last=FALSE, num_threads=1, shuffle=TRUE<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelConfig,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [NULL,Prediction]<\/p>","<p>Output:<br>Name: model.output<br>Train: NULL<br>Predict: Prediction<\/p>"],"x":[0,0,0,0,0,0,0,0,0,0,0],"y":[-0.8,-0.6,-0.4,-0.2,0,0.2,0.4,0.6,-1,0.8,1]},"edges":{"from":["input","tab_tokenizer","flatten","linear","relu","output","optimizer","loss","<INPUT>","model"],"to":["tab_tokenizer","flatten","linear","relu","output","optimizer","loss","model","input","<OUTPUT>"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"arrows":"to","smooth":{"enabled":false,"forceDirection":"vertical"}},"physics":{"stabilization":false}},"groups":null,"width":"50%","height":"400px","idselection":{"enabled":false},"byselection":{"enabled":false},"main":null,"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","igraphlayout":{"type":"full"}},"evals":[],"jsHooks":[]}</script>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>graph_lin<span class="sc">$</span><span class="fu">train</span>(task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$model.output
NULL</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>graph_lin<span class="sc">$</span><span class="fu">predict</span>(task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$model.output
&lt;PredictionClassif&gt; for 670 observations:
    row_ids truth response
          1  good     good
          2   bad     good
          3  good     good
---                       
        995  good     good
        998  good     good
       1000  good     good</code></pre>
</div>
</div>
<p>We will now walk through those steps.</p>
<section id="training-the-graph" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="training-the-graph">Training the Graph</h2>
<section id="initialize-the-modelconfig" class="level3">
<h3 class="anchored" data-anchor-id="initialize-the-modelconfig">Initialize the ModelConfig</h3>
<p>The <code>top("input")</code> marks the start of the network. This is important because TorchOps are simply PipeOps and can therefore be combined with other preprocessing steps defined in mlr3pipelines, as we will see later. For the time being we can think of training a <code>TorchOpInput</code> as taking a task and outputting a list containing an empty sequential network, an example batch, and the task itself.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> mlr3torch<span class="sc">:::</span><span class="fu">get_batch</span>(task, 1L, <span class="st">"cpu"</span>)<span class="sc">$</span>x</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ num:Float [1:1, 1:3]
 $ cat:Long [1:1, 1:17]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>model_config <span class="ot">=</span> <span class="fu">list</span>(<span class="at">network =</span> <span class="fu">nn_sequential</span>(), <span class="at">output =</span> x, <span class="at">task =</span> task)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(model_config) <span class="ot">=</span> <span class="st">"ModelConfig"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Subsequent TorchOps will add modules to the <code>nn_sequential</code> as we will see now. The example batch is included so that subsequent layers can automatically infer auxiliary parameters like the input dimension of a linear network.</p>
</section>
<section id="adding-layers" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="adding-layers">Adding Layers</h3>
<div class="page-columns page-full"><p>Neural networks can only deal with floating point values and therefore factor variables and logicals have to be encoded.The first layer we will add is therefore a tabular tokenizer <code>TorchOpTabTokenizer</code>. During training it get’s a ModelConfig similar to the one defined above. It then calls its <code>$build()</code> method which - for the given task and input - returns an <code>nn_module</code> and the layer’s output, which is a 3d tensor with dimension (batch, features, token). <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p><div class="no-row-height column-margin column-container"><li id="fn1" role="doc-endnote"><p><sup>1</sup>&nbsp;When passing the previous layers output we have to wrap the previous output in <code>list(input = ...)</code> because there could be multiple input channels, which we are currently ignoring. In this case there is only one, called <code>"input"</code> which explains the name. Also the returned output is a named list, where the names correspond to the output channels, in this case <code>"output"</code>.</p></li></div></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> <span class="fu">top</span>(<span class="st">"tab_tokenizer"</span>, <span class="at">d_token =</span> 2L)<span class="sc">$</span><span class="fu">build</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">input =</span> model_config<span class="sc">$</span>output),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  task</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "layer"  "output"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>layer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An `nn_module` containing 184 parameters.

── Modules ─────────────────────────────────────────────────────────────────────
• tokenizer_num: &lt;nn_tokenizer_numeric&gt; #12 parameters
• tokenizer_cat: &lt;nn_tokenizer_categorical&gt; #172 parameters</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(res<span class="sc">$</span>output) <span class="co"># this is the output of this layer for the example batch</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 1
 $ output:Float [1:1, 1:20, 1:2]</code></pre>
</div>
</div>
<p>The <code>nn_module</code> is then added to the network stored in the ModelConfig and the previous layer’s output is replaced with the output of the current layer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>network<span class="sc">$</span><span class="fu">add_module</span>(<span class="st">"tab_tokenizer"</span>, res<span class="sc">$</span>layer)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>output <span class="ot">=</span> res<span class="sc">$</span>output</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>network</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An `nn_module` containing 184 parameters.

── Modules ─────────────────────────────────────────────────────────────────────
• tab_tokenizer: &lt;nn_tab_tokenizer&gt; #184 parameters</code></pre>
</div>
</div>
<section id="flatten-the-data" class="level4">
<h4 class="anchored" data-anchor-id="flatten-the-data">Flatten the data</h4>
<p>The tabular tokenizer outputs a three-dimensional tensor with dimensions (batch, features, token). Because we want to create a simple feed forward network we will flatten the tensor to two dimensions using <code>TorchOpFlatten</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> <span class="fu">top</span>(<span class="st">"flatten"</span>)<span class="sc">$</span><span class="fu">build</span>(<span class="fu">list</span>(<span class="at">input =</span> model_config<span class="sc">$</span>output<span class="sc">$</span>output), task)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>output<span class="sc">$</span>output<span class="sc">$</span>shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  1 40</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>network<span class="sc">$</span><span class="fu">add_module</span>(<span class="st">"flatten"</span>, res<span class="sc">$</span>layer)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>output <span class="ot">=</span> res<span class="sc">$</span>output</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>network</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An `nn_module` containing 184 parameters.

── Modules ─────────────────────────────────────────────────────────────────────
• tab_tokenizer: &lt;nn_tab_tokenizer&gt; #184 parameters
• flatten: &lt;nn_flatten&gt; #0 parameters</code></pre>
</div>
</div>
</section>
<section id="linear-layer" class="level4">
<h4 class="anchored" data-anchor-id="linear-layer">Linear Layer</h4>
<p>Now we have the data in a form that is ready to be fed into a standard feed forward network implemented as <code>TorchOpLinear</code>. We will add a linear layer with 10 output units.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> <span class="fu">top</span>(<span class="st">"linear"</span>, <span class="at">out_features =</span> <span class="dv">10</span>)<span class="sc">$</span><span class="fu">build</span>(<span class="fu">list</span>(<span class="at">input =</span> model_config<span class="sc">$</span>output<span class="sc">$</span>output), task)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>network<span class="sc">$</span><span class="fu">add_module</span>(<span class="st">"linear"</span>, res<span class="sc">$</span>layer)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>output <span class="ot">=</span> res<span class="sc">$</span>output</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>network</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An `nn_module` containing 594 parameters.

── Modules ─────────────────────────────────────────────────────────────────────
• tab_tokenizer: &lt;nn_tab_tokenizer&gt; #184 parameters
• flatten: &lt;nn_flatten&gt; #0 parameters
• linear: &lt;nn_linear&gt; #410 parameters</code></pre>
</div>
</div>
</section>
<section id="activation-function" class="level4">
<h4 class="anchored" data-anchor-id="activation-function">Activation Function</h4>
<p>The next step is the ReLU activation function <code>TorchOpReLU</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>output <span class="ot">=</span> <span class="fu">top</span>(<span class="st">"relu"</span>)<span class="sc">$</span><span class="fu">build</span>(<span class="fu">list</span>(<span class="at">input =</span> model_config<span class="sc">$</span>output<span class="sc">$</span>output), task)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>network<span class="sc">$</span><span class="fu">add_module</span>(<span class="st">"relu"</span>, output<span class="sc">$</span>layer)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>output <span class="ot">=</span> output<span class="sc">$</span>output</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>network</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An `nn_module` containing 594 parameters.

── Modules ─────────────────────────────────────────────────────────────────────
• tab_tokenizer: &lt;nn_tab_tokenizer&gt; #184 parameters
• flatten: &lt;nn_flatten&gt; #0 parameters
• linear: &lt;nn_linear&gt; #410 parameters
• relu: &lt;nn_relu&gt; #0 parameters</code></pre>
</div>
</div>
</section>
<section id="output-layer" class="level4">
<h4 class="anchored" data-anchor-id="output-layer">Output Layer</h4>
<p>The last layer is the classification output layer <code>TorchOpOutput</code>. This is a linear layer for which the number of classes is inferred from the task.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>output <span class="ot">=</span> <span class="fu">top</span>(<span class="st">"output"</span>)<span class="sc">$</span><span class="fu">build</span>(<span class="fu">list</span>(<span class="at">input =</span> model_config<span class="sc">$</span>output<span class="sc">$</span>output), task)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>network<span class="sc">$</span><span class="fu">add_module</span>(<span class="st">"output"</span>, output<span class="sc">$</span>layer)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>output <span class="ot">=</span> output<span class="sc">$</span>output</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>network</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An `nn_module` containing 616 parameters.

── Modules ─────────────────────────────────────────────────────────────────────
• tab_tokenizer: &lt;nn_tab_tokenizer&gt; #184 parameters
• flatten: &lt;nn_flatten&gt; #0 parameters
• linear: &lt;nn_linear&gt; #410 parameters
• relu: &lt;nn_relu&gt; #0 parameters
• output: &lt;nn_linear&gt; #22 parameters</code></pre>
</div>
</div>
<p>We could now apply the obtained network to the original input <code>x</code> and get the same value as stored in <code>model_config$output</code>.</p>
<div class="cell" data-result="asis">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(torch)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">torch_equal</span>(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  model_config<span class="sc">$</span><span class="fu">network</span>(x),</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  model_config<span class="sc">$</span>output<span class="sc">$</span>output</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="training-the-network" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="training-the-network">Training the network</h2>
<p>We have now defined the network architecture and will continue with configuring the optimizer via <code>TorchOpOptimizer</code> and the loss function implemented as <code>TorchOpLoss</code>. What they essentially do during training is the following.</p>
<div class="cell" data-result="asis">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>optimizer <span class="ot">=</span> <span class="st">"adam"</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>optimizer_args <span class="ot">=</span> <span class="fu">list</span>(<span class="at">lr =</span> <span class="fl">0.1</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>loss <span class="ot">=</span> <span class="st">"cross_entropy"</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>model_config<span class="sc">$</span>loss_args <span class="ot">=</span> <span class="fu">list</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="page-columns page-full"><p>The TorchOp that takes a model config as defined above and executes it, is <code>TorchOpModel</code>. It has two child classes <code>TorchOpModelClassif</code> and <code>TorchOpModelRegr</code>. It furthermore lets us specify the remaining training arguments that are available to torch learners in mlr3torch. <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p><div class="no-row-height column-margin column-container"><li id="fn2" role="doc-endnote"><p><sup>2</sup>&nbsp;Note that due to some details and simplifications in the explanation, we cannot actually pass the manually defined <code>model_config</code> to the TorchOp above, but conceptually this is what happens.</p></li></div></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>to_model <span class="ot">=</span> <span class="fu">top</span>(<span class="st">"model.classif"</span>,</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> <span class="dv">16</span>,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">device =</span> <span class="st">"cpu"</span>,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">1</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>TorchOpModel</code> then does the following:</p>
<ol type="1">
<li>Initialize the optimizer with the network parameters.</li>
<li>Initialize the loss function.</li>
<li>Create a learner similar to <code>Learner{Classif, Regr}Torch</code> and set it’s parameters.</li>
<li>Train the learner.</li>
</ol>
<p>It’s output is <code>NULL</code>, but the trained learner is stored in it’s state.</p>
</section>
<section id="prediction-phase" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="prediction-phase">Prediction Phase</h2>
<div class="page-columns page-full"><p>During the prediction phase, all TorchOps except for <code>TorchOpModel</code> simply forward the input task as is. <a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> Their goal is essentially to get the task to <code>TorchOpModel</code>, which will make the predictions using the trained network and output them.</p><div class="no-row-height column-margin column-container"><li id="fn3" role="doc-endnote"><p><sup>3</sup>&nbsp;Recall that the types of channels can differ between the <code>"train"</code> and the <code>"predict"</code> phase.</p></li></div></div>
<div class="cell" data-result="asis">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>output <span class="ot">=</span> graph_lin<span class="sc">$</span>pipeops<span class="sc">$</span>tab_tokenizer<span class="sc">$</span><span class="fu">predict</span>(<span class="fu">list</span>(<span class="at">input =</span> task))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>output<span class="sc">$</span>output</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskClassif:german_credit&gt; (670 x 21): German Credit
* Target: credit_risk
* Properties: twoclass
* Features (20):
  - fct (14): credit_history, employment_duration, foreign_worker,
    housing, job, other_debtors, other_installment_plans,
    people_liable, personal_status_sex, property, purpose, savings,
    status, telephone
  - int (3): age, amount, duration
  - ord (3): installment_rate, number_credits, present_residence</code></pre>
</div>
</div>
</section>
</section>
<section id="nonlinear-networks" class="level1 page-columns page-full">
<h1>Nonlinear networks</h1>
<div class="page-columns page-full"><p>In this section we will relax the linearity assumption which will allow us to build nonlinear networks.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> This means that we now allow for multiple input and output channels, although we will only include the former in this example. We will start again by first showing an example and then walking through it step by step. Note that we only cover the “dif” between the nonlinear and linear case and will not repeat the workings that were already fully explainable in the simplified case covered in the previous section.</p><div class="no-row-height column-margin column-container"><li id="fn4" role="doc-endnote"><p><sup>4</sup>&nbsp;Nonlinear with respect to its graph structure and not nonlinear functions.</p></li></div></div>
<p>We will start by creating a network that is identical to the previous one, except for adding a skip-connection.</p>
<div class="cell" data-result="asis">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>graph_nonlin <span class="ot">=</span> <span class="fu">top</span>(<span class="st">"input"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"tab_tokenizer"</span>, <span class="at">d_token =</span> <span class="dv">2</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"flatten"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gunion</span>(<span class="fu">list</span>(</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">a =</span> <span class="fu">top</span>(<span class="st">"linear"</span>, <span class="at">out_features =</span> 10L) <span class="sc">%&gt;&gt;%</span> <span class="fu">top</span>(<span class="st">"relu"</span>),</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">b =</span> <span class="fu">top</span>(<span class="st">"linear"</span>, <span class="at">out_features =</span> 10L)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>   )) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"add"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"output"</span>)</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>graph_nonlin<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="htmlwidget-01e08ca03e652f20b82e" style="width:50%;height:400px;" class="visNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-01e08ca03e652f20b82e">{"x":{"nodes":{"id":["input","tab_tokenizer","a.linear","flatten","a.relu","b.linear","add","<INPUT>","output","<OUTPUT>"],"label":["input","tab_tokenizer","a.linear","flatten","a.relu","b.linear","add","<INPUT>","output","<OUTPUT>"],"shape":["box","box","box","box","box","box","box","database","box","ellipse"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","rgba(0,204,102,0.2)","lightblue","rgba(255,51,51,0.2)"],"value":[1,1,1,1,1,1,1,0.8,1,0.8],"title":["<p>TorchOp: <b>input<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [Task,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelConfig,Task]<\/p>","<p>TorchOp: <b>tab_tokenizer<\/b> (not trained)<br>values: <b>bias=TRUE, cls=FALSE, d_token=2<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelConfig,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelConfig,Task]<\/p>","<p>TorchOp: <b>a.linear<\/b> (not trained)<br>values: <b>out_features=10<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelConfig,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelConfig,Task]<\/p>","<p>TorchOp: <b>flatten<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelConfig,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelConfig,Task]<\/p>","<p>TorchOp: <b>a.relu<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelConfig,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelConfig,Task]<\/p>","<p>TorchOp: <b>b.linear<\/b> (not trained)<br>values: <b>out_features=10<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelConfig,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelConfig,Task]<\/p>","<p>TorchOp: <b>add<\/b> (not trained)<br>values: <b>list()<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  ... [ModelConfig,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelConfig,Task]<\/p>","<p>Input:<br>Name: input.input<br>Train: Task<br>Predict: Task<\/p>","<p>TorchOp: <b>output<\/b> (not trained)<br>values: <b>bias=TRUE<\/b><br>Input channels <b>name [train type, predict type]<\/b>:<br>  input [ModelConfig,Task]<br>Output channels <b>name [train type, predict type]<\/b>:<br>  output [ModelConfig,Task]<\/p>","<p>Output:<br>Name: output.output<br>Train: ModelConfig<br>Predict: Task<\/p>"],"x":[0,0,-1,0,-1,1,0,0,0,0],"y":[-0.75,-0.5,0,-0.25,0.25,0,0.5,-1,0.75,1]},"edges":{"from":["input","tab_tokenizer","a.linear","flatten","flatten","a.relu","b.linear","add","<INPUT>","output"],"to":["tab_tokenizer","flatten","a.relu","a.linear","b.linear","add","add","output","input","<OUTPUT>"],"color":["lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue","lightblue"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"arrows":"to","smooth":{"enabled":false,"forceDirection":"vertical"}},"physics":{"stabilization":false}},"groups":null,"width":"50%","height":"400px","idselection":{"enabled":false},"byselection":{"enabled":false},"main":null,"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","igraphlayout":{"type":"full"}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>The nonlinearity is introduced by <code>flatten</code>, which is connected to both <code>a.linear</code> and <code>b.linear</code>. Note that it does not have two different output channels but its one output channel is connected to multiple input channels. The subsequent branches are a non-linear path and a linear path (the skip-connection) and are merged using <code>add</code>.</p>
<p>The underlying idea that makes these networks possible is to replace the <code>nn_sequential</code> with a more flexible network <code>nn_graph</code>.</p>
<p>A <code>nn_graph</code> contains modules (that are added by the TorchOps) and edges that determine the data-flow between the modules during the forward path. The graph-structure in the <code>nn_graph</code> is essentially identical to the graph structure of <code>TorchOp</code>s minus <code>TorchOp{Input, Optimizer, Loss, Model}</code> (which do not modify the network).</p>
<p>We will now look at the constructed network and then dive into the details of how it came about.</p>
<div class="cell" data-result="asis">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> graph_nonlin<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>network <span class="ot">=</span> res[[1L]]<span class="sc">$</span>network</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>network<span class="sc">$</span><span class="fu">set_terminal</span>()</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>network<span class="sc">$</span>edges</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          src_id        dst_id src_channel dst_channel
          &lt;char&gt;        &lt;char&gt;      &lt;char&gt;      &lt;char&gt;
1:   __initial__ tab_tokenizer      output       input
2: tab_tokenizer       flatten      output       input
3:       flatten      a.linear      output       input
4:       flatten      b.linear      output       input
5:      a.linear        a.relu      output       input
6:        a.relu           add      output         ...
7:      b.linear           add      output         ...
8:           add        output      output       input
9:        output  __terminal__      output       input</code></pre>
</div>
</div>
<p>A couple of questions have to be answered:</p>
<ol type="1">
<li>How are the channels edges in the <code>nn_graph</code> connected to the <code>TorchOp</code> channels.</li>
<li>How was it possible to construct this graph.</li>
</ol>
<p>To answer the first question we will consider the <code>TorchOpAdd</code></p>
<div class="cell" data-result="asis">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>top_add <span class="ot">=</span> <span class="fu">top</span>(<span class="st">"add"</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> top_add<span class="sc">$</span><span class="fu">build</span>(</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">input1 =</span> <span class="fu">torch_randn</span>(<span class="dv">16</span>, <span class="dv">3</span>), <span class="at">input2 =</span> <span class="fu">torch_randn</span>(<span class="dv">16</span>, <span class="dv">3</span>)),</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  task</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>res[[<span class="dv">1</span>]]<span class="sc">$</span>layer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NULL</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">formalArgs</span>(res<span class="sc">$</span>layer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "..."</code></pre>
</div>
</div>
<p>Because the input channel of <code>TorchOpAdd</code> is a vararg channel, it takes as an argument <code>...</code>.</p>
<p>In general it should hold that:</p>
<ul>
<li>The input channels of a <code>TorchOp</code> translate to the arguments of its constructed <code>nn_module</code></li>
<li>In case a <code>TorchOp</code> has multiple output channels, its constructed <code>nn_module</code> should return a list with the names corresponding to those channels. In the special case of one output channel it is ok that the <code>nn_module</code> returns a tensor because <code>nn_graph</code> is smart enough to figure it out.</li>
</ul>
<p>To answer the second question: The “problem” that has to be overcome is that the <code>PipeOp</code>s are not aware of the <code>Graph</code> they are in (by design). Otherwise we could simply copy and adjust the edges stored in <code>graph_nonlin$edges</code></p>
<p>This means, that the graph-structure has to be recreated during the train-phase of the graph. This is implemented via a with a message-passing system, in which a <code>TorchOp</code> always receives information about the <code>TorchOp</code> and channel that “sent” the <code>ModelConfig</code>.</p>
<div class="cell" data-result="asis">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> (<span class="fu">top</span>(<span class="st">"input"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">top</span>(<span class="st">"tab_tokenizer"</span>, <span class="at">d_token =</span> <span class="dv">2</span>))<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>res[[<span class="dv">1</span>]]<span class="sc">$</span>channel</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "output"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>res[[<span class="dv">1</span>]]<span class="sc">$</span>id</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "tab_tokenizer"</code></pre>
</div>
</div>
<p>The next TorchOp can add the corresponding edges to the <code>nn_graph</code> for each of its input channels and replace the <code>channel</code> and <code>id</code> with its own channel and id. In case it has multiple output channels, the channels of the output <code>ModelConfig</code> must correspond to the respective output channel.</p>
<div class="cell" data-result="asis">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> <span class="fu">top</span>(<span class="st">"flatten"</span>)<span class="sc">$</span><span class="fu">train</span>(res)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>res[[<span class="dv">1</span>]]<span class="sc">$</span>network<span class="sc">$</span>edges</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          src_id        dst_id src_channel dst_channel
          &lt;char&gt;        &lt;char&gt;      &lt;char&gt;      &lt;char&gt;
1:   __initial__ tab_tokenizer      output       input
2: tab_tokenizer       flatten      output       input</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>res[[<span class="dv">1</span>]]<span class="sc">$</span>channel</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "output"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>res[[<span class="dv">1</span>]]<span class="sc">$</span>id</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "flatten"</code></pre>
</div>
</div>
<p>This means that both <code>a.linear</code> and <code>b.linear</code> get the result from above.</p>
<div class="cell" data-result="asis">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>path_a <span class="ot">=</span> <span class="fu">top</span>(<span class="st">"linear"</span>, <span class="at">out_features =</span> <span class="dv">10</span>, <span class="at">id =</span> <span class="st">"a.linear"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">top</span>(<span class="st">"relu"</span>, <span class="at">id =</span> <span class="st">"a.relu"</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>res_a <span class="ot">=</span> path_a<span class="sc">$</span><span class="fu">train</span>(res[[<span class="dv">1</span>]])</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>res_a[[1L]]<span class="sc">$</span>network<span class="sc">$</span>edges</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          src_id        dst_id src_channel dst_channel
          &lt;char&gt;        &lt;char&gt;      &lt;char&gt;      &lt;char&gt;
1:   __initial__ tab_tokenizer      output       input
2: tab_tokenizer       flatten      output       input
3:       flatten      a.linear      output       input
4:      a.linear        a.relu      output       input</code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>res_a[[1L]]<span class="sc">$</span>channel</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "output"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>res_a[[1L]]<span class="sc">$</span>id</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "a.relu"</code></pre>
</div>
</div>
<p>Both <code>linear.a</code> and <code>linear.b</code> modify the network <strong>in place</strong>. This means the <code>$network</code> saved in the model-config that is the input to the skip-connection, will be up-to date. The <code>ModelConfig</code> however is simply a list with a class, for which the typical copy-on-modify semantics hold, therefore after the path <code>linear.a</code> is executed, the <code>linear.b</code> will still have the correct input id and channel from <code>flatten</code>.</p>
<div class="cell" data-result="asis">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>res_b <span class="ot">=</span> <span class="fu">top</span>(<span class="st">"linear"</span>, <span class="at">out_features =</span> <span class="dv">10</span>, <span class="at">id =</span> <span class="st">"b.linear"</span>)<span class="sc">$</span><span class="fu">train</span>(<span class="fu">list</span>(<span class="at">input =</span> res[[1L]]))</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>res_b[[1L]]<span class="sc">$</span>network<span class="sc">$</span>edges</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          src_id        dst_id src_channel dst_channel
          &lt;char&gt;        &lt;char&gt;      &lt;char&gt;      &lt;char&gt;
1:   __initial__ tab_tokenizer      output       input
2: tab_tokenizer       flatten      output       input
3:       flatten      a.linear      output       input
4:      a.linear        a.relu      output       input
5:       flatten      b.linear      output       input</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>res_b[[1L]]<span class="sc">$</span>channel</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "output"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>res_b[[1L]]<span class="sc">$</span>id</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "b.linear"</code></pre>
</div>
</div>
<p>In the next step, these results are passed to <code>TorchOpAdd</code>. In each of its input channels it obtains a <code>ModelConfig</code> with a different <code>id</code> and <code>channel</code> and it can connect those with the input channel at which it arrived</p>
<div class="cell" data-result="asis">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">=</span> <span class="fu">top</span>(<span class="st">"add"</span>)<span class="sc">$</span><span class="fu">train</span>(<span class="fu">list</span>(<span class="at">input1 =</span> res_a[[<span class="dv">1</span>]], <span class="at">input2 =</span> res_b[[<span class="dv">1</span>]]))</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>res[[<span class="dv">1</span>]]<span class="sc">$</span>network<span class="sc">$</span>edges</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          src_id        dst_id src_channel dst_channel
          &lt;char&gt;        &lt;char&gt;      &lt;char&gt;      &lt;char&gt;
1:   __initial__ tab_tokenizer      output       input
2: tab_tokenizer       flatten      output       input
3:       flatten      a.linear      output       input
4:      a.linear        a.relu      output       input
5:       flatten      b.linear      output       input
6:        a.relu           add      output         ...
7:      b.linear           add      output         ...</code></pre>
</div>
</div>
</section>
<section id="including-preprocessing" class="level1">
<h1>Including preprocessing</h1>
<p>In this part we will show that TorchOps can be combine with other PipeOps.</p>
<div class="cell" data-result="asis">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3pipelines)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>graph_full <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"scale"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"pca"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"input"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"tab_tokenizer"</span>, <span class="at">d_token =</span> 1L) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"flatten"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"linear"</span>, <span class="at">out_features =</span> 10L) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"relu"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"output"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"optimizer"</span>, <span class="st">"sgd"</span>, <span class="at">lr =</span> <span class="fl">0.1</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"loss"</span>, <span class="st">"cross_entropy"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top</span>(<span class="st">"model.classif"</span>,</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">epochs =</span> <span class="dv">1</span>,</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">batch_size =</span> <span class="dv">16</span>,</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">device =</span> <span class="st">"cpu"</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">as_learner_torch</span>(graph_full)</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">=</span> <span class="fu">partition</span>(task)</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(task, ids<span class="sc">$</span>train)</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">predict</span>(task, ids<span class="sc">$</span>test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;PredictionClassif&gt; for 221 observations:
    row_ids truth response
          6  good     good
         18  good     good
         20  good     good
---                       
        932   bad     good
        967   bad     good
        982   bad     good</code></pre>
</div>
</div>
</section>
<section id="tuning-a-network" class="level1">
<h1>Tuning a network</h1>
<div class="cell" data-result="asis">

</div>
</section>
<section id="why-bother" class="level1">
<h1>Why bother?</h1>
<p>The creation of neural networks using TorchOps has various advantages:</p>
<ul>
<li>Seemingless integration into the {mlr3} ecosystem.</li>
<li>One can easily obtain custom, fully parameterized neural networks.</li>
<li>One does not need to learn a new syntax when alreading being familiar with {mlr3pipelines}.</li>
<li>Auxiliary parameters such as the input dimension of a linear layer or the outputs of the output layer are automatically inferred, this is similar to Lazy Modules in PyTorch</li>
</ul>
</section>


</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>